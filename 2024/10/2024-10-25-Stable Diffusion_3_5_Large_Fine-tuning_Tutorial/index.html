<!DOCTYPE html><html lang="ko"><head><meta charset="UTF-8"><meta http-equiv="X-UA-Compatible" content="IE=edge"><meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1"><meta name="description" content="Stable Diffusion 3.5 Large Fine-tuning Tutorial"><meta name="keywords" content="stable diffusion,LORA,Lora,í›ˆë ¨,í•™ìŠµ,SD 3.5,Large,Fine-tuning,Tutorial"><meta name="author" content="sejoung kim"><meta name="copyright" content="sejoung kim"><title>Stable Diffusion 3.5 Large Fine-tuning Tutorial | í­ê°„ì˜ ê¸°ìˆ ë¸”ë¡œê·¸</title><link rel="shortcut icon" href="../../../my-favicon.ico"><link rel="stylesheet" href="../../../css/index.css?version=1.7.0"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/font-awesome@4.7.0/css/font-awesome.min.css?version=1.7.0"><meta name="format-detection" content="telephone=no"><meta http-equiv="x-dns-prefetch-control" content="on"><link rel="dns-prefetch" href="https://cdn.jsdelivr.net"><script async crossorigin="anonymous" src="https://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js?client=ca-pub-4136060060870959"></script><script async src="https://www.googletagmanager.com/gtag/js?id=G-NVRTGLD8RZ"></script><script>window.dataLayer = window.dataLayer || [];
function gtag(){dataLayer.push(arguments);}
gtag('js', new Date());
gtag('config', 'G-NVRTGLD8RZ');</script><script>var GLOBAL_CONFIG = { 
  root: '/',
  algolia: undefined,
  localSearch: {"path":"search.xml","languages":{"hits_empty":"We didn't find any results for the search: ${query}"}},
  copy: {
    success: 'Copy successfully',
    error: 'Copy error',
    noSupport: 'The browser does not support'
  }
} </script><meta name="generator" content="Hexo 5.4.2"></head><body><i class="fa fa-arrow-right" id="toggle-sidebar" aria-hidden="true"></i><div id="sidebar" data-display="true"><div class="toggle-sidebar-info text-center"><span data-toggle="Toggle article">Toggle site</span><hr></div><div class="sidebar-toc"><div class="sidebar-toc__title">Catalog</div><div class="sidebar-toc__progress"><span class="progress-notice">You've read</span><span class="progress-num">0</span><span class="progress-percentage">%</span><div class="sidebar-toc__progress-bar"></div></div><div class="sidebar-toc__content"><ol class="toc"><li class="toc-item toc-level-1"><a class="toc-link" href="#Stable-Diffusion-3-5-Large-Fine-tuning-Tutorial"><span class="toc-number">1.</span> <span class="toc-text">Stable Diffusion 3.5 Large Fine-tuning Tutorial</span></a></li><li class="toc-item toc-level-1"><a class="toc-link" href="#%EB%8C%80%EC%83%81-%EB%AF%B8%EC%84%B8-%EC%A1%B0%EC%A0%95%EC%97%90-%EB%8C%80%ED%95%9C-%EC%B5%9C%EC%86%8C%ED%95%9C%EC%9D%98-%EA%B8%B0%EB%B3%B8-%EC%A7%80%EC%8B%9D%EC%9D%84-%EA%B0%96%EC%B6%98-%EC%97%94%EC%A7%80%EB%8B%88%EC%96%B4-%EB%98%90%EB%8A%94-%EA%B8%B0%EC%88%A0-%EC%9D%B8%EB%A0%A5"><span class="toc-number">2.</span> <span class="toc-text">ëŒ€ìƒ : ë¯¸ì„¸ ì¡°ì •ì— ëŒ€í•œ ìµœì†Œí•œì˜ ê¸°ë³¸ ì§€ì‹ì„ ê°–ì¶˜ ì—”ì§€ë‹ˆì–´ ë˜ëŠ” ê¸°ìˆ  ì¸ë ¥</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#Tools"><span class="toc-number">2.1.</span> <span class="toc-text">Tools</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Environment-Setup"><span class="toc-number">2.2.</span> <span class="toc-text">Environment Setup</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#Python-Dependencies"><span class="toc-number">2.2.1.</span> <span class="toc-text">Python Dependencies</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%EC%9D%B4%EC%A0%9C-%ED%95%84%EC%9A%94%ED%95%9C-SimpleTuner-%EC%A2%85%EC%86%8D%EC%84%B1%EC%9D%B4-%EB%AA%A8%EB%91%90-%EC%84%A4%EC%B9%98%EB%90%98%EC%96%B4-%EC%9E%88%EC%96%B4%EC%95%BC-%ED%95%A9%EB%8B%88%EB%8B%A4"><span class="toc-number">2.3.</span> <span class="toc-text">ì´ì œ í•„ìš”í•œ SimpleTuner ì¢…ì†ì„±ì´ ëª¨ë‘ ì„¤ì¹˜ë˜ì–´ ìˆì–´ì•¼ í•©ë‹ˆë‹¤.</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#Model-Dependencies"><span class="toc-number">2.3.1.</span> <span class="toc-text">Model Dependencies</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#Configuration-setup-high-level"><span class="toc-number">2.3.2.</span> <span class="toc-text">Configuration setup (high-level)</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#Configuration-setup-low-level"><span class="toc-number">2.3.3.</span> <span class="toc-text">Configuration setup (low-level)</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#Dataloader"><span class="toc-number">2.3.4.</span> <span class="toc-text">Dataloader</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#Data-preparation"><span class="toc-number">2.3.5.</span> <span class="toc-text">Data preparation</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Returning-to-the-custom-config"><span class="toc-number">2.4.</span> <span class="toc-text">Returning to the custom config</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#Learning-rate-x2F-steps"><span class="toc-number">2.4.1.</span> <span class="toc-text">Learning rate&#x2F;steps</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#Steps-calculation"><span class="toc-number">2.4.2.</span> <span class="toc-text">Steps calculation</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#Multiple-concepts"><span class="toc-number">2.4.3.</span> <span class="toc-text">Multiple concepts</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#Custom-config-json-miscellaneous"><span class="toc-number">2.4.4.</span> <span class="toc-text">Custom config.json miscellaneous</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#What-happened-to-the-low-level-config-env"><span class="toc-number">2.4.5.</span> <span class="toc-text">What happened to the low-level config.env ?</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%EC%9D%B4%EB%8A%94-%EC%9C%84%EC%9D%98-config-json%EA%B3%BC-%EB%8F%99%EC%9D%BC%ED%95%9C-%EB%B2%84%EC%A0%84%EC%9D%B4%EC%A7%80%EB%A7%8C-env-%ED%98%95%EC%8B%9D%EC%9E%85%EB%8B%88%EB%8B%A4"><span class="toc-number">2.5.</span> <span class="toc-text">ì´ëŠ” ìœ„ì˜ config.jsonê³¼ ë™ì¼í•œ ë²„ì „ì´ì§€ë§Œ .env í˜•ì‹ì…ë‹ˆë‹¤.</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Training-process"><span class="toc-number">2.6.</span> <span class="toc-text">Training process</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#Possible-accelerate-issues"><span class="toc-number">2.6.1.</span> <span class="toc-text">Possible accelerate issues</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#Memory-usage"><span class="toc-number">2.6.2.</span> <span class="toc-text">Memory usage</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#Monitoring-the-training"><span class="toc-number">2.6.3.</span> <span class="toc-text">Monitoring the training</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#Observing-training-loss"><span class="toc-number">2.6.4.</span> <span class="toc-text">Observing training loss</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#LoRA"><span class="toc-number">2.6.5.</span> <span class="toc-text">LoRA</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Evaluating-the-results"><span class="toc-number">2.7.</span> <span class="toc-text">Evaluating the results</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#How-to-actually-get-the-LoRA-models-into-ComfyUI"><span class="toc-number">2.7.1.</span> <span class="toc-text">How to actually get the LoRA models into ComfyUI</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#Determining-the-best-checkpoint"><span class="toc-number">2.7.2.</span> <span class="toc-text">Determining the best checkpoint</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#A-x2F-B-evaluation"><span class="toc-number">2.8.</span> <span class="toc-text">A&#x2F;B evaluation</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#Improving-x2F-tuning-generations-with-APG-scaling"><span class="toc-number">2.8.1.</span> <span class="toc-text">Improving&#x2F;tuning generations with APG scaling</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#Before-and-after-comparison"><span class="toc-number">2.8.2.</span> <span class="toc-text">Before and after comparison</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Other-fine-tuning-tools-x2F-libraries-for-SD3-5"><span class="toc-number">2.9.</span> <span class="toc-text">Other fine-tuning tools&#x2F;libraries for SD3.5</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Conclusion-amp-Feedback"><span class="toc-number">2.10.</span> <span class="toc-text">Conclusion &amp; Feedback</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Two-cents-from-Dango"><span class="toc-number">2.11.</span> <span class="toc-text">Two cents from Dango</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#Diving-into-SD3-5-Large-Architecture"><span class="toc-number">2.11.1.</span> <span class="toc-text">Diving into SD3.5 Large Architecture</span></a></li></ol></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#%EC%B0%B8%EC%A1%B0"><span class="toc-number">3.</span> <span class="toc-text">ì°¸ì¡°</span></a></li></ol></div></div><div class="author-info hide"><div class="author-info__avatar text-center"><img src="https://avatars0.githubusercontent.com/u/4936005?s=400&amp;u=a679b941fe377418e7e4efcf916c6a636d7178ee&amp;v=4"></div><div class="author-info__name text-center">sejoung kim</div><div class="author-info__description text-center">Java, Kotlin ë“± ë°±ì—”ë“œ ê°œë°œ ê¸°ìˆ ê³¼ ì†Œí”„íŠ¸ì›¨ì–´ ì—”ì§€ë‹ˆì–´ë§ í•™ìŠµ ë‚´ìš©ì„ ì •ë¦¬í•˜ëŠ” ê¸°ìˆ  ë¸”ë¡œê·¸ì…ë‹ˆë‹¤.</div><div class="follow-button"><a target="_blank" rel="external nofollow noopener noreferrer" href="https://github.com/sejoung">Follow Me</a></div><hr><div class="author-info-articles"><a class="author-info-articles__archives article-meta" href="../../../archives"><span class="pull-left">Articles</span><span class="pull-right">790</span></a><a class="author-info-articles__tags article-meta" href="../../../tags"><span class="pull-left">Tags</span><span class="pull-right">817</span></a><a class="author-info-articles__categories article-meta" href="../../../categories"><span class="pull-left">Categories</span><span class="pull-right">73</span></a></div><hr><div class="author-info-links"><div class="author-info-links__title text-center">Links</div><a class="author-info-links__name text-center" target="_blank" rel="external nofollow noopener noreferrer" href="https://blog.naver.com/sanaes">naverblog</a><a class="author-info-links__name text-center" target="_blank" rel="external nofollow noopener noreferrer" href="https://www.linkedin.com/in/sanaes/">linkedin</a><a class="author-info-links__name text-center" target="_blank" rel="external nofollow noopener noreferrer" href="https://www.slideshare.net/sejoung">slideshare</a></div></div></div><div id="content-outer"><div id="top-container" style="background-image: url(https://upload.wikimedia.org/wikipedia/commons/thumb/0/09/Van_Gogh_-_Terrasse_des_Caf%C3%A9s_an_der_Place_du_Forum_in_Arles_am_Abend1.jpeg/1024px-Van_Gogh_-_Terrasse_des_Caf%C3%A9s_an_der_Place_du_Forum_in_Arles_am_Abend1.jpeg)"><div id="page-header"><span class="pull-left"> <a id="site-name" href="../../../index.html">í­ê°„ì˜ ê¸°ìˆ ë¸”ë¡œê·¸</a></span><i class="fa fa-bars toggle-menu pull-right" aria-hidden="true"></i><span class="pull-right menus">   <a class="site-page" href="/">Home</a><a class="site-page" href="/archives">Archives</a><a class="site-page" href="/tags">Tags</a><a class="site-page" href="/categories">Categories</a><a class="site-page" href="/privacy">Privacy</a><a class="site-page" href="/terms">Terms</a><a class="site-page" href="/about">About</a><a class="site-page" href="/contact">Contact</a></span><span class="pull-right"><a class="site-page social-icon search"><i class="fa fa-search"></i><span> Search</span></a></span></div><div id="post-info"><div id="post-title">Stable Diffusion 3.5 Large Fine-tuning Tutorial</div><div id="post-meta"><time class="post-meta__date"><i class="fa fa-calendar" aria-hidden="true"></i> 2024-10-25</time><span class="post-meta__separator">|</span><i class="fa fa-inbox post-meta__icon" aria-hidden="true"></i><a class="post-meta__categories" href="../../../categories/Machine-Learning/">Machine Learning</a><span class="post-meta__separator">|</span><i class="fa fa-comment-o post-meta__icon" aria-hidden="true"></i><a href="#disqus_thread"><span class="disqus-comment-count" data-disqus-identifier="2024/10/2024-10-25-Stable Diffusion_3_5_Large_Fine-tuning_Tutorial/"></span></a></div></div></div><div class="layout" id="content-inner"><article id="post"><div class="article-container" id="post-content"><h1 id="Stable-Diffusion-3-5-Large-Fine-tuning-Tutorial"><a href="#Stable-Diffusion-3-5-Large-Fine-tuning-Tutorial" class="headerlink" title="Stable Diffusion 3.5 Large Fine-tuning Tutorial"></a>Stable Diffusion 3.5 Large Fine-tuning Tutorial</h1><p>ì´ê¸€ì€ <a target="_blank" rel="external nofollow noopener noreferrer" href="https://stabilityai.notion.site/Stable-Diffusion-3-5-Large-Fine-tuning-Tutorial-11a61cdcd1968027a15bdbd7c40be8c6">Stable Diffusion 3.5 Large Fine-tuning Tutorial</a><br>ê¸€ì„ ë²ˆì—­í•œ ê¸€ì…ë‹ˆë‹¤ ì´ë¯¸ì§€ëŠ” ë”°ë¡œ ì²¨ë¶€ í•˜ì§€ ì•Šìœ¼ë©° í•„ìš”í•˜ë‹¤ê³  ìƒê°í•˜ëŠ” ë¶€ë¶„ë§Œ ë²ˆì—­í•©ë‹ˆë‹¤</p>
<h1 id="ëŒ€ìƒ-ë¯¸ì„¸-ì¡°ì •ì—-ëŒ€í•œ-ìµœì†Œí•œì˜-ê¸°ë³¸-ì§€ì‹ì„-ê°–ì¶˜-ì—”ì§€ë‹ˆì–´-ë˜ëŠ”-ê¸°ìˆ -ì¸ë ¥"><a href="#ëŒ€ìƒ-ë¯¸ì„¸-ì¡°ì •ì—-ëŒ€í•œ-ìµœì†Œí•œì˜-ê¸°ë³¸-ì§€ì‹ì„-ê°–ì¶˜-ì—”ì§€ë‹ˆì–´-ë˜ëŠ”-ê¸°ìˆ -ì¸ë ¥" class="headerlink" title="ëŒ€ìƒ : ë¯¸ì„¸ ì¡°ì •ì— ëŒ€í•œ ìµœì†Œí•œì˜ ê¸°ë³¸ ì§€ì‹ì„ ê°–ì¶˜ ì—”ì§€ë‹ˆì–´ ë˜ëŠ” ê¸°ìˆ  ì¸ë ¥"></a>ëŒ€ìƒ : ë¯¸ì„¸ ì¡°ì •ì— ëŒ€í•œ ìµœì†Œí•œì˜ ê¸°ë³¸ ì§€ì‹ì„ ê°–ì¶˜ ì—”ì§€ë‹ˆì–´ ë˜ëŠ” ê¸°ìˆ  ì¸ë ¥</h1><p>ëª©ì : SD1.5&#x2F;SDXLê³¼ Stable Diffusion 3 Medium&#x2F;Large(SD3.5M&#x2F;L) ë¯¸ì„¸ ì¡°ì • ê°„ì˜ ì°¨ì´ì ì„ ì´í•´í•˜ê³  ë” ë§ì€ ì‚¬ìš©ìê°€ ë‘ ëª¨ë¸ì„ ë¯¸ì„¸ ì¡°ì •í•  ìˆ˜ ìˆë„ë¡ í•©ë‹ˆë‹¤.</p>
<h2 id="Tools"><a href="#Tools" class="headerlink" title="Tools"></a>Tools</h2><p><a target="_blank" rel="external nofollow noopener noreferrer" href="https://github.com/bghira/SimpleTuner">SimpleTuner</a> toolkit</p>
<h2 id="Environment-Setup"><a href="#Environment-Setup" class="headerlink" title="Environment Setup"></a>Environment Setup</h2><p>í™˜ê²½ ì„¤ì •ì€ ì—¬ì „íˆ ì´ì „ê³¼ ë¹„ìŠ·í•˜ì§€ë§Œ, ì´ì „ ê²Œì‹œë¬¼ ì´í›„ SimpleTunerì˜ êµ¬ì„±ì—ëŠ” <strong>ë§ì€</strong> ë³€ê²½ì´ ìˆì—ˆìŠµë‹ˆë‹¤.<br>ê°€ëŠ¥í•œ í•œ ì´ ì‘ì—…ì„ ê°„ì†Œí™”í•˜ë ¤ê³  ë…¸ë ¥í•˜ê² ì§€ë§Œ ì´ì „ <code>config.env</code> íŒŒì¼ê³¼ ìƒˆë¡œìš´ <code>config.env</code> ë° <code>config.json</code>ì„ ëª¨ë‘ ì‚¬ìš©í•˜ì—¬ ì‹¤í—˜í–ˆìŠµë‹ˆë‹¤.<br><a target="_blank" rel="external nofollow noopener noreferrer" href="https://github.com/bghira/SimpleTuner/blob/main">ì—¬ê¸°</a>ì— ì§€ì •ëœ <a target="_blank" rel="external nofollow noopener noreferrer" href="https://github.com/bghira/SimpleTuner/blob/main/configure.py">configure.py</a> ë°©ë²•ì„ ì‚¬ìš©í–ˆìŠµë‹ˆë‹¤. &#x2F;documentation&#x2F;quickstart&#x2F;SD3.md)ë¥¼ ì°¸ì¡°í•˜ì—¬ ê²°ê³¼ íŒŒì¼ì´ ë¬´ì—‡ì„ ì œê³µí•˜ëŠ”ì§€ í™•ì¸í•˜ì„¸ìš”.</p>
<p><a target="_blank" rel="external nofollow noopener noreferrer" href="https://emojipedia.org/warning">**âš ï¸</a>** Just a note of warning, if youâ€™d like to use your <a target="_blank" rel="external nofollow noopener noreferrer" href="https://www.notion.so/17f90df74bce4c62a295849f0dc8fb7e?pvs=21">old</a> <code>config.env</code> files, youâ€™ll have to do some slight tweaking. Iâ€™ll cover it later in this <a target="_blank" rel="external nofollow noopener noreferrer" href="https://www.notion.so/Stable-Diffusion-3-5-Large-Fine-tuning-Tutorial-11a61cdcd1968027a15bdbd7c40be8c6?pvs=21">section</a>.</p>
<p>If you want to see the full list of options available, you can check the <a target="_blank" rel="external nofollow noopener noreferrer" href="https://github.com/bghira/SimpleTuner/blob/main/OPTIONS.md#environment-configuration-variables">OPTIONS.MD</a> file.</p>
<ul>
<li>Sample <code>.json</code> generated with <code>configure.py</code> (used as a reference)</li>
</ul>
<figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br></pre></td><td class="code"><pre><span class="line"><span class="punctuation">&#123;</span></span><br><span class="line">    <span class="attr">&quot;--resume_from_checkpoint&quot;</span><span class="punctuation">:</span> <span class="string">&quot;latest&quot;</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;--data_backend_config&quot;</span><span class="punctuation">:</span> <span class="string">&quot;config/multidatabackend.json&quot;</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;--aspect_bucket_rounding&quot;</span><span class="punctuation">:</span> <span class="number">2</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;--seed&quot;</span><span class="punctuation">:</span> <span class="number">42</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;--minimum_image_size&quot;</span><span class="punctuation">:</span> <span class="number">0</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;--disable_benchmark&quot;</span><span class="punctuation">:</span> <span class="keyword">false</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;--output_dir&quot;</span><span class="punctuation">:</span> <span class="string">&quot;/weka2/home-yeo/simpletuner_models/sd3_large/full_finetune/fantasy_art_L_01/datasets/&quot;</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;--lora_type&quot;</span><span class="punctuation">:</span> <span class="string">&quot;standard&quot;</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;--lora_rank&quot;</span><span class="punctuation">:</span> <span class="number">256</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;--max_train_steps&quot;</span><span class="punctuation">:</span> <span class="number">24000</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;--num_train_epochs&quot;</span><span class="punctuation">:</span> <span class="number">0</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;--checkpointing_steps&quot;</span><span class="punctuation">:</span> <span class="number">400</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;--checkpoints_total_limit&quot;</span><span class="punctuation">:</span> <span class="number">60</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;--tracker_project_name&quot;</span><span class="punctuation">:</span> <span class="string">&quot;sd35-training&quot;</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;--tracker_run_name&quot;</span><span class="punctuation">:</span> <span class="string">&quot;simpletuner-sd35-large-fantasy-art-01&quot;</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;--report_to&quot;</span><span class="punctuation">:</span> <span class="string">&quot;wandb&quot;</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;--model_type&quot;</span><span class="punctuation">:</span> <span class="string">&quot;lora&quot;</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;--pretrained_model_name_or_path&quot;</span><span class="punctuation">:</span> <span class="string">&quot;stabilityai/stable-diffusion-3.5-large&quot;</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;--model_family&quot;</span><span class="punctuation">:</span> <span class="string">&quot;sd3&quot;</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;--train_batch_size&quot;</span><span class="punctuation">:</span> <span class="number">6</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;--gradient_checkpointing&quot;</span><span class="punctuation">:</span> <span class="string">&quot;true&quot;</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;--caption_dropout_probability&quot;</span><span class="punctuation">:</span> <span class="number">0.0</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;--resolution_type&quot;</span><span class="punctuation">:</span> <span class="string">&quot;pixel_area&quot;</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;--resolution&quot;</span><span class="punctuation">:</span> <span class="string">&quot;1024&quot;</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;--validation_seed&quot;</span><span class="punctuation">:</span> <span class="string">&quot;42&quot;</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;--validation_steps&quot;</span><span class="punctuation">:</span> <span class="string">&quot;35&quot;</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;--validation_resolution&quot;</span><span class="punctuation">:</span> <span class="string">&quot;1024x1024&quot;</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;--validation_guidance&quot;</span><span class="punctuation">:</span> <span class="string">&quot;7.5&quot;</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;--validation_guidance_rescale&quot;</span><span class="punctuation">:</span> <span class="string">&quot;0.0&quot;</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;--validation_num_inference_steps&quot;</span><span class="punctuation">:</span> <span class="string">&quot;35&quot;</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;--validation_prompt&quot;</span><span class="punctuation">:</span> <span class="string">&quot;k4s4, a waist up view of a beautiful blonde woman, green eyes&quot;</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;--mixed_precision&quot;</span><span class="punctuation">:</span> <span class="string">&quot;bf16&quot;</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;--optimizer&quot;</span><span class="punctuation">:</span> <span class="string">&quot;adamw_bf16&quot;</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;--learning_rate&quot;</span><span class="punctuation">:</span> <span class="string">&quot;1.05e-3&quot;</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;--lr_scheduler&quot;</span><span class="punctuation">:</span> <span class="string">&quot;polynomial&quot;</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;--lr_warmup_steps&quot;</span><span class="punctuation">:</span> <span class="string">&quot;2400&quot;</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;--validation_torch_compile&quot;</span><span class="punctuation">:</span> <span class="string">&quot;false&quot;</span></span><br><span class="line"><span class="punctuation">&#125;</span></span><br><span class="line"></span><br></pre></td></tr></table></figure>



<p>ë˜í•œ, <a target="_blank" rel="external nofollow noopener noreferrer" href="https://github.com/bghira/SimpleTuner/tree/release">ë¦´ë¦¬ìŠ¤ ë¸Œëœì¹˜</a> ëŒ€ì‹  <code>SimpleTuner</code>ì˜ ìµœì‹  ë©”ì¸ ë¸Œëœì¹˜ ì¤‘ í•˜ë‚˜ë¥¼ ì‚¬ìš©í•˜ê³  ìˆìŠµë‹ˆë‹¤. ê°€ëŠ¥í•œ í•œ í˜„ì¬ê¹Œì§€. ì»¤ë°‹ í•´ì‹œ(2024ë…„ 10ì›” 15ì¼)ëŠ” ë‹¤ìŒê³¼ ê°™ìŠµë‹ˆë‹¤.</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">694784083c70bf81086bb3ceba86262b7b22757d</span><br></pre></td></tr></table></figure>

<h3 id="Python-Dependencies"><a href="#Python-Dependencies" class="headerlink" title="Python Dependencies"></a>Python Dependencies</h3><p>ì¢…ì†ì„±ì„ ì„¤ì¹˜í•˜ë ¤ë©´ ì €ì¥ì†Œ í˜ì´ì§€ì—ì„œ SD3ìš© <a target="_blank" rel="external nofollow noopener noreferrer" href="https://github.com/bghira/SimpleTuner/blob/main/documentation/quickstart/SD3.md">ë¹ ë¥¸ ì‹œì‘ ê°€ì´ë“œ</a>ë¥¼ ë”°ë¥´ì„¸ìš”. ì—¬ê¸°ì—ì„œë„ ì‚´í´ë³´ê³  ëŒ€ì²´ ì„¤ì¹˜ ë°©ë²•ë„ ì¶”ê°€í•˜ê² ìŠµë‹ˆë‹¤. <code>SimpleTuner</code>(<code>12.4+</code>)ì™€ ì¼ì¹˜í•˜ëŠ” <code>CUDA</code> ë²„ì „ì´ ìˆëŠ” ê²½ìš° ì¢…ì†ì„± ì„¤ì¹˜ê°€ ë§¤ìš° ê°„ë‹¨í•  ìˆ˜ ìˆì§€ë§Œ <code>CUDA</code>ì˜ ì´ì „ ë²„ì „ì„ ì‚¬ìš©í•˜ëŠ” ê²½ìš° ì¡°ê¸ˆ ë” ë³µì¡í•´ì§ˆ ìˆ˜ ìˆìŠµë‹ˆë‹¤.</p>
<p>ìš°ì„  ì €ì¥ì†Œë¥¼ <code>git clone</code>í•©ë‹ˆë‹¤.</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">git clone https://github.com/bghira/SimpleTuner.git</span><br></pre></td></tr></table></figure>

<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">cd SimpleTuner</span><br></pre></td></tr></table></figure>


<p>ë§ˆì§€ë§‰ìœ¼ë¡œ ìœ„ì—ì„œ ì–¸ê¸‰í•œ ì»¤ë°‹ í•´ì‹œë¥¼ í™•ì¸í•˜ì„¸ìš”. ë””ë²„ê¹…ì„ í•˜ê³  ì‹¶ë‹¤ë©´ ê³„ì†í•´ì„œ ë¶„ê¸°ë¥¼ ìƒì„±í•´ ë³´ê² ìŠµë‹ˆë‹¤(â€˜base_branchâ€™ë¼ëŠ” ì´ë¦„, ììœ ë¡­ê²Œ ì´ë¦„ì„ ë°”ê¾¸ì„¸ìš”).</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">git checkout -b base_branch 694784083c70bf81086bb3ceba86262b7b22757d</span><br></pre></td></tr></table></figure>


<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">git branch</span><br></pre></td></tr></table></figure>

<p>ìƒˆ ì§€ì ì— ìˆìœ¼ë©´ Python ê°€ìƒ í™˜ê²½ì„ ë§Œë“¤ ì°¨ë¡€ì…ë‹ˆë‹¤. ì¢…ì†ì„±ì„ ì„¤ì¹˜í•  ë•Œ <code>python 3.11</code>ì„ ì‚¬ìš©í•˜ëŠ” ê²ƒì´ ì¢‹ìŠµë‹ˆë‹¤.</p>
<p>ê°ê° ë‹¤ìŒ ëª…ë ¹ì„ ì‚¬ìš©í•˜ì—¬ <code>OS</code> ë° <code>CUDA</code> í™˜ê²½ì„ í™•ì¸í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">uname</span> -a</span><br></pre></td></tr></table></figure>

<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">nvcc --version</span><br></pre></td></tr></table></figure>

<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">python --version</span><br></pre></td></tr></table></figure>


<p><code>SimpleTuner</code> ë””ë ‰í„°ë¦¬ì˜ ë£¨íŠ¸ì— ì´ ëª…ë ¹ì„ ì‚¬ìš©í•˜ì—¬ <code>virtualenv</code>ë¥¼ ë§Œë“­ë‹ˆë‹¤.</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">python -m venv .venv</span><br></pre></td></tr></table></figure>

<p>Activate it with:</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">source .venv/bin/activate</span><br></pre></td></tr></table></figure>

<p>ì™„ë£Œë˜ë©´ <code>poetry</code>(<code>pip</code> ë˜ëŠ” <code>uv</code>ì™€ ìœ ì‚¬í•œ ì¢…ì†ì„± ê´€ë¦¬ì)ë¥¼ ì„¤ì¹˜í•©ë‹ˆë‹¤.</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">pip install -U poetry pip</span><br></pre></td></tr></table></figure>

<p><code>bghira</code>ëŠ” ì•ˆì „ì„ ìœ„í•´ ì´ ëª…ë ¹ì„ ì‹¤í–‰í•  ê²ƒì„ ê¶Œì¥í•©ë‹ˆë‹¤:</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">poetry config virtualenvs.create false</span><br></pre></td></tr></table></figure>

<p>ì €ëŠ” <code>Linux</code>ë¥¼ ì‚¬ìš©í•˜ê³  ìˆìœ¼ë¯€ë¡œ ë‹¤ìŒ ë‹¨ê³„ëŠ” ë‹¤ìŒ ëª…ë ¹ì„ ì‚¬ìš©í•˜ì—¬ ëª¨ë“  ì¢…ì†ì„±ì„ ì„¤ì¹˜í•˜ëŠ” ê²ƒì…ë‹ˆë‹¤.</p>
<figure class="highlight jsx"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">poetry install</span><br></pre></td></tr></table></figure>


<p>ê·¸ëŸ¬ë‚˜ SD3.5 LargeëŠ” <code>diffusers</code>ì˜ íŠ¹ì • ì»¤ë°‹ì— ë”°ë¼ ë‹¬ë¼ì§‘ë‹ˆë‹¤(ì•„ë§ˆë„ ìµœì‹  ë²„ì „ë„ ì‘ë™í•  ê²ƒì…ë‹ˆë‹¤). ì´ <a target="_blank" rel="external nofollow noopener noreferrer" href="https://github.com/huggingface/diffusers/commit/e2d037bbf1388fdc172458bed7a8a58b34fc6f84">ì»¤ë°‹</a> ì´ìƒì´ í¬í•¨ëœ ë²„ì „ì„ ì‚¬ìš©í•˜ê³  ìˆëŠ”ì§€ í™•ì¸í•˜ì„¸ìš”.</p>
<figure class="highlight markdown"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">e2d037bbf1388fdc172458bed7a8a58b34fc6f84</span><br></pre></td></tr></table></figure>


<p>ì´ëŠ” â€˜bghiraâ€™ë¡œ ë³€ê²½ë  ìˆ˜ ìˆìœ¼ë©° ê·¸ì˜ íŒ€ì€ SimpleTuner ì €ì¥ì†Œë¥¼ ë§¤ìš° ë¹ ë¥´ê²Œ ì—…ë°ì´íŠ¸í•©ë‹ˆë‹¤. ì˜¬ë°”ë¥¸ ë²„ì „ì˜ <code>diffusers</code>ë¥¼ ì‚¬ìš©í•˜ê³  ìˆëŠ”ì§€ í™•ì¸í•˜ë ¤ë©´ <code>SimpleTuner</code> ë””ë ‰í„°ë¦¬ì˜ <code>pyproject.toml</code> íŒŒì¼ì„ ë³€ê²½í•˜ì—¬ ì˜¬ë°”ë¥¸ ì»¤ë°‹ì„ ì‚¬ìš©í•˜ì„¸ìš”.</p>
<figure class="highlight toml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br></pre></td><td class="code"><pre><span class="line"><span class="section">[tool.poetry]</span></span><br><span class="line"><span class="attr">name</span> = <span class="string">&quot;simpletuner&quot;</span></span><br><span class="line"><span class="attr">version</span> = <span class="string">&quot;1.1.0&quot;</span></span><br><span class="line"><span class="attr">description</span> = <span class="string">&quot;Stable Diffusion 2.x and XL tuner.&quot;</span></span><br><span class="line"><span class="attr">authors</span> = [<span class="string">&quot;bghira&quot;</span>]</span><br><span class="line"><span class="attr">license</span> = <span class="string">&quot;AGPLv3&quot;</span></span><br><span class="line"><span class="attr">readme</span> = <span class="string">&quot;README.md&quot;</span></span><br><span class="line"><span class="attr">package-mode</span> = <span class="literal">false</span></span><br><span class="line"></span><br><span class="line"><span class="section">[tool.poetry.dependencies]</span></span><br><span class="line"><span class="attr">python</span> = <span class="string">&quot;&gt;=3.10,&lt;3.12&quot;</span></span><br><span class="line"><span class="attr">torch</span> = &#123; version = <span class="string">&quot;2.4.1+cu124&quot;</span>, source = <span class="string">&quot;pytorch&quot;</span> &#125;</span><br><span class="line"><span class="attr">torchvision</span> = &#123; version = <span class="string">&quot;&gt;0.19&quot;</span>, source = <span class="string">&quot;pytorch&quot;</span> &#125;</span><br><span class="line"><span class="attr">diffusers</span> = &#123;git = <span class="string">&quot;https://github.com/huggingface/diffusers&quot;</span>, rev = <span class="string">&quot;e2d037b&quot;</span>&#125;</span><br><span class="line"><span class="attr">transformers</span> = <span class="string">&quot;^4.45.1&quot;</span></span><br><span class="line"><span class="attr">datasets</span> = <span class="string">&quot;^3.0.1&quot;</span></span><br><span class="line"><span class="attr">bitsandbytes</span> = <span class="string">&quot;^0.44.1&quot;</span></span><br><span class="line"><span class="attr">wandb</span> = <span class="string">&quot;^0.18.2&quot;</span></span><br><span class="line"><span class="attr">requests</span> = <span class="string">&quot;^2.32.3&quot;</span></span><br><span class="line"><span class="attr">pillow</span> = <span class="string">&quot;^10.4.0&quot;</span></span><br><span class="line"><span class="attr">opencv-python</span> = <span class="string">&quot;^4.10.0.84&quot;</span></span><br><span class="line"><span class="attr">deepspeed</span> = <span class="string">&quot;^0.15.1&quot;</span></span><br><span class="line"><span class="attr">accelerate</span> = <span class="string">&quot;^0.34.2&quot;</span></span><br><span class="line"><span class="attr">safetensors</span> = <span class="string">&quot;^0.4.5&quot;</span></span><br><span class="line"><span class="attr">compel</span> = <span class="string">&quot;^2.0.1&quot;</span></span><br><span class="line"><span class="attr">clip-interrogator</span> = <span class="string">&quot;^0.6.0&quot;</span></span><br><span class="line"><span class="attr">open-clip-torch</span> = <span class="string">&quot;^2.26.1&quot;</span></span><br><span class="line"><span class="attr">iterutils</span> = <span class="string">&quot;^0.1.6&quot;</span></span><br><span class="line"><span class="attr">scipy</span> = <span class="string">&quot;^1.11.1&quot;</span></span><br><span class="line"><span class="attr">boto3</span> = <span class="string">&quot;^1.35.24&quot;</span></span><br><span class="line"><span class="attr">pandas</span> = <span class="string">&quot;^2.2.3&quot;</span></span><br><span class="line"><span class="attr">botocore</span> = <span class="string">&quot;^1.35.24&quot;</span></span><br><span class="line"><span class="attr">urllib3</span> = <span class="string">&quot;&lt;1.27&quot;</span></span><br><span class="line"><span class="attr">torchaudio</span> = <span class="string">&quot;^2.4.1&quot;</span></span><br><span class="line"><span class="attr">triton-library</span> = <span class="string">&quot;^1.0.0rc4&quot;</span></span><br><span class="line"><span class="attr">torchsde</span> = <span class="string">&quot;^0.2.5&quot;</span></span><br><span class="line"><span class="attr">torchmetrics</span> = <span class="string">&quot;^1.1.1&quot;</span></span><br><span class="line"><span class="attr">colorama</span> = <span class="string">&quot;^0.4.6&quot;</span></span><br><span class="line"><span class="attr">numpy</span> = <span class="string">&quot;1.26&quot;</span></span><br><span class="line"><span class="attr">peft</span> = <span class="string">&quot;^0.12.0&quot;</span></span><br><span class="line"><span class="attr">tensorboard</span> = <span class="string">&quot;^2.17.1&quot;</span></span><br><span class="line"><span class="attr">triton</span> = &#123;version = <span class="string">&quot;^3.0.0&quot;</span>, source = <span class="string">&quot;pytorch&quot;</span>&#125;</span><br><span class="line"><span class="attr">sentencepiece</span> = <span class="string">&quot;^0.2.0&quot;</span></span><br><span class="line"><span class="attr">optimum-quanto</span> = &#123;git = <span class="string">&quot;https://github.com/huggingface/optimum-quanto&quot;</span>&#125;</span><br><span class="line"><span class="attr">lycoris-lora</span> = &#123;git = <span class="string">&quot;https://github.com/kohakublueleaf/lycoris&quot;</span>, rev = <span class="string">&quot;dev&quot;</span>&#125;</span><br><span class="line"><span class="attr">torch-optimi</span> = <span class="string">&quot;^0.2.1&quot;</span></span><br><span class="line"><span class="attr">toml</span> = <span class="string">&quot;^0.10.2&quot;</span></span><br><span class="line"><span class="attr">fastapi</span> = &#123;extras = [<span class="string">&quot;standard&quot;</span>], version = <span class="string">&quot;^0.115.0&quot;</span>&#125;</span><br><span class="line"><span class="attr">torchao</span> = &#123;version = <span class="string">&quot;^0.5.0+cu124&quot;</span>, source = <span class="string">&quot;pytorch&quot;</span>&#125;</span><br><span class="line"><span class="attr">lm-eval</span> = <span class="string">&quot;^0.4.4&quot;</span></span><br><span class="line"><span class="attr">nvidia-cudnn-cu12</span> = <span class="string">&quot;*&quot;</span></span><br><span class="line"><span class="attr">nvidia-nccl-cu12</span> = <span class="string">&quot;*&quot;</span></span><br><span class="line"></span><br><span class="line"><span class="section">[build-system]</span></span><br><span class="line"><span class="attr">requires</span> = [<span class="string">&quot;poetry-core&quot;</span>, <span class="string">&quot;setuptools&quot;</span>, <span class="string">&quot;wheel&quot;</span>, <span class="string">&quot;torch&quot;</span>]</span><br><span class="line"><span class="attr">build-backend</span> = <span class="string">&quot;poetry.core.masonry.api&quot;</span></span><br><span class="line"></span><br><span class="line"><span class="section">[[tool.poetry.source]]</span></span><br><span class="line"><span class="attr">priority</span> = <span class="string">&quot;supplemental&quot;</span></span><br><span class="line"><span class="attr">name</span> = <span class="string">&quot;pytorch&quot;</span></span><br><span class="line"><span class="attr">url</span> = <span class="string">&quot;https://download.pytorch.org/whl/cu124&quot;</span></span><br><span class="line"></span><br></pre></td></tr></table></figure>



<p>ë³€ê²½ ì‚¬í•­ì€ ë‹¤ìŒê³¼ ê°™ìŠµë‹ˆë‹¤.</p>
<p>Old</p>
<figure class="highlight toml"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">diffusers</span> = &#123;git = <span class="string">&quot;https://github.com/huggingface/diffusers&quot;</span>, rev = <span class="string">&quot;quantization-config&quot;</span>&#125;</span><br></pre></td></tr></table></figure>

<p>New</p>
<figure class="highlight toml"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">diffusers</span> = &#123;git = <span class="string">&quot;https://github.com/huggingface/diffusers&quot;</span>, rev = <span class="string">&quot;e2d037b&quot;</span>&#125;</span><br></pre></td></tr></table></figure>

<h2 id="ì´ì œ-í•„ìš”í•œ-SimpleTuner-ì¢…ì†ì„±ì´-ëª¨ë‘-ì„¤ì¹˜ë˜ì–´-ìˆì–´ì•¼-í•©ë‹ˆë‹¤"><a href="#ì´ì œ-í•„ìš”í•œ-SimpleTuner-ì¢…ì†ì„±ì´-ëª¨ë‘-ì„¤ì¹˜ë˜ì–´-ìˆì–´ì•¼-í•©ë‹ˆë‹¤" class="headerlink" title="ì´ì œ í•„ìš”í•œ SimpleTuner ì¢…ì†ì„±ì´ ëª¨ë‘ ì„¤ì¹˜ë˜ì–´ ìˆì–´ì•¼ í•©ë‹ˆë‹¤."></a>ì´ì œ í•„ìš”í•œ <code>SimpleTuner</code> ì¢…ì†ì„±ì´ ëª¨ë‘ ì„¤ì¹˜ë˜ì–´ ìˆì–´ì•¼ í•©ë‹ˆë‹¤.</h2><ul>
<li><a target="_blank" rel="external nofollow noopener noreferrer" href="https://emojipedia.org/police-car-light">**ğŸš¨</a>** ì»´í“¨í„° í™˜ê²½ì—ì„œ â€˜CUDA 12.4â€™ ì´ìƒì´ ì•„ë‹Œ ê²½ìš° â€˜SimpleTunerâ€™ê°€ â€˜CUDA 12.4â€™ ì´ìƒì´ë¼ëŠ” ê°€ì •í•˜ì— ì‘ë™í•˜ë¯€ë¡œ CUDA ì¢…ì†ì„± ë¬¸ì œê°€ ë°œìƒí•  ìˆ˜ ìˆìŠµë‹ˆë‹¤. ì•ì„œ ì•Œì•„ì°¨ë¦¬ì…¨ë‹¤ë©´ ì €ëŠ” <code>CUDA 12.2</code>ë¥¼ ì‚¬ìš© ì¤‘ì´ì—ˆê³  <code>poetry install</code> ë¬¸ì œê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.<ul>
<li><p>ì´ ë‹¨ë½ì„ í¼ì¹˜ê³  <strong>ëŒ€ì²´</strong> ì„¤ì¹˜ ì§€ì¹¨ì„ ë³´ë ¤ë©´ â–·ë¥¼ í´ë¦­í•˜ì„¸ìš”.</p>
<p>ëŒ€ì‹ , ì œê°€ í•œ ì¼ì€ ê¸°ë³¸ <code>torch</code> ì¢…ì†ì„±ì„ ë¨¼ì € ì„¤ì¹˜í•œ ë‹¤ìŒ <code>pyproject.toml</code>ì˜ ë‚˜ë¨¸ì§€ ì¢…ì†ì„±ì„ í¬í•¨í•˜ëŠ” <code>requirements.txt</code> íŒŒì¼ì„ ë§Œë“œëŠ” ê²ƒì´ì—ˆìŠµë‹ˆë‹¤. ê·¸ëŸ° ë‹¤ìŒ í•´ë‹¹ í…ìŠ¤íŠ¸ íŒŒì¼ì— <code>pip install</code>ì„ ì‹¤í–‰í–ˆìŠµë‹ˆë‹¤.</p>
<p><code>poetry install</code>ì„ ë¨¼ì € ì‹œë„í•˜ê³  ë¬¸ì œê°€ ë°œìƒí–ˆë‹¤ë©´ ê¸°ì¡´ <code>virtualenv</code>ë¥¼ ì œê±°í•˜ê³  ë‹¤ì‹œ ì„¤ì¹˜í•˜ëŠ” ê²ƒì´ ì¢‹ìŠµë‹ˆë‹¤.</p>
  <figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">rm</span> -rf .venv</span><br></pre></td></tr></table></figure>

  <figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">python -m venv .venv</span><br></pre></td></tr></table></figure>

  <figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">source</span> .venv/bin/activate</span><br></pre></td></tr></table></figure>

<p>  ì´ì œ â€˜CUDAâ€™ ë²„ì „ì— ë”°ë¼ ë¨¼ì € í† ì¹˜ ì¢…ì†ì„±ì„ ì„¤ì¹˜í•˜ì„¸ìš”. CUDA 12.1ì€ ë‚´ í™˜ê²½ì¸ â€˜CUDA 12.2â€™ì— ë¹„í•´ ë‚®ì€ ë²„ì „ì´ë¯€ë¡œ ë‚˜ì—ê²Œ ì í•©í•©ë‹ˆë‹¤.</p>
  <figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">pip install torch==2.4.1+cu121 torchvision==0.19.1+cu121 torchaudio==2.4.1+cu121 --index-url https://download.pytorch.org/whl/cu121</span><br></pre></td></tr></table></figure>

<p>â€˜cu121â€™ì´ ì¶”ê°€ëœ ê²ƒì„ ë³¼ ìˆ˜ ìˆìŠµë‹ˆë‹¤. ì´ëŠ” â€˜CUDAâ€™ ë²„ì „ì„ ì§€ì •í•©ë‹ˆë‹¤. <code>CUDA</code> ë²„ì „ì— ë§ê²Œ ë³€ê²½í•˜ì„¸ìš”.<br>ê·¸ëŸ° ë‹¤ìŒ <code>torchao</code>ë¥¼ ì„¤ì¹˜í•©ë‹ˆë‹¤.</p>
  <figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">pip install torchao --extra-index-url https://download.pytorch.org/whl/cu121</span><br></pre></td></tr></table></figure>

<p>ì´ì œ <code>SimpleTuner</code> ë””ë ‰í„°ë¦¬ ë£¨íŠ¸ì— <code>requirements.txt</code> íŒŒì¼ì„ ë§Œë“­ë‹ˆë‹¤.</p>
<ul>
<li><p><code>requirements.txt</code></p>
  <figure class="highlight text"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br></pre></td><td class="code"><pre><span class="line">diffusers @ git+https://github.com/huggingface/diffusers.git@e2d037b</span><br><span class="line">transformers==4.45.1</span><br><span class="line">datasets==3.0.1</span><br><span class="line">bitsandbytes==0.44.1</span><br><span class="line">wandb==0.18.2</span><br><span class="line">requests==2.32.3</span><br><span class="line">pillow==10.4.0</span><br><span class="line">opencv-python==4.10.0.84</span><br><span class="line">deepspeed==0.15.1</span><br><span class="line">accelerate==0.34.2</span><br><span class="line">safetensors==0.4.5</span><br><span class="line">compel==2.0.1</span><br><span class="line">clip-interrogator==0.6.0</span><br><span class="line">open-clip-torch==2.26.1</span><br><span class="line">iterutils==0.1.6</span><br><span class="line">scipy==1.11.1</span><br><span class="line">boto3==1.35.24</span><br><span class="line">pandas==2.2.3</span><br><span class="line">botocore==1.35.24</span><br><span class="line">urllib3&lt;1.27</span><br><span class="line">triton-library==1.0.0rc2</span><br><span class="line">torchsde==0.2.5</span><br><span class="line">torchmetrics==1.1.1</span><br><span class="line">colorama==0.4.6</span><br><span class="line">numpy==1.26</span><br><span class="line">peft==0.12.0</span><br><span class="line">tensorboard==2.17.1</span><br><span class="line">triton==3.0.0</span><br><span class="line">sentencepiece==0.2.0</span><br><span class="line">optimum-quanto @ git+https://github.com/huggingface/optimum-quanto.git</span><br><span class="line">lycoris-lora @ git+https://github.com/kohakublueleaf/lycoris.git@dev</span><br><span class="line">torch-optimi==0.2.1</span><br><span class="line">toml==0.10.2</span><br><span class="line">fastapi[standard]==0.115.0</span><br><span class="line">lm-eval==0.4.4</span><br></pre></td></tr></table></figure></li>
</ul>
<p>  ì™„ë£Œë˜ë©´ ì¢…ì†ì„±ì„ ì„¤ì¹˜í•˜ì‹­ì‹œì˜¤.</p>
  <figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">pip install -r requirements.txt</span><br></pre></td></tr></table></figure>

<p> ì´ì œ í•„ìš”í•œ ëª¨ë“  ì¢…ì†ì„±ì´ ì„¤ì¹˜ë˜ì–´ ìˆì–´ì•¼ í•©ë‹ˆë‹¤.</p>
</li>
</ul>
</li>
</ul>
<h3 id="Model-Dependencies"><a href="#Model-Dependencies" class="headerlink" title="Model Dependencies"></a>Model Dependencies</h3><p>ì´ë²ˆì—ëŠ” ê¸°ë³¸ ì²´í¬í¬ì¸íŠ¸ì™€ ë””í“¨ì €ê°€ &#96;stabilityai&#x2F;stable-diffusion-â€˜ì´ë¼ëŠ” Hugging Face <a target="_blank" rel="external nofollow noopener noreferrer" href="https://huggingface.co/stabilityai/stable-diffusion-3.5-large">ì €ì¥ì†Œ</a>ì— ëª¨ë‘ ì˜ íŒ¨í‚¤ì§€ë˜ì–´ ìˆìŠµë‹ˆë‹¤. </p>
<p><code>MODEL_NAME</code>(<code>config.env</code>ë¥¼ ì‚¬ìš©í•˜ëŠ” ê²½ìš°) ë˜ëŠ” <code>--pretrained_model_name_or_path</code>(<code>config.json</code>ì„ ì‚¬ìš©í•˜ëŠ” ê²½ìš°)ë¥¼ <code>stabilityai/stable-diffusion-3.5-large</code>ë¡œ ì„¤ì •í•˜ì„¸ìš”. <code>SimpleTuner</code>ëŠ” Hugging Faceì—ì„œ ëª¨ë¸ì„ ê°€ì ¸ì™€ í™ˆ ë””ë ‰í† ë¦¬ì˜ <code>.cache</code> ë””ë ‰í† ë¦¬ì— ì €ì¥í•©ë‹ˆë‹¤.</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">~/.cache/huggingface/hub </span><br></pre></td></tr></table></figure>

<p>ëª¨ë¸ íŒŒì¼ì€ <code>~/.cache/huggingface/hub/models--stabilityai--stable-diffusion-3.5-large/snapshots/hash</code> ë‚´ì— ë‹¤ìŒê³¼ ê°™ì´ í‘œì‹œë©ë‹ˆë‹¤.</p>
<h3 id="Configuration-setup-high-level"><a href="#Configuration-setup-high-level" class="headerlink" title="Configuration setup (high-level)"></a>Configuration setup (high-level)</h3><p>ì´ì „ ë²„ì „ì˜ â€˜SimpleTunerâ€™ì—ì„œ ì˜¤ì‹œëŠ” ê²½ìš° ìƒìœ„ ìˆ˜ì¤€ êµ¬ì„± íŒŒì¼ ì„¤ì •ì´ í¬ê²Œ ë³€ê²½ë˜ì—ˆìŠµë‹ˆë‹¤. ê·¸ëŸ¬ë‚˜ ë‚´ë¶€ <a target="_blank" rel="external nofollow noopener noreferrer" href="https://github.com/bghira/SimpleTuner/blob/main/OPTIONS.md#environment-configuration-variables">OPTIONS.MD</a>ëŠ” ì—¬ì „íˆ ë™ì¼í•˜ê²Œ ìœ ì§€ë©ë‹ˆë‹¤.</p>
<p><a target="_blank" rel="external nofollow noopener noreferrer" href="https://emojipedia.org/warning">**âš ï¸</a> íŠ¹íˆ**, <a target="_blank" rel="external nofollow noopener noreferrer" href="https://github.com/bghira/SimpleTuner/blob/main/documentation/quickstart/">SD3 ë¹ ë¥¸ ì‹œì‘</a>ë§Œ ë”°ë¥´ë©´ ë©ë‹ˆë‹¤. SD3.md) êµ¬ì„± íŒŒì¼ì„ ì •í™•íˆ ì–´ë–»ê²Œ ì„¤ì •í•´ì•¼ í•˜ëŠ”ì§€ ì „ì²´ ê·¸ë¦¼ì„ ì–»ì§€ ëª»í•  ìˆ˜ë„ ìˆìŠµë‹ˆë‹¤. <code>SimpleTuner</code>ì˜ <a target="_blank" rel="external nofollow noopener noreferrer" href="https://github.com/bghira/SimpleTuner/blob/main/INSTALL.md">INSTALL.MD</a> íŒŒì¼ì€ êµ¬ì„± íŒŒì¼ ì‹œìŠ¤í…œì´ ì •í™•íˆ ì–´ë–»ê²Œ ì‘ë™í•˜ëŠ”ì§€ì— ëŒ€í•œ ì „ì²´ ê·¸ë¦¼ì„ ì œê³µí•©ë‹ˆë‹¤.</p>
<p>ë” ì§„í–‰í•˜ê¸° ì „ì— ì‹¤ì œë¡œ í›ˆë ¨ì´ ì–´ë–»ê²Œ ì‹œì‘ë˜ëŠ”ì§€ ì•Œì•„ë³´ê³  ì‹¶ìŠµë‹ˆë‹¤. ë¹ ë¥¸ ì‹œì‘ì—ì„œëŠ” ë‹¤ìŒì„ ì‚¬ìš©í•˜ì—¬ ì‹¤í–‰í•œë‹¤ê³  ë‚˜ì™€ ìˆìŠµë‹ˆë‹¤.</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">bash train.sh</span><br></pre></td></tr></table></figure>

<ul>
<li><p>ê¸°ë³¸ <a target="_blank" rel="external nofollow noopener noreferrer" href="http://train.sh/">train.sh</a>ê°€ ì—¬ê¸°ì— ì œê³µë©ë‹ˆë‹¤.</p>
  <figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#!/usr/bin/env bash</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># Pull config from config.env</span></span><br><span class="line">[ -f <span class="string">&quot;config/config.env&quot;</span> ] &amp;&amp; <span class="built_in">source</span> config/config.env</span><br><span class="line"></span><br><span class="line"><span class="comment"># If the user has not provided VENV_PATH, we will assume $(pwd)/.venv</span></span><br><span class="line"><span class="keyword">if</span> [ -z <span class="string">&quot;<span class="variable">$&#123;VENV_PATH&#125;</span>&quot;</span> ]; <span class="keyword">then</span></span><br><span class="line">    <span class="comment"># what if we have VIRTUAL_ENV? use that instead</span></span><br><span class="line">    <span class="keyword">if</span> [ -n <span class="string">&quot;<span class="variable">$&#123;VIRTUAL_ENV&#125;</span>&quot;</span> ]; <span class="keyword">then</span></span><br><span class="line">        <span class="built_in">export</span> VENV_PATH=<span class="string">&quot;<span class="variable">$&#123;VIRTUAL_ENV&#125;</span>&quot;</span></span><br><span class="line">    <span class="keyword">else</span></span><br><span class="line">        <span class="built_in">export</span> VENV_PATH=<span class="string">&quot;<span class="subst">$(pwd)</span>/.venv&quot;</span></span><br><span class="line">    <span class="keyword">fi</span></span><br><span class="line"><span class="keyword">fi</span></span><br><span class="line"><span class="keyword">if</span> [ -z <span class="string">&quot;<span class="variable">$&#123;DISABLE_LD_OVERRIDE&#125;</span>&quot;</span> ]; <span class="keyword">then</span></span><br><span class="line">    <span class="built_in">export</span> NVJITLINK_PATH=<span class="string">&quot;<span class="subst">$(find <span class="string">&quot;<span class="variable">$&#123;VENV_PATH&#125;</span>&quot;</span> -name nvjitlink -type d)</span>/lib&quot;</span></span><br><span class="line">    <span class="comment"># if it&#x27;s not empty, we will add it to LD_LIBRARY_PATH at the front:</span></span><br><span class="line">    <span class="keyword">if</span> [ -n <span class="string">&quot;<span class="variable">$&#123;NVJITLINK_PATH&#125;</span>&quot;</span> ]; <span class="keyword">then</span></span><br><span class="line">        <span class="built_in">export</span> LD_LIBRARY_PATH=<span class="string">&quot;<span class="variable">$&#123;NVJITLINK_PATH&#125;</span>:<span class="variable">$&#123;LD_LIBRARY_PATH&#125;</span>&quot;</span></span><br><span class="line">    <span class="keyword">fi</span></span><br><span class="line"><span class="keyword">fi</span></span><br><span class="line"></span><br><span class="line"><span class="built_in">export</span> TOKENIZERS_PARALLELISM=<span class="literal">false</span></span><br><span class="line"><span class="built_in">export</span> PLATFORM</span><br><span class="line">PLATFORM=$(<span class="built_in">uname</span> -s)</span><br><span class="line"><span class="keyword">if</span> [[ <span class="string">&quot;<span class="variable">$PLATFORM</span>&quot;</span> == <span class="string">&quot;Darwin&quot;</span> ]]; <span class="keyword">then</span></span><br><span class="line">    <span class="built_in">export</span> MIXED_PRECISION=<span class="string">&quot;no&quot;</span></span><br><span class="line"><span class="keyword">fi</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> [ -z <span class="string">&quot;<span class="variable">$&#123;ACCELERATE_EXTRA_ARGS&#125;</span>&quot;</span> ]; <span class="keyword">then</span></span><br><span class="line">    ACCELERATE_EXTRA_ARGS=<span class="string">&quot;&quot;</span></span><br><span class="line"><span class="keyword">fi</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> [ -z <span class="string">&quot;<span class="variable">$&#123;TRAINING_NUM_PROCESSES&#125;</span>&quot;</span> ]; <span class="keyword">then</span></span><br><span class="line">    <span class="built_in">echo</span> <span class="string">&quot;Set custom env vars permanently in config/config.env:&quot;</span></span><br><span class="line">    <span class="built_in">printf</span> <span class="string">&quot;TRAINING_NUM_PROCESSES not set, defaulting to 1.\n&quot;</span></span><br><span class="line">    TRAINING_NUM_PROCESSES=1</span><br><span class="line"><span class="keyword">fi</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> [ -z <span class="string">&quot;<span class="variable">$&#123;TRAINING_NUM_MACHINES&#125;</span>&quot;</span> ]; <span class="keyword">then</span></span><br><span class="line">    <span class="built_in">printf</span> <span class="string">&quot;TRAINING_NUM_MACHINES not set, defaulting to 1.\n&quot;</span></span><br><span class="line">    TRAINING_NUM_MACHINES=1</span><br><span class="line"><span class="keyword">fi</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> [ -z <span class="string">&quot;<span class="variable">$&#123;MIXED_PRECISION&#125;</span>&quot;</span> ]; <span class="keyword">then</span></span><br><span class="line">    <span class="built_in">printf</span> <span class="string">&quot;MIXED_PRECISION not set, defaulting to bf16.\n&quot;</span></span><br><span class="line">    MIXED_PRECISION=bf16</span><br><span class="line"><span class="keyword">fi</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> [ -z <span class="string">&quot;<span class="variable">$&#123;TRAINING_DYNAMO_BACKEND&#125;</span>&quot;</span> ]; <span class="keyword">then</span></span><br><span class="line">    <span class="built_in">printf</span> <span class="string">&quot;TRAINING_DYNAMO_BACKEND not set, defaulting to no.\n&quot;</span></span><br><span class="line">    TRAINING_DYNAMO_BACKEND=<span class="string">&quot;no&quot;</span></span><br><span class="line"><span class="keyword">fi</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> [ -z <span class="string">&quot;<span class="variable">$&#123;ENV&#125;</span>&quot;</span> ]; <span class="keyword">then</span></span><br><span class="line">    <span class="built_in">printf</span> <span class="string">&quot;ENV not set, defaulting to default.\n&quot;</span></span><br><span class="line">    <span class="built_in">export</span> ENV=<span class="string">&quot;default&quot;</span></span><br><span class="line"><span class="keyword">fi</span></span><br><span class="line"><span class="built_in">export</span> ENV_PATH=<span class="string">&quot;&quot;</span></span><br><span class="line"><span class="keyword">if</span> [[ <span class="string">&quot;<span class="variable">$ENV</span>&quot;</span> != <span class="string">&quot;default&quot;</span> ]]; <span class="keyword">then</span></span><br><span class="line">    <span class="built_in">export</span> ENV_PATH=<span class="string">&quot;<span class="variable">$&#123;ENV&#125;</span>/&quot;</span></span><br><span class="line"><span class="keyword">fi</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> [ -z <span class="string">&quot;<span class="variable">$&#123;CONFIG_BACKEND&#125;</span>&quot;</span> ]; <span class="keyword">then</span></span><br><span class="line">    <span class="keyword">if</span> [ -n <span class="string">&quot;<span class="variable">$&#123;CONFIG_TYPE&#125;</span>&quot;</span> ]; <span class="keyword">then</span></span><br><span class="line">        <span class="built_in">export</span> CONFIG_BACKEND=<span class="string">&quot;<span class="variable">$&#123;CONFIG_TYPE&#125;</span>&quot;</span></span><br><span class="line">    <span class="keyword">fi</span></span><br><span class="line"><span class="keyword">fi</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> [ -z <span class="string">&quot;<span class="variable">$&#123;CONFIG_BACKEND&#125;</span>&quot;</span> ]; <span class="keyword">then</span></span><br><span class="line">    <span class="built_in">export</span> CONFIG_BACKEND=<span class="string">&quot;env&quot;</span></span><br><span class="line">    <span class="built_in">export</span> CONFIG_PATH=<span class="string">&quot;config/<span class="variable">$&#123;ENV_PATH&#125;</span>config&quot;</span></span><br><span class="line">    <span class="keyword">if</span> [ -f <span class="string">&quot;<span class="variable">$&#123;CONFIG_PATH&#125;</span>.json&quot;</span> ]; <span class="keyword">then</span></span><br><span class="line">        <span class="built_in">export</span> CONFIG_BACKEND=<span class="string">&quot;json&quot;</span></span><br><span class="line">    <span class="keyword">elif</span> [ -f <span class="string">&quot;<span class="variable">$&#123;CONFIG_PATH&#125;</span>.toml&quot;</span> ]; <span class="keyword">then</span></span><br><span class="line">        <span class="built_in">export</span> CONFIG_BACKEND=<span class="string">&quot;toml&quot;</span></span><br><span class="line">    <span class="keyword">elif</span> [ -f <span class="string">&quot;<span class="variable">$&#123;CONFIG_PATH&#125;</span>.env&quot;</span> ]; <span class="keyword">then</span></span><br><span class="line">        <span class="built_in">export</span> CONFIG_BACKEND=<span class="string">&quot;env&quot;</span></span><br><span class="line">    <span class="keyword">fi</span></span><br><span class="line">    <span class="built_in">echo</span> <span class="string">&quot;Using <span class="variable">$&#123;CONFIG_BACKEND&#125;</span> backend: <span class="variable">$&#123;CONFIG_PATH&#125;</span>.<span class="variable">$&#123;CONFIG_BACKEND&#125;</span>&quot;</span></span><br><span class="line"><span class="keyword">fi</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># Update dependencies</span></span><br><span class="line"><span class="keyword">if</span> [ -z <span class="string">&quot;<span class="variable">$&#123;DISABLE_UPDATES&#125;</span>&quot;</span> ]; <span class="keyword">then</span></span><br><span class="line">    <span class="built_in">echo</span> <span class="string">&#x27;Updating dependencies. Set DISABLE_UPDATES to prevent this.&#x27;</span></span><br><span class="line">    <span class="keyword">if</span> [ -f <span class="string">&quot;pyproject.toml&quot;</span> ] &amp;&amp; [ -f <span class="string">&quot;poetry.lock&quot;</span> ]; <span class="keyword">then</span></span><br><span class="line">        nvidia-smi 2&gt; /dev/null &amp;&amp; poetry install</span><br><span class="line">        <span class="built_in">uname</span> -s | grep -q Darwin &amp;&amp; poetry install -C install/apple</span><br><span class="line">        rocm-smi 2&gt; /dev/null &amp;&amp; poetry install -C install/rocm</span><br><span class="line">    <span class="keyword">fi</span></span><br><span class="line"><span class="keyword">fi</span></span><br><span class="line"><span class="comment"># Run the training script.</span></span><br><span class="line"><span class="keyword">if</span> [[ -z <span class="string">&quot;<span class="variable">$&#123;ACCELERATE_CONFIG_PATH&#125;</span>&quot;</span> ]]; <span class="keyword">then</span></span><br><span class="line">    ACCELERATE_CONFIG_PATH=<span class="string">&quot;<span class="variable">$&#123;HOME&#125;</span>/.cache/huggingface/accelerate/default_config.yaml&quot;</span></span><br><span class="line"><span class="keyword">fi</span></span><br><span class="line"><span class="keyword">if</span> [ -f <span class="string">&quot;<span class="variable">$&#123;ACCELERATE_CONFIG_PATH&#125;</span>&quot;</span> ]; <span class="keyword">then</span></span><br><span class="line">    <span class="built_in">echo</span> <span class="string">&quot;Using Accelerate config file: <span class="variable">$&#123;ACCELERATE_CONFIG_PATH&#125;</span>&quot;</span></span><br><span class="line">    accelerate launch --config_file=<span class="string">&quot;<span class="variable">$&#123;ACCELERATE_CONFIG_PATH&#125;</span>&quot;</span> train.py</span><br><span class="line"><span class="keyword">else</span></span><br><span class="line">    <span class="built_in">echo</span> <span class="string">&quot;Accelerate config file not found: <span class="variable">$&#123;ACCELERATE_CONFIG_PATH&#125;</span>. Using values from config.env.&quot;</span></span><br><span class="line">    accelerate launch <span class="variable">$&#123;ACCELERATE_EXTRA_ARGS&#125;</span> --mixed_precision=<span class="string">&quot;<span class="variable">$&#123;MIXED_PRECISION&#125;</span>&quot;</span> --num_processes=<span class="string">&quot;<span class="variable">$&#123;TRAINING_NUM_PROCESSES&#125;</span>&quot;</span> --num_machines=<span class="string">&quot;<span class="variable">$&#123;TRAINING_NUM_MACHINES&#125;</span>&quot;</span> --dynamo_backend=<span class="string">&quot;<span class="variable">$&#123;TRAINING_DYNAMO_BACKEND&#125;</span>&quot;</span> train.py</span><br><span class="line"></span><br><span class="line"><span class="keyword">fi</span></span><br><span class="line"></span><br><span class="line"><span class="built_in">exit</span> 0</span><br></pre></td></tr></table></figure></li>
</ul>
<p>ì´ê²ƒì´ ì¼ë°˜ì ì¸ íë¦„ì…ë‹ˆë‹¤.</p>
<p>ì²˜ìŒì—ëŠ” <code>SimpleTuner/config</code> ë””ë ‰í† ë¦¬ì—ì„œ <code>config.env</code>ë¥¼ ì†ŒìŠ¤ë¡œ ì‚¬ìš©í•©ë‹ˆë‹¤. ì´ëŠ” <code>gpus</code> ìˆ˜ì™€ ê°™ì€ ì¤‘ìš”í•œ ì„¤ì •ì´ í¬í•¨ëœ ìƒìœ„ ìˆ˜ì¤€ <code>config.env</code>ê°€ ìˆê³  ë³´ë‹¤ ì„¸ë¶€ì ì¸ ì„¤ì •ì´ í¬í•¨ëœ <code>config.json</code> ë˜ëŠ” <code>config.env</code>ì™€ ê°™ì€ í•˜ìœ„ ìˆ˜ì¤€ êµ¬ì„±ì´ ìˆê¸° ë•Œë¬¸ì— í˜¼ë€ìŠ¤ëŸ½ìŠµë‹ˆë‹¤. ì„¤ì •(ì˜ˆ: <code>model_family</code>, <code>learning_rate</code> ë“±).</p>
<p>ê·¸ëŸ¬ë‚˜ ì €ì¥ì†Œë¥¼ <code>git clone</code>í•˜ë©´ <code>config.env</code> íŒŒì¼ì´ í‘œì‹œë˜ì§€ ì•ŠìŠµë‹ˆë‹¤.</p>
<p>ë‚´ í…ŒìŠ¤íŠ¸ì—ì„œëŠ” ì‹¤ì œë¡œ <a target="_blank" rel="external nofollow noopener noreferrer" href="https://github.com/bghira/SimpleTuner/blob/main/INSTALL.md">INSTALL.MD</a>ì— ë”°ë¼ ìƒìœ„ ìˆ˜ì¤€ <code>config.env</code>ë¥¼ ìƒì„±í•  í•„ìš”ê°€ ì—†ìŠµë‹ˆë‹¤. , í•˜ì§€ë§Œ <code>config</code> í´ë” ë‚´ì—ì„œ í´ë”ë¥¼ ë™ì ìœ¼ë¡œ ì „í™˜í•˜ëŠ” ë° ë„ì›€ì´ ë˜ë¯€ë¡œ ê·¸ë ‡ê²Œ í•˜ëŠ” ê²ƒì´ ì¢‹ìŠµë‹ˆë‹¤.</p>
<p><code>config</code> ë””ë ‰í„°ë¦¬ì— <code>config.env</code> íŒŒì¼ì„ ë§Œë“­ë‹ˆë‹¤.</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">vim SimpleTuner/config/config.env</span><br></pre></td></tr></table></figure>

<ul>
<li><p>High-level <code>config.env</code></p>
  <figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">TRAINING_NUM_PROCESSES=1</span><br><span class="line">TRAINING_NUM_MACHINES=1</span><br><span class="line">TRAINING_DYNAMO_BACKEND=<span class="string">&#x27;no&#x27;</span></span><br><span class="line">MIXED_PRECISION=<span class="string">&#x27;bf16&#x27;</span></span><br><span class="line"><span class="built_in">export</span> CONFIG_BACKEND=<span class="string">&quot;json&quot;</span></span><br><span class="line"><span class="built_in">export</span> ENV=<span class="string">&quot;default&quot;</span></span><br></pre></td></tr></table></figure></li>
</ul>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">bash train.sh</span><br></pre></td></tr></table></figure>


<p><code>SimpleTuner</code>ëŠ” <code>ENV</code> ë””ë ‰í† ë¦¬ ë‚´ì—ì„œ <code>config</code> ë””ë ‰í† ë¦¬ì¸ <code>config.json</code>ì„ ê²€ìƒ‰í•©ë‹ˆë‹¤. ê·¸ ì´ìœ ëŠ” ë§ˆìŠ¤í„° <code>config.env</code> íŒŒì¼ì—ì„œ <code>ENV</code>ê°€ <code>default</code>ë¡œ ì„¤ì •ë˜ì–´ ìˆê¸° ë•Œë¬¸ì…ë‹ˆë‹¤. ì´ëŠ” <code>SimpleTuner/config</code>ë¥¼ ì˜ë¯¸í•©ë‹ˆë‹¤.</p>
<p>â€˜config.jsonâ€™ì„ ì°¾ëŠ” ì´ìœ ê°€ ë¬´ì—‡ì¸ì§€ ë¬¼ì–´ë³¼ ìˆ˜ë„ ìˆìŠµë‹ˆë‹¤. ìŒ, <a target="_blank" rel="external nofollow noopener noreferrer" href="http://train.sh/"><code>train.sh</code></a> íŒŒì¼ì—ì„œ ì´ ì½”ë“œ ë¸”ë¡ì„ ë³´ë©´, <code>CONFIG_BACKEND</code>ë¡œ ì§€ì •í•œ ë‚´ìš©ì— ë”°ë¼ ì´ íŒŒì¼ì„ ì°¾ëŠ”ë‹¤ëŠ” ê²ƒì„ ì•Œ ìˆ˜ ìˆìŠµë‹ˆë‹¤. ë§ˆìŠ¤í„° <code>config.env</code> íŒŒì¼:</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">if</span> [ -z <span class="string">&quot;<span class="variable">$&#123;CONFIG_BACKEND&#125;</span>&quot;</span> ]; <span class="keyword">then</span></span><br><span class="line">    <span class="built_in">export</span> CONFIG_BACKEND=<span class="string">&quot;env&quot;</span></span><br><span class="line">    <span class="built_in">export</span> CONFIG_PATH=<span class="string">&quot;config/<span class="variable">$&#123;ENV_PATH&#125;</span>config&quot;</span></span><br><span class="line">    <span class="keyword">if</span> [ -f <span class="string">&quot;<span class="variable">$&#123;CONFIG_PATH&#125;</span>.json&quot;</span> ]; <span class="keyword">then</span></span><br><span class="line">        <span class="built_in">export</span> CONFIG_BACKEND=<span class="string">&quot;json&quot;</span></span><br><span class="line">    <span class="keyword">elif</span> [ -f <span class="string">&quot;<span class="variable">$&#123;CONFIG_PATH&#125;</span>.toml&quot;</span> ]; <span class="keyword">then</span></span><br><span class="line">        <span class="built_in">export</span> CONFIG_BACKEND=<span class="string">&quot;toml&quot;</span></span><br><span class="line">    <span class="keyword">elif</span> [ -f <span class="string">&quot;<span class="variable">$&#123;CONFIG_PATH&#125;</span>.env&quot;</span> ]; <span class="keyword">then</span></span><br><span class="line">        <span class="built_in">export</span> CONFIG_BACKEND=<span class="string">&quot;env&quot;</span></span><br><span class="line">    <span class="keyword">fi</span></span><br><span class="line">    <span class="built_in">echo</span> <span class="string">&quot;Using <span class="variable">$&#123;CONFIG_BACKEND&#125;</span> backend: <span class="variable">$&#123;CONFIG_PATH&#125;</span>.<span class="variable">$&#123;CONFIG_BACKEND&#125;</span>&quot;</span></span><br><span class="line"><span class="keyword">fi</span></span><br></pre></td></tr></table></figure>


<p><code>config.*</code>ì˜ ì´ë¦„ì„ ë³€ê²½í•  ìˆ˜ ìˆëŠ”ì§€ ê¶ê¸ˆí•˜ì‹¤ ìˆ˜ë„ ìˆìŠµë‹ˆë‹¤. <code>config_fantasy_art_lora_01.*</code>ë¥¼ ì‚¬ìš©í•  ìˆ˜ ìˆë‚˜ìš”? <code>config_fantasy_art_full_01.*</code>ì€ ì–´ë–»ìŠµë‹ˆê¹Œ?</p>
<p>ì•ˆíƒ€ê¹ê²Œë„ ê·¸ëŸ´ ìˆ˜ ì—†ëŠ” ê²ƒ ê°™ìŠµë‹ˆë‹¤. <code>train.sh</code> íŒŒì¼ì—ì„œ <code>config.*</code>ì˜ ì´ë¦„ì„ ë³€ê²½í•˜ë”ë¼ë„ <a target="_blank" rel="external nofollow noopener noreferrer" href="https://github.com/bghira/SimpleTuner/blob/main/helpers/configuration/loader">loader.py</a> .py#L17) êµ¬ì„± ë„ìš°ë¯¸ì˜ ì½”ë“œëŠ” ê¸°ë³¸ì ìœ¼ë¡œ ë‹¤ìŒ ê°’ìœ¼ë¡œ ì„¤ì •ë©ë‹ˆë‹¤.</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">default_config_paths = &#123;</span><br><span class="line">    <span class="string">&quot;json&quot;</span>: <span class="string">&quot;config.json&quot;</span>,</span><br><span class="line">    <span class="string">&quot;toml&quot;</span>: <span class="string">&quot;config.toml&quot;</span>,</span><br><span class="line">    <span class="string">&quot;env&quot;</span>: <span class="string">&quot;config.env&quot;</span>,</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>ë”°ë¼ì„œ ì„¸ë¶€ í›ˆë ¨ ë§¤ê°œë³€ìˆ˜ ì„¤ì •ìœ¼ë¡œ í•˜ìœ„ ìˆ˜ì¤€ <code>config.*</code> íŒŒì¼ì„ êµ¬ë³„í•˜ê³  <a target="_blank" rel="external nofollow noopener noreferrer" href="https://github.com/bghira/SimpleTuner/blob">loader.py</a>ë¥¼ ìˆ˜ì •í•˜ê³  ì‹¶ì§€ ì•Šì€ ê²½ìš° &#x2F;main&#x2F;helpers&#x2F;configuration&#x2F;loader.py#L17) ì½”ë“œë¥¼ ì‚¬ìš©í•˜ëŠ” ê²½ìš° í›ˆë ¨ì— í•´ë‹¹í•˜ëŠ” <code>SimpleTuner/config</code> ë””ë ‰í† ë¦¬ ë‚´ì— í´ë”ë¥¼ ìƒì„±í•˜ëŠ” ê²ƒì´ ì¢‹ìŠµë‹ˆë‹¤. ë‚˜ë„ ë˜‘ê°™ì´ í•  ê²ƒì´ë‹¤.</p>
<p><code>SimpleTuner/config</code> ì•ˆì— ì²« ë²ˆì§¸ í›ˆë ¨ì„ ìœ„í•œ ë””ë ‰í† ë¦¬ë¥¼ ìƒì„±í•´ ë³´ê² ìŠµë‹ˆë‹¤.</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">mkdir</span> SimpleTuner/config/sd35_fantasy_art_lora</span><br></pre></td></tr></table></figure>

<p>ì´ì œ <code>SimpleTuner/config/config.env</code>ì—ì„œ ìƒìœ„ ìˆ˜ì¤€ <code>config.env</code>ë¥¼ ë‹¤ìŒê³¼ ê°™ì´ ìˆ˜ì •í•˜ê² ìŠµë‹ˆë‹¤.</p>
<ul>
<li><p>High-level <code>config.env</code></p>
  <figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">TRAINING_NUM_PROCESSES=1</span><br><span class="line">TRAINING_NUM_MACHINES=1</span><br><span class="line">TRAINING_DYNAMO_BACKEND=<span class="string">&#x27;no&#x27;</span></span><br><span class="line">MIXED_PRECISION=<span class="string">&#x27;bf16&#x27;</span></span><br><span class="line"><span class="built_in">export</span> CONFIG_BACKEND=<span class="string">&quot;json&quot;</span></span><br><span class="line"><span class="built_in">export</span> ENV=<span class="string">&quot;sd35_fantasy_art_lora&quot;</span></span><br></pre></td></tr></table></figure></li>
</ul>
<p>í›ˆë ¨ì´ ì‹œì‘ë˜ë©´ ë¨¼ì € <code>SimpleTuner/config/config.env</code>ì—ì„œ ë§ˆìŠ¤í„° <code>config.env</code>ë¥¼ ì†Œì‹±í•œ ë‹¤ìŒ <code>SimpleTuner/config/sd35_fantasy_art_lora</code>ì—ì„œ í•´ë‹¹ <code>config.$&#123;CONFIG_BACKEND&#125;</code> íŒŒì¼ì„ ì°¾ìŠµë‹ˆë‹¤. ì´ ê²½ìš° <code>config.json</code> ì…ë‹ˆë‹¤.</p>
<p>ì´ë¥¼ ì´í•´í•˜ë©´ ë‹¤ì–‘í•œ ëª¨ë¸ì— ëŒ€í•œ ë‹¤ì–‘í•œ â€˜configâ€™ í•™ìŠµ ë§¤ê°œë³€ìˆ˜ë¥¼ ê´€ë¦¬í•˜ëŠ” ê²ƒì´ ë§¤ìš° ì‰¬ì›Œì§€ë¯€ë¡œ í•™ìŠµ íë¦„ì´ ëª…í™•í•´ì§€ê¸°ë¥¼ ë°”ëë‹ˆë‹¤.</p>
<p>ì´ì œ í•˜ìœ„ ìˆ˜ì¤€ <code>config.*</code> íŒŒì¼ë¡œ ì´ë™í•˜ê² ìŠµë‹ˆë‹¤.</p>
<h3 id="Configuration-setup-low-level"><a href="#Configuration-setup-low-level" class="headerlink" title="Configuration setup (low-level)"></a>Configuration setup (low-level)</h3><p><code>SimpleTuner/config/</code> ë””ë ‰í† ë¦¬ì—ëŠ” <code>bghira</code>ì—ì„œ ì œê³µí•˜ëŠ” ê¸°ë³¸ <code>config.json.example</code>ì´ ìˆìŠµë‹ˆë‹¤.</p>
<p>ìì„¸í•œ ë‚´ìš©ì„ ì•Œê³  ì‹¶ì§€ ì•Šë‹¤ë©´ ë‚´ ë§ì¶¤ <code>config.json</code> ì‚¬ìš©ìœ¼ë¡œ ê±´ë„ˆë›°ì„¸ìš”.</p>
<ul>
<li><p>ë§ì¶¤í˜• SD3.5 ëŒ€í˜• <code>LoRA</code> <code>config.json</code></p>
  <figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br></pre></td><td class="code"><pre><span class="line"><span class="punctuation">&#123;</span></span><br><span class="line">  <span class="attr">&quot;--model_type&quot;</span><span class="punctuation">:</span> <span class="string">&quot;lora&quot;</span><span class="punctuation">,</span></span><br><span class="line">  <span class="attr">&quot;--model_family&quot;</span><span class="punctuation">:</span> <span class="string">&quot;sd3&quot;</span><span class="punctuation">,</span></span><br><span class="line">  <span class="attr">&quot;--resume_from_checkpoint&quot;</span><span class="punctuation">:</span> <span class="string">&quot;latest&quot;</span><span class="punctuation">,</span></span><br><span class="line">  <span class="attr">&quot;--checkpointing_steps&quot;</span><span class="punctuation">:</span> <span class="number">400</span><span class="punctuation">,</span></span><br><span class="line">  <span class="attr">&quot;--checkpoints_total_limit&quot;</span><span class="punctuation">:</span> <span class="number">60</span><span class="punctuation">,</span></span><br><span class="line">  <span class="attr">&quot;--learning_rate&quot;</span><span class="punctuation">:</span> <span class="number">1.05e-3</span><span class="punctuation">,</span></span><br><span class="line">  <span class="attr">&quot;--pretrained_model_name_or_path&quot;</span><span class="punctuation">:</span> <span class="string">&quot;stabilityai/stable-diffusion-3.5-large&quot;</span><span class="punctuation">,</span></span><br><span class="line">  <span class="attr">&quot;--report_to&quot;</span><span class="punctuation">:</span> <span class="string">&quot;wandb&quot;</span><span class="punctuation">,</span></span><br><span class="line">  <span class="attr">&quot;--tracker_project_name&quot;</span><span class="punctuation">:</span> <span class="string">&quot;sd35-training&quot;</span><span class="punctuation">,</span></span><br><span class="line">  <span class="attr">&quot;--tracker_run_name&quot;</span><span class="punctuation">:</span> <span class="string">&quot;simpletuner-fantasy-art-lora-01&quot;</span><span class="punctuation">,</span></span><br><span class="line">  <span class="attr">&quot;--max_train_steps&quot;</span><span class="punctuation">:</span> <span class="number">24000</span><span class="punctuation">,</span></span><br><span class="line">  <span class="attr">&quot;--num_train_epochs&quot;</span><span class="punctuation">:</span> <span class="number">0</span><span class="punctuation">,</span></span><br><span class="line">  <span class="attr">&quot;--data_backend_config&quot;</span><span class="punctuation">:</span> <span class="string">&quot;/weka2/home-yeo/simpletuner_models/sd3_large/full_finetune/fantasy_art_L_01/datasets/multidatabackend.json&quot;</span><span class="punctuation">,</span></span><br><span class="line">  <span class="attr">&quot;--output_dir&quot;</span><span class="punctuation">:</span> <span class="string">&quot;/weka2/home-yeo/simpletuner_models/sd3_large/full_finetune/fantasy_art_L_01/datasets/models&quot;</span><span class="punctuation">,</span></span><br><span class="line">  <span class="attr">&quot;--push_to_hub&quot;</span><span class="punctuation">:</span> <span class="keyword">false</span><span class="punctuation">,</span></span><br><span class="line">  <span class="attr">&quot;--push_checkpoints_to_hub&quot;</span><span class="punctuation">:</span> <span class="keyword">true</span><span class="punctuation">,</span></span><br><span class="line">  <span class="attr">&quot;--hub_model_id&quot;</span><span class="punctuation">:</span> <span class="string">&quot;sd35-training&quot;</span><span class="punctuation">,</span></span><br><span class="line">  <span class="attr">&quot;--resolution&quot;</span><span class="punctuation">:</span> <span class="number">1024</span><span class="punctuation">,</span></span><br><span class="line">  <span class="attr">&quot;--resolution_type&quot;</span><span class="punctuation">:</span> <span class="string">&quot;pixel&quot;</span><span class="punctuation">,</span></span><br><span class="line">  <span class="attr">&quot;--minimum_image_size&quot;</span><span class="punctuation">:</span> <span class="number">1024</span><span class="punctuation">,</span></span><br><span class="line">  <span class="attr">&quot;--instance_prompt&quot;</span><span class="punctuation">:</span> <span class="string">&quot;k4s4 &quot;</span><span class="punctuation">,</span></span><br><span class="line">  <span class="attr">&quot;--validation_prompt&quot;</span><span class="punctuation">:</span> <span class="string">&quot;k4s4, a waist up view of a beautiful female blonde woman, green eyes&quot;</span><span class="punctuation">,</span></span><br><span class="line">  <span class="attr">&quot;--validation_guidance&quot;</span><span class="punctuation">:</span> <span class="number">7.5</span><span class="punctuation">,</span></span><br><span class="line">  <span class="attr">&quot;--validation_guidance_rescale&quot;</span><span class="punctuation">:</span> <span class="number">0.0</span><span class="punctuation">,</span></span><br><span class="line">  <span class="attr">&quot;--validation_steps&quot;</span><span class="punctuation">:</span> <span class="number">200</span><span class="punctuation">,</span></span><br><span class="line">  <span class="attr">&quot;--validation_num_inference_steps&quot;</span><span class="punctuation">:</span> <span class="number">30</span><span class="punctuation">,</span></span><br><span class="line">  <span class="attr">&quot;--validation_negative_prompt&quot;</span><span class="punctuation">:</span> <span class="string">&quot;blurry, cropped, ugly&quot;</span><span class="punctuation">,</span></span><br><span class="line">  <span class="attr">&quot;--validation_seed&quot;</span><span class="punctuation">:</span> <span class="number">42</span><span class="punctuation">,</span></span><br><span class="line">  <span class="attr">&quot;--validation_resolution&quot;</span><span class="punctuation">:</span> <span class="number">1024</span><span class="punctuation">,</span></span><br><span class="line">  <span class="attr">&quot;--train_batch_size&quot;</span><span class="punctuation">:</span> <span class="number">6</span><span class="punctuation">,</span></span><br><span class="line">  <span class="attr">&quot;--gradient_accumulation_steps&quot;</span><span class="punctuation">:</span> <span class="number">1</span><span class="punctuation">,</span></span><br><span class="line">  <span class="attr">&quot;--lr_scheduler&quot;</span><span class="punctuation">:</span> <span class="string">&quot;cosine&quot;</span><span class="punctuation">,</span></span><br><span class="line">  <span class="attr">&quot;--lr_warmup_steps&quot;</span><span class="punctuation">:</span> <span class="number">2400</span><span class="punctuation">,</span></span><br><span class="line">  <span class="attr">&quot;--caption_dropout_probability&quot;</span><span class="punctuation">:</span> <span class="number">0</span><span class="punctuation">,</span></span><br><span class="line">  <span class="attr">&quot;--metadata_update_interval&quot;</span><span class="punctuation">:</span> <span class="number">65</span><span class="punctuation">,</span></span><br><span class="line">  <span class="attr">&quot;--vae_batch_size&quot;</span><span class="punctuation">:</span> <span class="number">12</span><span class="punctuation">,</span></span><br><span class="line">  <span class="attr">&quot;--delete_unwanted_images&quot;</span><span class="punctuation">:</span> <span class="keyword">false</span><span class="punctuation">,</span></span><br><span class="line">  <span class="attr">&quot;--delete_problematic_images&quot;</span><span class="punctuation">:</span> <span class="keyword">false</span><span class="punctuation">,</span></span><br><span class="line">  <span class="attr">&quot;--training_scheduler_timestep_spacing&quot;</span><span class="punctuation">:</span> <span class="string">&quot;trailing&quot;</span><span class="punctuation">,</span></span><br><span class="line">  <span class="attr">&quot;--inference_scheduler_timestep_spacing&quot;</span><span class="punctuation">:</span> <span class="string">&quot;trailing&quot;</span><span class="punctuation">,</span></span><br><span class="line">  <span class="attr">&quot;--snr_gamma&quot;</span><span class="punctuation">:</span> <span class="number">5</span><span class="punctuation">,</span></span><br><span class="line">  <span class="attr">&quot;--enable_xformers_memory_efficient_attention&quot;</span><span class="punctuation">:</span> <span class="keyword">true</span><span class="punctuation">,</span></span><br><span class="line">  <span class="attr">&quot;--gradient_checkpointing&quot;</span><span class="punctuation">:</span> <span class="keyword">true</span><span class="punctuation">,</span></span><br><span class="line">  <span class="attr">&quot;--allow_tf32&quot;</span><span class="punctuation">:</span> <span class="keyword">true</span><span class="punctuation">,</span></span><br><span class="line">  <span class="attr">&quot;--optimizer&quot;</span><span class="punctuation">:</span> <span class="string">&quot;adamw_bf16&quot;</span><span class="punctuation">,</span></span><br><span class="line">  <span class="attr">&quot;--use_ema&quot;</span><span class="punctuation">:</span> <span class="keyword">false</span><span class="punctuation">,</span></span><br><span class="line">  <span class="attr">&quot;--ema_decay&quot;</span><span class="punctuation">:</span> <span class="number">0.999</span><span class="punctuation">,</span></span><br><span class="line">  <span class="attr">&quot;--seed&quot;</span><span class="punctuation">:</span> <span class="number">42</span><span class="punctuation">,</span></span><br><span class="line">  <span class="attr">&quot;--mixed_precision&quot;</span><span class="punctuation">:</span> <span class="string">&quot;bf16&quot;</span><span class="punctuation">,</span></span><br><span class="line">  <span class="attr">&quot;--lora_rank&quot;</span><span class="punctuation">:</span> <span class="number">768</span><span class="punctuation">,</span></span><br><span class="line">  <span class="attr">&quot;--lora_alpha&quot;</span><span class="punctuation">:</span> <span class="number">768</span><span class="punctuation">,</span></span><br><span class="line">  <span class="attr">&quot;--lora_type&quot;</span><span class="punctuation">:</span> <span class="string">&quot;standard&quot;</span></span><br><span class="line"><span class="punctuation">&#125;</span></span><br></pre></td></tr></table></figure></li>
</ul>
<p>ìì„¸í•œ ë‚´ìš©ì„ ì•Œê³  ì‹¶ë‹¤ë©´ ê³„ì† ì½ì–´ë³´ì„¸ìš”.</p>
<p><code>SimpleTuner</code> ë£¨íŠ¸ì— ìˆëŠ” <code>config</code> íŒŒì¼ì„ <code>ENV</code> ë””ë ‰í„°ë¦¬ì— ë³µì‚¬í•˜ì—¬ ì‹œì‘í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤. ì´ê²ƒì´ ë‚´ ëª…ë ¹ì´ë‹¤.</p>
<figure class="highlight jsx"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">cp config/config.<span class="property">json</span>.<span class="property">example</span> config/sd35_fantasy_art_lora/config.<span class="property">json</span></span><br></pre></td></tr></table></figure>

<p>ì¼ë‹¨ ì—´ë©´ <code>json</code> íŒŒì¼ì€ ë‹¤ìŒê³¼ ê°™ìŠµë‹ˆë‹¤:</p>
<ul>
<li><p><code>config.json.example</code></p>
  <figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br></pre></td><td class="code"><pre><span class="line"><span class="punctuation">&#123;</span></span><br><span class="line">    <span class="attr">&quot;--resume_from_checkpoint&quot;</span><span class="punctuation">:</span> <span class="string">&quot;latest&quot;</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;--data_backend_config&quot;</span><span class="punctuation">:</span> <span class="string">&quot;config/multidatabackend.json&quot;</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;--aspect_bucket_rounding&quot;</span><span class="punctuation">:</span> <span class="number">2</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;--seed&quot;</span><span class="punctuation">:</span> <span class="number">42</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;--minimum_image_size&quot;</span><span class="punctuation">:</span> <span class="number">0</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;--output_dir&quot;</span><span class="punctuation">:</span> <span class="string">&quot;output/models&quot;</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;--lora_type&quot;</span><span class="punctuation">:</span> <span class="string">&quot;lycoris&quot;</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;--lycoris_config&quot;</span><span class="punctuation">:</span> <span class="string">&quot;config/lycoris_config.json&quot;</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;--max_train_steps&quot;</span><span class="punctuation">:</span> <span class="number">10000</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;--num_train_epochs&quot;</span><span class="punctuation">:</span> <span class="number">0</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;--checkpointing_steps&quot;</span><span class="punctuation">:</span> <span class="number">500</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;--checkpoints_total_limit&quot;</span><span class="punctuation">:</span> <span class="number">5</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;--hub_model_id&quot;</span><span class="punctuation">:</span> <span class="string">&quot;simpletuner-lora&quot;</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;--push_to_hub&quot;</span><span class="punctuation">:</span> <span class="string">&quot;true&quot;</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;--push_checkpoints_to_hub&quot;</span><span class="punctuation">:</span> <span class="string">&quot;true&quot;</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;--tracker_project_name&quot;</span><span class="punctuation">:</span> <span class="string">&quot;lora-training&quot;</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;--tracker_run_name&quot;</span><span class="punctuation">:</span> <span class="string">&quot;simpletuner-lora&quot;</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;--report_to&quot;</span><span class="punctuation">:</span> <span class="string">&quot;wandb&quot;</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;--model_type&quot;</span><span class="punctuation">:</span> <span class="string">&quot;lora&quot;</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;--pretrained_model_name_or_path&quot;</span><span class="punctuation">:</span> <span class="string">&quot;stabilityai/stable-diffusion-3.5-large&quot;</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;--model_family&quot;</span><span class="punctuation">:</span> <span class="string">&quot;sd3&quot;</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;--train_batch_size&quot;</span><span class="punctuation">:</span> <span class="number">1</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;--gradient_checkpointing&quot;</span><span class="punctuation">:</span> <span class="string">&quot;true&quot;</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;--caption_dropout_probability&quot;</span><span class="punctuation">:</span> <span class="number">0.1</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;--resolution_type&quot;</span><span class="punctuation">:</span> <span class="string">&quot;pixel_area&quot;</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;--resolution&quot;</span><span class="punctuation">:</span> <span class="number">1024</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;--validation_seed&quot;</span><span class="punctuation">:</span> <span class="number">42</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;--validation_steps&quot;</span><span class="punctuation">:</span> <span class="number">500</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;--validation_resolution&quot;</span><span class="punctuation">:</span> <span class="string">&quot;1024x1024&quot;</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;--validation_guidance&quot;</span><span class="punctuation">:</span> <span class="number">3.0</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;--validation_guidance_rescale&quot;</span><span class="punctuation">:</span> <span class="string">&quot;0.0&quot;</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;--validation_num_inference_steps&quot;</span><span class="punctuation">:</span> <span class="string">&quot;20&quot;</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;--validation_prompt&quot;</span><span class="punctuation">:</span> <span class="string">&quot;A photo-realistic image of a cat&quot;</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;--mixed_precision&quot;</span><span class="punctuation">:</span> <span class="string">&quot;bf16&quot;</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;--optimizer&quot;</span><span class="punctuation">:</span> <span class="string">&quot;adamw_bf16&quot;</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;--learning_rate&quot;</span><span class="punctuation">:</span> <span class="string">&quot;1e-4&quot;</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;--lr_scheduler&quot;</span><span class="punctuation">:</span> <span class="string">&quot;polynomial&quot;</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;--lr_warmup_steps&quot;</span><span class="punctuation">:</span> <span class="number">100</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;--validation_torch_compile&quot;</span><span class="punctuation">:</span> <span class="string">&quot;false&quot;</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;--disable_benchmark&quot;</span><span class="punctuation">:</span> <span class="string">&quot;false&quot;</span></span><br><span class="line"><span class="punctuation">&#125;</span></span><br></pre></td></tr></table></figure></li>
</ul>
<p>ì›í•˜ì‹ ë‹¤ë©´ ì´ ì œí’ˆì„ ì¦‰ì‹œ ì‚¬ìš©í•˜ì‹¤ ìˆ˜ ìˆìŠµë‹ˆë‹¤. ê·¸ëŸ¬ë‚˜ ì œê³µëœ <code>json</code>ì—ëŠ” <a target="_blank" rel="external nofollow noopener noreferrer" href="https://github.com/bghira/SimpleTuner/blob/main/OPTIONS.md#environment-configuration-variables">OPTIONS.MD</a>ì˜ ë‹¤ë¥¸ ë§¤ê°œë³€ìˆ˜ê°€ ë§ì´ ë¶€ì¡±í•©ë‹ˆë‹¤. <a target="_blank" rel="external nofollow noopener noreferrer" href="https://github.com/bghira/SimpleTuner/blob/main/configure.py">configure.py</a>ë¥¼ ì‚¬ìš©í•˜ë”ë¼ë„ ê²°êµ­ ë‹¤ìŒê³¼ ê°™ì€ <code>config.json</code> íŒŒì¼ì´ ìƒì„±ë©ë‹ˆë‹¤.</p>
<ul>
<li><p><code>configure.py</code>ë¡œ ìƒì„±ëœ ìƒ˜í”Œ <code>.json</code>(ì°¸ì¡°ë¡œ ì‚¬ìš©ë¨)</p>
  <figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br></pre></td><td class="code"><pre><span class="line"><span class="punctuation">&#123;</span></span><br><span class="line">    <span class="attr">&quot;--resume_from_checkpoint&quot;</span><span class="punctuation">:</span> <span class="string">&quot;latest&quot;</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;--data_backend_config&quot;</span><span class="punctuation">:</span> <span class="string">&quot;config/multidatabackend.json&quot;</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;--aspect_bucket_rounding&quot;</span><span class="punctuation">:</span> <span class="number">2</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;--seed&quot;</span><span class="punctuation">:</span> <span class="number">42</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;--minimum_image_size&quot;</span><span class="punctuation">:</span> <span class="number">0</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;--disable_benchmark&quot;</span><span class="punctuation">:</span> <span class="keyword">false</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;--output_dir&quot;</span><span class="punctuation">:</span> <span class="string">&quot;/weka2/home-yeo/simpletuner_models/sd3_large/full_finetune/fantasy_art_L_01/datasets/&quot;</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;--lora_type&quot;</span><span class="punctuation">:</span> <span class="string">&quot;standard&quot;</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;--lora_rank&quot;</span><span class="punctuation">:</span> <span class="number">256</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;--max_train_steps&quot;</span><span class="punctuation">:</span> <span class="number">24000</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;--num_train_epochs&quot;</span><span class="punctuation">:</span> <span class="number">0</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;--checkpointing_steps&quot;</span><span class="punctuation">:</span> <span class="number">400</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;--checkpoints_total_limit&quot;</span><span class="punctuation">:</span> <span class="number">60</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;--tracker_project_name&quot;</span><span class="punctuation">:</span> <span class="string">&quot;sd35-training&quot;</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;--tracker_run_name&quot;</span><span class="punctuation">:</span> <span class="string">&quot;simpletuner-sd35-large-fantasy-art-01&quot;</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;--report_to&quot;</span><span class="punctuation">:</span> <span class="string">&quot;wandb&quot;</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;--model_type&quot;</span><span class="punctuation">:</span> <span class="string">&quot;lora&quot;</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;--pretrained_model_name_or_path&quot;</span><span class="punctuation">:</span> <span class="string">&quot;stabilityai/stable-diffusion-3-medium-diffusers&quot;</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;--model_family&quot;</span><span class="punctuation">:</span> <span class="string">&quot;sd3&quot;</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;--train_batch_size&quot;</span><span class="punctuation">:</span> <span class="number">6</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;--gradient_checkpointing&quot;</span><span class="punctuation">:</span> <span class="string">&quot;true&quot;</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;--caption_dropout_probability&quot;</span><span class="punctuation">:</span> <span class="number">0.0</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;--resolution_type&quot;</span><span class="punctuation">:</span> <span class="string">&quot;pixel_area&quot;</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;--resolution&quot;</span><span class="punctuation">:</span> <span class="string">&quot;1024&quot;</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;--validation_seed&quot;</span><span class="punctuation">:</span> <span class="string">&quot;42&quot;</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;--validation_steps&quot;</span><span class="punctuation">:</span> <span class="string">&quot;200&quot;</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;--validation_resolution&quot;</span><span class="punctuation">:</span> <span class="string">&quot;1024x1024&quot;</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;--validation_guidance&quot;</span><span class="punctuation">:</span> <span class="string">&quot;7.5&quot;</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;--validation_guidance_rescale&quot;</span><span class="punctuation">:</span> <span class="string">&quot;0.0&quot;</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;--validation_num_inference_steps&quot;</span><span class="punctuation">:</span> <span class="string">&quot;35&quot;</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;--validation_prompt&quot;</span><span class="punctuation">:</span> <span class="string">&quot;k4s4, a waist up view of a beautiful female blonde woman, green eyes&quot;</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;--mixed_precision&quot;</span><span class="punctuation">:</span> <span class="string">&quot;bf16&quot;</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;--optimizer&quot;</span><span class="punctuation">:</span> <span class="string">&quot;adamw_bf16&quot;</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;--learning_rate&quot;</span><span class="punctuation">:</span> <span class="string">&quot;1.05e-3&quot;</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;--lr_scheduler&quot;</span><span class="punctuation">:</span> <span class="string">&quot;polynomial&quot;</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;--lr_warmup_steps&quot;</span><span class="punctuation">:</span> <span class="string">&quot;2400&quot;</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;--validation_torch_compile&quot;</span><span class="punctuation">:</span> <span class="string">&quot;false&quot;</span></span><br><span class="line"><span class="punctuation">&#125;</span></span><br></pre></td></tr></table></figure></li>
</ul>
<p><a target="_blank" rel="external nofollow noopener noreferrer" href="https://github.com/bghira/SimpleTuner/blob/main/configure.py">configure.py</a>ëŠ” <code>lora_rank</code>ì™€ ê°™ì€ ì¼ë¶€ ë§¤ê°œë³€ìˆ˜ë¥¼ ì œí•œí•  ë¿ë§Œ ì•„ë‹ˆë¼ ìœ íš¨ì„± ê²€ì‚¬ ì¤‘ì— ë¶€ì •ì ì¸ í”„ë¡¬í”„íŠ¸(<code>validation_negative_prompt)ë¥¼ ìƒëµí•©ë‹ˆë‹¤. </code>) ë¬´ì—‡ë³´ë‹¤ë„ ë¨¼ì € ì•„ë˜ <code>config.json</code>ì„ ë³µì‚¬í•˜ì—¬ ì‹œì‘í•˜ëŠ” ê²ƒì´ ì¢‹ìŠµë‹ˆë‹¤.</p>
<ul>
<li><p>Custom SD3.5 Large <code>LoRA</code> <code>config.json</code></p>
  <figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br></pre></td><td class="code"><pre><span class="line"><span class="punctuation">&#123;</span></span><br><span class="line">  <span class="attr">&quot;--model_type&quot;</span><span class="punctuation">:</span> <span class="string">&quot;lora&quot;</span><span class="punctuation">,</span></span><br><span class="line">  <span class="attr">&quot;--model_family&quot;</span><span class="punctuation">:</span> <span class="string">&quot;sd3&quot;</span><span class="punctuation">,</span></span><br><span class="line">  <span class="attr">&quot;--resume_from_checkpoint&quot;</span><span class="punctuation">:</span> <span class="string">&quot;latest&quot;</span><span class="punctuation">,</span></span><br><span class="line">  <span class="attr">&quot;--checkpointing_steps&quot;</span><span class="punctuation">:</span> <span class="number">400</span><span class="punctuation">,</span></span><br><span class="line">  <span class="attr">&quot;--checkpoints_total_limit&quot;</span><span class="punctuation">:</span> <span class="number">60</span><span class="punctuation">,</span></span><br><span class="line">  <span class="attr">&quot;--learning_rate&quot;</span><span class="punctuation">:</span> <span class="number">1.05e-3</span><span class="punctuation">,</span></span><br><span class="line">  <span class="attr">&quot;--pretrained_model_name_or_path&quot;</span><span class="punctuation">:</span> <span class="string">&quot;stabilityai/stable-diffusion-3.5-large&quot;</span><span class="punctuation">,</span></span><br><span class="line">  <span class="attr">&quot;--report_to&quot;</span><span class="punctuation">:</span> <span class="string">&quot;wandb&quot;</span><span class="punctuation">,</span></span><br><span class="line">  <span class="attr">&quot;--tracker_project_name&quot;</span><span class="punctuation">:</span> <span class="string">&quot;sd35-training&quot;</span><span class="punctuation">,</span></span><br><span class="line">  <span class="attr">&quot;--tracker_run_name&quot;</span><span class="punctuation">:</span> <span class="string">&quot;simpletuner-fantasy-art-lora-01&quot;</span><span class="punctuation">,</span></span><br><span class="line">  <span class="attr">&quot;--max_train_steps&quot;</span><span class="punctuation">:</span> <span class="number">24000</span><span class="punctuation">,</span></span><br><span class="line">  <span class="attr">&quot;--num_train_epochs&quot;</span><span class="punctuation">:</span> <span class="number">0</span><span class="punctuation">,</span></span><br><span class="line">  <span class="attr">&quot;--data_backend_config&quot;</span><span class="punctuation">:</span> <span class="string">&quot;/weka2/home-yeo/simpletuner_models/sd3_large/full_finetune/fantasy_art_L_01/datasets/multidatabackend.json&quot;</span><span class="punctuation">,</span></span><br><span class="line">  <span class="attr">&quot;--output_dir&quot;</span><span class="punctuation">:</span> <span class="string">&quot;/weka2/home-yeo/simpletuner_models/sd3_large/full_finetune/fantasy_art_L_01/datasets/models&quot;</span><span class="punctuation">,</span></span><br><span class="line">  <span class="attr">&quot;--push_to_hub&quot;</span><span class="punctuation">:</span> <span class="keyword">false</span><span class="punctuation">,</span></span><br><span class="line">  <span class="attr">&quot;--push_checkpoints_to_hub&quot;</span><span class="punctuation">:</span> <span class="keyword">true</span><span class="punctuation">,</span></span><br><span class="line">  <span class="attr">&quot;--hub_model_id&quot;</span><span class="punctuation">:</span> <span class="string">&quot;sd35-training&quot;</span><span class="punctuation">,</span></span><br><span class="line">  <span class="attr">&quot;--resolution&quot;</span><span class="punctuation">:</span> <span class="number">1024</span><span class="punctuation">,</span></span><br><span class="line">  <span class="attr">&quot;--resolution_type&quot;</span><span class="punctuation">:</span> <span class="string">&quot;pixel&quot;</span><span class="punctuation">,</span></span><br><span class="line">  <span class="attr">&quot;--minimum_image_size&quot;</span><span class="punctuation">:</span> <span class="number">1024</span><span class="punctuation">,</span></span><br><span class="line">  <span class="attr">&quot;--instance_prompt&quot;</span><span class="punctuation">:</span> <span class="string">&quot;k4s4 &quot;</span><span class="punctuation">,</span></span><br><span class="line">  <span class="attr">&quot;--validation_prompt&quot;</span><span class="punctuation">:</span> <span class="string">&quot;k4s4, a waist up view of a beautiful female blonde woman, green eyes&quot;</span><span class="punctuation">,</span></span><br><span class="line">  <span class="attr">&quot;--validation_guidance&quot;</span><span class="punctuation">:</span> <span class="number">7.5</span><span class="punctuation">,</span></span><br><span class="line">  <span class="attr">&quot;--validation_guidance_rescale&quot;</span><span class="punctuation">:</span> <span class="number">0.0</span><span class="punctuation">,</span></span><br><span class="line">  <span class="attr">&quot;--validation_steps&quot;</span><span class="punctuation">:</span> <span class="number">200</span><span class="punctuation">,</span></span><br><span class="line">  <span class="attr">&quot;--validation_num_inference_steps&quot;</span><span class="punctuation">:</span> <span class="number">30</span><span class="punctuation">,</span></span><br><span class="line">  <span class="attr">&quot;--validation_negative_prompt&quot;</span><span class="punctuation">:</span> <span class="string">&quot;blurry, cropped, ugly&quot;</span><span class="punctuation">,</span></span><br><span class="line">  <span class="attr">&quot;--validation_seed&quot;</span><span class="punctuation">:</span> <span class="number">42</span><span class="punctuation">,</span></span><br><span class="line">  <span class="attr">&quot;--validation_resolution&quot;</span><span class="punctuation">:</span> <span class="number">1024</span><span class="punctuation">,</span></span><br><span class="line">  <span class="attr">&quot;--train_batch_size&quot;</span><span class="punctuation">:</span> <span class="number">6</span><span class="punctuation">,</span></span><br><span class="line">  <span class="attr">&quot;--gradient_accumulation_steps&quot;</span><span class="punctuation">:</span> <span class="number">1</span><span class="punctuation">,</span></span><br><span class="line">  <span class="attr">&quot;--lr_scheduler&quot;</span><span class="punctuation">:</span> <span class="string">&quot;cosine&quot;</span><span class="punctuation">,</span></span><br><span class="line">  <span class="attr">&quot;--lr_warmup_steps&quot;</span><span class="punctuation">:</span> <span class="number">2400</span><span class="punctuation">,</span></span><br><span class="line">  <span class="attr">&quot;--caption_dropout_probability&quot;</span><span class="punctuation">:</span> <span class="number">0</span><span class="punctuation">,</span></span><br><span class="line">  <span class="attr">&quot;--metadata_update_interval&quot;</span><span class="punctuation">:</span> <span class="number">65</span><span class="punctuation">,</span></span><br><span class="line">  <span class="attr">&quot;--vae_batch_size&quot;</span><span class="punctuation">:</span> <span class="number">12</span><span class="punctuation">,</span></span><br><span class="line">  <span class="attr">&quot;--delete_unwanted_images&quot;</span><span class="punctuation">:</span> <span class="keyword">false</span><span class="punctuation">,</span></span><br><span class="line">  <span class="attr">&quot;--delete_problematic_images&quot;</span><span class="punctuation">:</span> <span class="keyword">false</span><span class="punctuation">,</span></span><br><span class="line">  <span class="attr">&quot;--training_scheduler_timestep_spacing&quot;</span><span class="punctuation">:</span> <span class="string">&quot;trailing&quot;</span><span class="punctuation">,</span></span><br><span class="line">  <span class="attr">&quot;--inference_scheduler_timestep_spacing&quot;</span><span class="punctuation">:</span> <span class="string">&quot;trailing&quot;</span><span class="punctuation">,</span></span><br><span class="line">  <span class="attr">&quot;--snr_gamma&quot;</span><span class="punctuation">:</span> <span class="number">5</span><span class="punctuation">,</span></span><br><span class="line">  <span class="attr">&quot;--enable_xformers_memory_efficient_attention&quot;</span><span class="punctuation">:</span> <span class="keyword">true</span><span class="punctuation">,</span></span><br><span class="line">  <span class="attr">&quot;--gradient_checkpointing&quot;</span><span class="punctuation">:</span> <span class="keyword">true</span><span class="punctuation">,</span></span><br><span class="line">  <span class="attr">&quot;--allow_tf32&quot;</span><span class="punctuation">:</span> <span class="keyword">true</span><span class="punctuation">,</span></span><br><span class="line">  <span class="attr">&quot;--optimizer&quot;</span><span class="punctuation">:</span> <span class="string">&quot;adamw_bf16&quot;</span><span class="punctuation">,</span></span><br><span class="line">  <span class="attr">&quot;--use_ema&quot;</span><span class="punctuation">:</span> <span class="keyword">false</span><span class="punctuation">,</span></span><br><span class="line">  <span class="attr">&quot;--ema_decay&quot;</span><span class="punctuation">:</span> <span class="number">0.999</span><span class="punctuation">,</span></span><br><span class="line">  <span class="attr">&quot;--seed&quot;</span><span class="punctuation">:</span> <span class="number">42</span><span class="punctuation">,</span></span><br><span class="line">  <span class="attr">&quot;--mixed_precision&quot;</span><span class="punctuation">:</span> <span class="string">&quot;bf16&quot;</span><span class="punctuation">,</span></span><br><span class="line">  <span class="attr">&quot;--lora_rank&quot;</span><span class="punctuation">:</span> <span class="number">768</span><span class="punctuation">,</span></span><br><span class="line">  <span class="attr">&quot;--lora_alpha&quot;</span><span class="punctuation">:</span> <span class="number">768</span><span class="punctuation">,</span></span><br><span class="line">  <span class="attr">&quot;--lora_type&quot;</span><span class="punctuation">:</span> <span class="string">&quot;standard&quot;</span></span><br><span class="line"><span class="punctuation">&#125;</span></span><br></pre></td></tr></table></figure></li>
</ul>
<p>ë­”ê°€ ëˆˆì¹˜ì±„ì…¨ì„ ìˆ˜ë„ ìˆì§€ë§Œ, ìš°ë¦¬ëŠ” <strong>ë” ì´ìƒ</strong> ì´ì „ í•˜ìœ„ ìˆ˜ì¤€ <code>config.env</code>ì˜ ì´ ë§¤ê°œë³€ìˆ˜ë¥¼ ì‚¬ìš©í•˜ì§€ ì•ŠìŠµë‹ˆë‹¤.</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line"><span class="built_in">export</span> STABLE_DIFFUSION_3=<span class="literal">true</span></span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>ëŒ€ì‹  <code>&quot;--model_family&quot;</code> ë§¤ê°œë³€ìˆ˜ë¡œ ëŒ€ì²´ë˜ì—ˆìŠµë‹ˆë‹¤. ì´ê²ƒì„ <code>sd3</code>ìœ¼ë¡œ ì„¤ì •í•©ë‹ˆë‹¤:</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">&quot;--model_family&quot;: &quot;sd3&quot;</span><br></pre></td></tr></table></figure>


<p>ì‹¤ì œë¡œ, ë‚®ì€ ìˆ˜ì¤€ <code>config.env</code>ëŠ” <code>SimpleTuner</code>ì— ì˜í•´ ë” ì´ìƒ ì‚¬ìš©ë˜ì§€ ì•Šì„ ìˆ˜ ìˆìŠµë‹ˆë‹¤. í•˜ì§€ë§Œ ì›í•˜ì‹œë©´ ê·¸ë˜ë„ ì‚¬ìš©í•˜ëŠ” ë°©ë²•ì€ ì´ <a target="_blank" rel="external nofollow noopener noreferrer" href="https://www.notion.so/Stable-Diffusion-3-5-Large-Fine-tuning-Tutorial-11a61cdcd1968027a15bdbd7c40be8c6?pvs">ì„¹ì…˜</a>ì—ì„œ ë³´ì—¬ë“œë¦¬ê² ìŠµë‹ˆë‹¤. &#x3D;21).</p>
<p>ë˜í•œ ì´ ë§¤ê°œë³€ìˆ˜ê°€ ì œëŒ€ë¡œ ì„¤ì •ë˜ì—ˆëŠ”ì§€ í™•ì¸í•˜ì„¸ìš”. ê·¸ë ‡ì§€ ì•Šìœ¼ë©´ <code>HuggingFace</code>ì—ì„œ ëª¨ë¸ì„ ê°€ì ¸ì˜¬ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">&quot;--pretrained_model_name_or_path&quot;: &quot;stabilityai/stable-diffusion-3.5-large&quot;</span><br></pre></td></tr></table></figure>

<p>ì´ê²ƒì´ ì‘ë™í•˜ëŠ”ì§€ í™•ì¸í•˜ë ¤ë©´ â€˜HuggingFaceâ€™ ê³„ì •ì— ì—¬ê¸° ëª¨ë¸ ì¹´ë“œ í˜ì´ì§€ì—ì„œ ì´ ëª¨ë¸ì— ëŒ€í•œ ì•¡ì„¸ìŠ¤ ê¶Œí•œì´ ë¶€ì—¬ë˜ì—ˆëŠ”ì§€ í™•ì¸í•´ì•¼ í•©ë‹ˆë‹¤. <a target="_blank" rel="external nofollow noopener noreferrer" href="https://github.com/bghira/SimpleTuner/blob/main/documentation/quickstart/SD3.md">ë¹ ë¥¸ ì‹œì‘ ê°€ì´ë“œ</a>ì˜ ì§€ì¹¨ì„ ë”°ë¥´ë©´ ë©ë‹ˆë‹¤.</p>
<p>ë‹¤ìŒ ëª…ë ¹ì€ ë‹¤ìŒê³¼ ê°™ìŠµë‹ˆë‹¤.</p>
<p><strong>í•„ìˆ˜</strong></p>
<p>ëª¨ë¸ì„ ë‹¤ìš´ë¡œë“œí•˜ê¸° ìœ„í•œ ì ‘ê·¼ ê¶Œí•œì„ ì–»ê¸° ìœ„í•œ ê²ƒì…ë‹ˆë‹¤.</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">huggingface-cli login</span><br></pre></td></tr></table></figure>

<p>ë‚˜ë¨¸ì§€ ì„¤ì •ì„ ë‹¤ë£¨ê¸° ì „ì— ì§€ê¸ˆ â€˜multidatabackend.jsonâ€™ íŒŒì¼ì„ ì„¤ì •í•˜ëŠ” ê²ƒì´ ì¢‹ìŠµë‹ˆë‹¤.</p>
<h3 id="Dataloader"><a href="#Dataloader" class="headerlink" title="Dataloader"></a>Dataloader</h3><p>ê´€ë ¨ ë§¤ê°œë³€ìˆ˜ë¥¼ ì¸ê°„ì´ ì´í•´í•  ìˆ˜ ìˆëŠ” ì–´íœ˜ë¡œ êµ¬ë¬¸ ë¶„ì„í•˜ê¸° ì „ì— ë°ì´í„° ë¶€ë¶„ì¸ <code>--data_backend_config</code> ë° <code>--output_dir</code>ë¶€í„° ì‹œì‘í•˜ê³  ì‹¶ìŠµë‹ˆë‹¤. ì´ì „ ë²„ì „ì˜ <code>SimpleTuner</code>ì—ëŠ” ë°ì´í„°ë¥¼ ì²˜ë¦¬í•˜ëŠ” <code>multidatabackend.json</code> íŒŒì¼ì´ ìˆì—ˆìŠµë‹ˆë‹¤.</p>
<p>Excerpt from old code:</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">export</span> BASE_DIR=<span class="string">&quot;/weka2/home-yeo/simpletuner_models/sd3_large/full_finetune/fantasy_art_L_01/datasets/&quot;</span></span><br><span class="line"><span class="built_in">export</span> DATALOADER_CONFIG=<span class="string">&quot;<span class="variable">$&#123;BASE_DIR&#125;</span>/multidatabackend.json&quot;</span></span><br><span class="line"><span class="built_in">export</span> OUTPUT_DIR=<span class="string">&quot;<span class="variable">$&#123;BASE_DIR&#125;</span>/models&quot;</span></span><br></pre></td></tr></table></figure>

<p>ë³´ì‹œë‹¤ì‹œí”¼ <code>BASE_DIR</code>ì´ ì„ ì–¸ëœ ë‹¤ìŒ <code>DATALOADER_CONFIG</code>ì™€ <code>OUTPUT_DIR</code>ì´ ì´ë¥¼ í™•ì¥í•©ë‹ˆë‹¤. <code>multidatabackend.json</code>ì€ <code>BASE_DIR</code> ë‚´ë¶€ì— ìƒì„±ëœ íŒŒì¼ì…ë‹ˆë‹¤.</p>
<p>ê·¸ëŸ¬ë‚˜ SimpleTunerì˜ ê¸°ë³¸ êµ¬ì„± í´ë”ì—ëŠ” â€˜SimpleTuner&#x2F;config&#x2F;multidatabackend.jsonâ€™ íŒŒì¼ì´ ìˆìŠµë‹ˆë‹¤. ê°œì¸ ì·¨í–¥ì— ë”°ë¼ â€˜multidatabackend.jsonâ€™ íŒŒì¼ì„ ì›í•˜ëŠ” ê³³ì— ëª¨ë‘ ë°°ì¹˜í•  ìˆ˜ ìˆì§€ë§Œ, ëª¨ë“  ëª¨ë¸ê³¼ ìºì‹œë¥¼ í•œ ê³³ì— ë³´ê´€í•˜ë¯€ë¡œ ì´ì „ ë²„ì „ì˜ â€˜SimpleTunerâ€™ êµ¬ì¡°ë¥¼ ë³´ì¡´í•˜ê² ìŠµë‹ˆë‹¤.</p>
<p>ë”°ë¼ì„œ <code>BASE_DIR</code> ì—­í• ì„ í•  í´ë” ìœ„ì¹˜ë¥¼ ìƒì„±í•˜ê² ìŠµë‹ˆë‹¤. ë”°ë¼ì„œ <code>--data_backend_config</code>ì™€ <code>--output_dir</code> ëª¨ë‘ ì´ ê²½ë¡œë¥¼ í™œìš©í•©ë‹ˆë‹¤.</p>
<p>ìš°ë¦¬ëŠ” <code>json</code>ì„ ì‚¬ìš©í•˜ê³  ìˆìœ¼ë¯€ë¡œ í•˜ë“œì½”ë”©í•´ì•¼ í•©ë‹ˆë‹¤.</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">&quot;--data_backend_config&quot;: &quot;/weka2/home-yeo/simpletuner_models/sd3_large/full_finetune/fantasy_art_L_01/datasets/multidatabackend.json&quot;,</span><br><span class="line"> &quot;--output_dir&quot;: &quot;/weka2/home-yeo/simpletuner_models/sd3_large/full_finetune/fantasy_art_L_01/datasets/models&quot;,</span><br></pre></td></tr></table></figure>


<p>ëª¨ë“  ëª¨ë¸ì€ <code>--output_dir</code>ì— ì €ì¥ë˜ë©°, ì´ ê²½ìš° í•˜ë“œ ì½”ë”©ëœ <code>BASE_DIR/models</code>ì…ë‹ˆë‹¤.</p>
<p>ë‹¤ìŒì€ ë‚´ ì‚¬ìš©ì ì •ì˜ <code>multidatabackend.json</code>ì…ë‹ˆë‹¤.</p>
<ul>
<li><p>Custom <code>multidatabackend.json</code></p>
  <figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line"><span class="punctuation">[</span></span><br><span class="line">  <span class="punctuation">&#123;</span></span><br><span class="line">    <span class="attr">&quot;id&quot;</span><span class="punctuation">:</span> <span class="string">&quot;fantasy_art_neo&quot;</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;type&quot;</span><span class="punctuation">:</span> <span class="string">&quot;local&quot;</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;crop&quot;</span><span class="punctuation">:</span> <span class="keyword">false</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;crop_aspect&quot;</span><span class="punctuation">:</span> <span class="string">&quot;square&quot;</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;crop_style&quot;</span><span class="punctuation">:</span> <span class="string">&quot;center&quot;</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;resolution&quot;</span><span class="punctuation">:</span> <span class="number">1.0</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;minimum_image_size&quot;</span><span class="punctuation">:</span> <span class="number">1.0</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;maximum_image_size&quot;</span><span class="punctuation">:</span> <span class="number">1.0</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;target_downsample_size&quot;</span><span class="punctuation">:</span> <span class="number">1.0</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;resolution_type&quot;</span><span class="punctuation">:</span> <span class="string">&quot;area&quot;</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;cache_dir_vae&quot;</span><span class="punctuation">:</span> <span class="string">&quot;/weka2/home-yeo/simpletuner_models/sd3_large/full_finetune/fantasy_art_L_01/cache/vae/sd3/fantasy_art_neo&quot;</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;instance_data_dir&quot;</span><span class="punctuation">:</span> <span class="string">&quot;/weka2/home-yeo/datasets/SDXL/duplicate_shuffle_01&quot;</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;disabled&quot;</span><span class="punctuation">:</span> <span class="keyword">false</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;skip_file_discovery&quot;</span><span class="punctuation">:</span> <span class="string">&quot;&quot;</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;caption_strategy&quot;</span><span class="punctuation">:</span> <span class="string">&quot;textfile&quot;</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;metadata_backend&quot;</span><span class="punctuation">:</span> <span class="string">&quot;json&quot;</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;repeats&quot;</span><span class="punctuation">:</span> <span class="number">1</span></span><br><span class="line">  <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">  <span class="punctuation">&#123;</span></span><br><span class="line">    <span class="attr">&quot;id&quot;</span><span class="punctuation">:</span> <span class="string">&quot;text-embeds&quot;</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;type&quot;</span><span class="punctuation">:</span> <span class="string">&quot;local&quot;</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;dataset_type&quot;</span><span class="punctuation">:</span> <span class="string">&quot;text_embeds&quot;</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;default&quot;</span><span class="punctuation">:</span> <span class="keyword">true</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;cache_dir&quot;</span><span class="punctuation">:</span> <span class="string">&quot;/weka2/home-yeo/simpletuner_models/sd3_large/full_finetune/fantasy_art_L_01/cache/text/sd3/fantasy_art_neo&quot;</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;disabled&quot;</span><span class="punctuation">:</span> <span class="keyword">false</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;write_batch_size&quot;</span><span class="punctuation">:</span> <span class="number">128</span></span><br><span class="line">  <span class="punctuation">&#125;</span></span><br><span class="line"><span class="punctuation">]</span></span><br></pre></td></tr></table></figure></li>
</ul>
<p>ì§€ì •í•´ì•¼ í•˜ëŠ” ë””ë ‰í„°ë¦¬ëŠ” ì„¸ ê°œì…ë‹ˆë‹¤.</p>
<ol>
<li><code>cache_dir_vae</code></li>
</ol>
<p>ë‚´ ì˜ˆì œ íŒŒì¼ì—ëŠ” ë‹¤ìŒì´ ìˆìŠµë‹ˆë‹¤.</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">&quot;cache_dir_vae&quot;: &quot;/weka2/home-yeo/simpletuner_models/sd3_large/full_finetune/fantasy_art_L_01/cache/vae/sd3/fantasy_art_neo&quot;</span><br></pre></td></tr></table></figure>


<p>ê°€ë…ì„±ê³¼ ëª…í™•ì„±ì„ ìœ„í•´ ê¸°ë³¸ ë””ë ‰í„°ë¦¬ ì•ˆì— â€˜cacheâ€™ í´ë”ë¥¼ ë„£ì—ˆìŠµë‹ˆë‹¤.</p>
<ol>
<li><code>instance_dir_vae</code></li>
</ol>
<p>ì—¬ê¸°ì— ì´ë¯¸ì§€ì™€ ìº¡ì…˜ì´ í¬í•¨ëœ ë°ì´í„°ì„¸íŠ¸ê°€ ì €ì¥ë©ë‹ˆë‹¤. ë§¤ìš° ê°„ë‹¨í•©ë‹ˆë‹¤.</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">&quot;instance_data_dir&quot;: &quot;/weka2/home-yeo/datasets/SDXL/duplicate_shuffle_01&quot;</span><br></pre></td></tr></table></figure>

<ol>
<li><code>cache_dir</code></li>
</ol>
<p>ìœ„ì™€ ë™ì¼í•©ë‹ˆë‹¤.</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">&quot;cache_dir&quot;: &quot;/weka2/home-yeo/simpletuner_models/sd3_large/full_finetune/fantasy_art_L_01/cache/text/sd3/fantasy_art_neo&quot;</span><br></pre></td></tr></table></figure>


<p>ë‚˜ë¨¸ì§€ ì„¤ì •ì€ ë‚˜ì—ê²Œ ê·¸ë‹¤ì§€ ì¤‘ìš”í•˜ì§€ ì•ŠìŠµë‹ˆë‹¤. ì €ëŠ” ì´ë¯¸ ì´ë¯¸ì§€ë¥¼ ë¯¸ë¦¬ ì˜ë¼ì„œ <code>&quot;crop&quot;: false</code>ë¥¼ ì„¤ì •í–ˆìŠµë‹ˆë‹¤.</p>
<p>ë˜í•œ ì´ì „ì— ë‹¤ë¥¸ êµìœ¡ ë¦¬í¬ì§€í† ë¦¬ë¥¼ ì‚¬ìš©í•´ ë³¸ ì ì´ ìˆëŠ”ì§€ ì—¬ë¶€ì— ë”°ë¼ ìµìˆ™í•  ìˆ˜ë„ ìˆê³  ìµìˆ™í•˜ì§€ ì•Šì„ ìˆ˜ë„ ìˆëŠ” â€˜ë°˜ë³µâ€™ ë§¤ê°œë³€ìˆ˜ê°€ ìˆìŠµë‹ˆë‹¤. ì´ ë‚´ìš©ë„ ë‹¤ìŒ ì„¹ì…˜ì—ì„œ ë‹¤ë£¨ê² ìŠµë‹ˆë‹¤. ê·¸ë˜ì„œ &#96;&#96;repeatsâ€: 1â€™ì„ ì œê°€ ì§ì ‘ ì²˜ë¦¬í•˜ëŠ” ê²ƒì…ë‹ˆë‹¤.</p>
<h3 id="Data-preparation"><a href="#Data-preparation" class="headerlink" title="Data preparation"></a>Data preparation</h3><p>ë‚´ ë°ì´í„° ì„¸íŠ¸ì˜ ëª¨ë“  ì´ë¯¸ì§€ëŠ” ì´ë¯¸ ë‹¤ìŒ ì¢…íš¡ë¹„ ë° í•´ìƒë„ ì¤‘ í•˜ë‚˜ë¡œ ë¯¸ë¦¬ ì˜ë ¤ì ¸ ìˆìŠµë‹ˆë‹¤.</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">[</span><br><span class="line">    (1024, 1024), (1152, 896), (896, 1152), (1216, 832),</span><br><span class="line">    (832, 1216), (1344, 768), (768, 1344), (1472, 704)</span><br><span class="line">]</span><br></pre></td></tr></table></figure>

<p>ì´ë¯¸ì§€ë¥¼ ìë™ìœ¼ë¡œ ë¯¸ë¦¬ ìë¥´ëŠ” ë° ë„ì›€ì´ í•„ìš”í•œ ê²½ìš° ì´ë¥¼ ìœ„í•´ ì œê°€ ì‘ì„±í•œ ê²½ëŸ‰ì˜ ê¸°ë³¸ <a target="_blank" rel="external nofollow noopener noreferrer" href="https://github.com/kasukanra/autogen_local_LLM/blob/main/Detect_utils.py">ìŠ¤í¬ë¦½íŠ¸</a>ê°€ ìˆìŠµë‹ˆë‹¤. ë‹¤ìŒì— ë”°ë¼ ìµœìƒì˜ ì‘ë¬¼ì„ ì°¾ìŠµë‹ˆë‹¤.</p>
<ol>
<li>ì´ë¯¸ì§€ì— ì‚¬ëŒ ì–¼êµ´ì´ í¬í•¨ë˜ì–´ ìˆë‚˜ìš”? ê·¸ë ‡ë‹¤ë©´ ì´ë¯¸ì§€ì˜ í•´ë‹¹ ì˜ì—­ì„ ì¤‘ì‹¬ìœ¼ë¡œ ìë¥´ê¸°ë¥¼ ìˆ˜í–‰í•©ë‹ˆë‹¤.</li>
<li>ê°ì§€ëœ ì‚¬ëŒì˜ ì–¼êµ´ì´ ì—†ìœ¼ë©´ ì´ë¯¸ì§€ì—ì„œ ê°€ì¥ í¥ë¯¸ë¡œìš´ ì˜ì—­ì„ ê°ì§€í•˜ëŠ” ëŒì¶œ ë§µì„ ì‚¬ìš©í•˜ì—¬ ìë¥´ê¸°ë¥¼ ìˆ˜í–‰í•©ë‹ˆë‹¤. ê·¸ëŸ¬ë©´ í•´ë‹¹ ì§€ì—­ì„ ì¤‘ì‹¬ìœ¼ë¡œ ê°€ì¥ ì¢‹ì€ ì‘ë¬¼ì´ ì¶”ì¶œë©ë‹ˆë‹¤.</li>
</ol>
<p>ì–´ì¨Œë“  ë‚´ ê¸°ë³¸ ë°ì´í„° ì„¸íŠ¸ êµ¬ì¡°ëŠ” ë‹¤ìŒê³¼ ê°™ìŠµë‹ˆë‹¤(í…ìŠ¤íŠ¸ íŒŒì¼ì€ ìº¡ì…˜ì…ë‹ˆë‹¤).</p>
<p>ë‚´ ìº¡ì…˜ì´ ì–´ë–»ê²Œ ë³´ì´ëŠ”ì§€ì— ëŒ€í•œ ëª‡ ê°€ì§€ ì˜ˆëŠ” ë‹¤ìŒê³¼ ê°™ìŠµë‹ˆë‹¤.</p>
<figure class="highlight markdown"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">k4s4, a close up portrait view of a young man with green eyes and short dark hair, looking at the viewer with a slight smile, visible ears, wearing a dark jacket, hair bangs, a green and orange background</span><br></pre></td></tr></table></figure>

<figure class="highlight markdown"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">k4s4, a rear view of a woman wearing a red hood and faded skirt holding a staff in each hand and steering a small boat with small white wings and large white sail towards a city with tall structures, blue sky with white clouds, cropped</span><br></pre></td></tr></table></figure>


<p>ìì²´ ë¯¸ì„¸ ì¡°ì • ë°ì´í„° ì„¸íŠ¸ê°€ ì—†ë‹¤ë©´ Johnì´ ê·¸ë¦° ê·¸ë¦¼ì˜ <a target="_blank" rel="external nofollow noopener noreferrer" href="https://drive.google.com/file/d/1capT9kF-zCu2OiNVzm7VG5DQDaAQLl1Q/view?usp=sharing">ì´ ë°ì´í„° ì„¸íŠ¸</a>ë¥¼ ììœ ë¡­ê²Œ ì‚¬ìš©í•´ ë³´ì„¸ìš”. ê°€ìˆ˜ Sargent(WikiArtì—ì„œ ë‹¤ìš´ë¡œë“œí•˜ê³  ìë™ ìº¡ì…˜ ìˆìŒ) ë˜ëŠ” í•©ì„± í”½ì…€ ì•„íŠ¸ <a target="_blank" rel="external nofollow noopener noreferrer" href="https://drive.google.com/file/d/1tOyNsjR5i7ki5UkyxHhjjT_VVD8vK5WN/view?usp=drive_link">ë°ì´í„°ì„¸íŠ¸</a>.</p>
<p>ë‹¤ì–‘í•œ ë°ì´í„° ì„¸íŠ¸ í¬ê¸°ì˜ ì—¬ëŸ¬ ë¯¸ì„¸ ì¡°ì •ëœ â€˜LoRAâ€™ ëª¨ë¸ì˜ ê²°ê³¼ë¥¼ ë³´ì—¬ì¤Œìœ¼ë¡œì¨ ë‚´ê°€ ì„ íƒí•œ ì„¤ì •ì´ â€˜LoRAâ€™ ë¯¸ì„¸ ì¡°ì •ì„ ìœ„í•œ ì¢‹ì€ ì¶œë°œì ì´ ë  ë§Œí¼ ì¶©ë¶„íˆ ì¼ë°˜í™”ëœë‹¤ëŠ” ê²ƒì„ ë³´ì—¬ì¤„ ê²ƒì…ë‹ˆë‹¤.</p>
<table>
<thead>
<tr>
<th><code>name</code></th>
<th><code>fantasy art</code></th>
<th><code>cinema photo</code></th>
<th><code>john singer sargent</code></th>
<th><code>underexposed photography</code></th>
<th><code>pixel art</code></th>
<th><code>ethnic paint</code></th>
</tr>
</thead>
<tbody><tr>
<td><code>number of images</code></td>
<td>476</td>
<td>460</td>
<td>460</td>
<td>96</td>
<td>82</td>
<td>68</td>
</tr>
<tr>
<td><code>number of repeats</code></td>
<td>5</td>
<td>5</td>
<td>5</td>
<td>5</td>
<td>5</td>
<td>5</td>
</tr>
</tbody></table>
<p><code>ë°˜ë³µ</code>ì€ ì´ë¯¸ì§€ë¥¼ ë³µì œí•˜ê³ (ì„ íƒì ìœ¼ë¡œ íšŒì „í•˜ê³ , ìƒ‰ì¡°&#x2F;ì±„ë„ ë“±ì„ ë³€ê²½í•˜ëŠ” ë“±) ìº¡ì…˜ë„ ëª¨ë¸ì— ì¼ë°˜í™”í•˜ê³  ê³¼ì í•©ì„ ë°©ì§€í•˜ëŠ” ë° ë„ì›€ì´ ë©ë‹ˆë‹¤. <code>SimpleTuner</code>ëŠ” ìº¡ì…˜ ë“œë¡­ì•„ì›ƒ(ì§€ì •ëœ ì‹œê°„ ë¹„ìœ¨ì— ë”°ë¼ ìº¡ì…˜ì„ ë¬´ì‘ìœ„ë¡œ ì‚­ì œ)ì„ ì§€ì›í•˜ì§€ë§Œ í˜„ì¬ë¡œì„œëŠ” ì…”í”Œë§ í† í°(í† í°ì€ ìº¡ì…˜ì˜ ë‹¨ì–´ì™€ ìœ ì‚¬í•¨)ì„ ì§€ì›í•˜ì§€ ì•Šì§€ë§Œ kohyaì˜ ë™ì‘ì„ ì‹œë®¬ë ˆì´ì…˜í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤. <a target="_blank" rel="external nofollow noopener noreferrer" href="https://github.com/kohya-ss/sd-scripts">sd-scripts</a> <a target="_blank" rel="external nofollow noopener noreferrer" href="https://github.com/kohya-ss/sd-scripts/blob/25f961bc779bc79aef440813e3e8e92244ac5739/">í† í° ì„ê¸°</a>í•  ìˆ˜ ìˆëŠ” ê³³ docs&#x2F;config_README-en.md?plain&#x3D;1#L146) [ìœ ì§€]í•˜ëŠ” ë™ì•ˆ(<a target="_blank" rel="external nofollow noopener noreferrer" href="https://github.com/kohya-ss/sd-scripts/blob/25f961bc779bc79aef440813e3e8e92244ac5739/docs/config_README-en.md?plain=1">https://github.com/kohya-ss/sd-scripts/blob/25f961bc779bc79aef440813e3e8e92244ac5739/docs/config_README-en.md?plain=1</a> #L143) ì‹œì‘ ìœ„ì¹˜ì— â€˜nâ€™ê°œì˜ í† í°ì´ ìˆìŠµë‹ˆë‹¤. <strong>ì´ë ‡ê²Œ í•˜ë©´ ëª¨ë¸ì´ ì™¸ë¶€ í† í°ì— ë„ˆë¬´ ì§‘ì°©í•˜ì§€ ì•Šë„ë¡ ë„ì™€ì¤ë‹ˆë‹¤.</strong></p>
<p>í•´ë‹¹ ê¸°ëŠ¥ì„ ë³µì œí•˜ë ¤ë©´ ì—¬ê¸°ì— ì´ë¯¸ì§€ë¥¼ ë³µì œí•˜ê³  ìº¡ì…˜ì„ ì¡°ì‘í•˜ëŠ” ìŠ¤í¬ë¦½íŠ¸ë¥¼ ì œê³µí–ˆìŠµë‹ˆë‹¤.</p>
<ul>
<li><p><code>duplicate_shuffle.py</code></p>
  <figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> os</span><br><span class="line"><span class="keyword">import</span> shutil</span><br><span class="line"><span class="keyword">import</span> random</span><br><span class="line"><span class="keyword">from</span> pathlib <span class="keyword">import</span> Path</span><br><span class="line"><span class="keyword">import</span> re</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">duplicate_and_shuffle_dataset</span>(<span class="params">input_folder, output_folder, dataset_repeats, n_tokens_to_keep</span>):</span><br><span class="line">    <span class="comment"># Create output folder if it doesn&#x27;t exist</span></span><br><span class="line">    Path(output_folder).mkdir(parents=<span class="literal">True</span>, exist_ok=<span class="literal">True</span>)</span><br><span class="line"></span><br><span class="line">    <span class="comment"># Get all image files</span></span><br><span class="line">    image_files = [f <span class="keyword">for</span> f <span class="keyword">in</span> os.listdir(input_folder) <span class="keyword">if</span> f.lower().endswith((<span class="string">&#x27;.png&#x27;</span>, <span class="string">&#x27;.jpg&#x27;</span>, <span class="string">&#x27;.jpeg&#x27;</span>))]</span><br><span class="line"></span><br><span class="line">    <span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(dataset_repeats):</span><br><span class="line">        <span class="keyword">for</span> image_file <span class="keyword">in</span> image_files:</span><br><span class="line">            <span class="comment"># Get corresponding text file</span></span><br><span class="line">            text_file = os.path.splitext(image_file)[<span class="number">0</span>] + <span class="string">&#x27;.txt&#x27;</span></span><br><span class="line">            </span><br><span class="line">            <span class="keyword">if</span> <span class="keyword">not</span> os.path.exists(os.path.join(input_folder, text_file)):</span><br><span class="line">                <span class="built_in">print</span>(<span class="string">f&quot;Warning: No corresponding text file found for <span class="subst">&#123;image_file&#125;</span>&quot;</span>)</span><br><span class="line">                <span class="keyword">continue</span></span><br><span class="line"></span><br><span class="line">            <span class="comment"># Create new file names</span></span><br><span class="line">            new_image_file = <span class="string">f&quot;<span class="subst">&#123;os.path.splitext(image_file)[<span class="number">0</span>]&#125;</span>_<span class="subst">&#123;i+<span class="number">1</span>&#125;</span><span class="subst">&#123;os.path.splitext(image_file)[<span class="number">1</span>]&#125;</span>&quot;</span></span><br><span class="line">            new_text_file = <span class="string">f&quot;<span class="subst">&#123;os.path.splitext(text_file)[<span class="number">0</span>]&#125;</span>_<span class="subst">&#123;i+<span class="number">1</span>&#125;</span>.txt&quot;</span></span><br><span class="line"></span><br><span class="line">            <span class="comment"># Copy image file</span></span><br><span class="line">            shutil.copy2(os.path.join(input_folder, image_file), os.path.join(output_folder, new_image_file))</span><br><span class="line"></span><br><span class="line">            <span class="comment"># Read, shuffle, and write text file</span></span><br><span class="line">            <span class="keyword">with</span> <span class="built_in">open</span>(os.path.join(input_folder, text_file), <span class="string">&#x27;r&#x27;</span>) <span class="keyword">as</span> f:</span><br><span class="line">                content = f.read().strip()</span><br><span class="line"></span><br><span class="line">            <span class="comment"># Split tokens using comma or period as separator</span></span><br><span class="line">            tokens = re.split(<span class="string">r&#x27;[,.]&#x27;</span>, content)</span><br><span class="line">            tokens = [token.strip() <span class="keyword">for</span> token <span class="keyword">in</span> tokens <span class="keyword">if</span> token.strip()]  <span class="comment"># Remove empty tokens and strip whitespace</span></span><br><span class="line"></span><br><span class="line">            tokens_to_keep = tokens[:n_tokens_to_keep]</span><br><span class="line">            tokens_to_shuffle = tokens[n_tokens_to_keep:]</span><br><span class="line">            random.shuffle(tokens_to_shuffle)</span><br><span class="line"></span><br><span class="line">            new_content = <span class="string">&#x27;, &#x27;</span>.join(tokens_to_keep + tokens_to_shuffle)</span><br><span class="line"></span><br><span class="line">            <span class="keyword">with</span> <span class="built_in">open</span>(os.path.join(output_folder, new_text_file), <span class="string">&#x27;w&#x27;</span>) <span class="keyword">as</span> f:</span><br><span class="line">                f.write(new_content)</span><br><span class="line"></span><br><span class="line">    <span class="built_in">print</span>(<span class="string">f&quot;Dataset duplication and shuffling complete. Output saved to <span class="subst">&#123;output_folder&#125;</span>&quot;</span>)</span><br><span class="line"></span><br><span class="line"><span class="comment"># Example usage</span></span><br><span class="line">input_folder = <span class="string">&quot;/weka2/home-yeo/datasets/SDXL/full_dataset_neo&quot;</span></span><br><span class="line">output_folder = <span class="string">&quot;/weka2/home-yeo/datasets/SDXL/duplicate_shuffle_1&quot;</span></span><br><span class="line">dataset_repeats = <span class="number">5</span></span><br><span class="line">n_tokens_to_keep = <span class="number">2</span></span><br><span class="line"></span><br><span class="line">duplicate_and_shuffle_dataset(input_folder, output_folder, dataset_repeats, n_tokens_to_keep)</span><br></pre></td></tr></table></figure></li>
</ul>
<p>ê·¸ë ‡ê²Œ í•˜ë©´ ìµœì¢… ë°ì´í„° ì„¸íŠ¸ëŠ” ì•„ë˜ ì´ë¯¸ì§€ì™€ ë¹„ìŠ·í•´ì§‘ë‹ˆë‹¤. ì œê°€ ì‚¬ìš©í•œ ì„¤ì •ìœ¼ë¡œëŠ” 5ë²ˆì˜ â€˜ë°˜ë³µâ€™ì´ í—ˆìš©ë˜ëŠ” ê²ƒ ê°™ì•˜ìŠµë‹ˆë‹¤.</p>
<h2 id="Returning-to-the-custom-config"><a href="#Returning-to-the-custom-config" class="headerlink" title="Returning to the custom config"></a>Returning to the custom config</h2><p>ì´ì œ ì‚¬ìš©ì ì •ì˜ êµ¬ì„±ì—ì„œ ì´ëŸ¬í•œ íŠ¹ì • ì„¤ì •ì„ ë‹¤ë£¨ê² ìŠµë‹ˆë‹¤.</p>
<h3 id="Learning-rate-x2F-steps"><a href="#Learning-rate-x2F-steps" class="headerlink" title="Learning rate&#x2F;steps"></a>Learning rate&#x2F;steps</h3><ul>
<li><p>Custom SD3.5 Large  <code>config.json</code> for LoRA training</p>
  <figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br></pre></td><td class="code"><pre><span class="line"><span class="punctuation">&#123;</span></span><br><span class="line">  <span class="attr">&quot;--model_type&quot;</span><span class="punctuation">:</span> <span class="string">&quot;lora&quot;</span><span class="punctuation">,</span></span><br><span class="line">  <span class="attr">&quot;--model_family&quot;</span><span class="punctuation">:</span> <span class="string">&quot;sd3&quot;</span><span class="punctuation">,</span></span><br><span class="line">  <span class="attr">&quot;--resume_from_checkpoint&quot;</span><span class="punctuation">:</span> <span class="string">&quot;latest&quot;</span><span class="punctuation">,</span></span><br><span class="line">  <span class="attr">&quot;--checkpointing_steps&quot;</span><span class="punctuation">:</span> <span class="number">400</span><span class="punctuation">,</span></span><br><span class="line">  <span class="attr">&quot;--checkpoints_total_limit&quot;</span><span class="punctuation">:</span> <span class="number">60</span><span class="punctuation">,</span></span><br><span class="line">  <span class="attr">&quot;--learning_rate&quot;</span><span class="punctuation">:</span> <span class="number">1.05e-3</span><span class="punctuation">,</span></span><br><span class="line">  <span class="attr">&quot;--pretrained_model_name_or_path&quot;</span><span class="punctuation">:</span> <span class="string">&quot;stabilityai/stable-diffusion-3.5-large&quot;</span><span class="punctuation">,</span></span><br><span class="line">  <span class="attr">&quot;--report_to&quot;</span><span class="punctuation">:</span> <span class="string">&quot;wandb&quot;</span><span class="punctuation">,</span></span><br><span class="line">  <span class="attr">&quot;--tracker_project_name&quot;</span><span class="punctuation">:</span> <span class="string">&quot;sd35-training&quot;</span><span class="punctuation">,</span></span><br><span class="line">  <span class="attr">&quot;--tracker_run_name&quot;</span><span class="punctuation">:</span> <span class="string">&quot;simpletuner-fantasy-art-lora-01&quot;</span><span class="punctuation">,</span></span><br><span class="line">  <span class="attr">&quot;--max_train_steps&quot;</span><span class="punctuation">:</span> <span class="number">24000</span><span class="punctuation">,</span></span><br><span class="line">  <span class="attr">&quot;--num_train_epochs&quot;</span><span class="punctuation">:</span> <span class="number">0</span><span class="punctuation">,</span></span><br><span class="line">  <span class="attr">&quot;--data_backend_config&quot;</span><span class="punctuation">:</span> <span class="string">&quot;/weka2/home-yeo/simpletuner_models/sd3_large/full_finetune/fantasy_art_L_01/datasets/multidatabackend.json&quot;</span><span class="punctuation">,</span></span><br><span class="line">  <span class="attr">&quot;--output_dir&quot;</span><span class="punctuation">:</span> <span class="string">&quot;/weka2/home-yeo/simpletuner_models/sd3_large/full_finetune/fantasy_art_L_01/datasets/models&quot;</span><span class="punctuation">,</span></span><br><span class="line">  <span class="attr">&quot;--push_to_hub&quot;</span><span class="punctuation">:</span> <span class="keyword">false</span><span class="punctuation">,</span></span><br><span class="line">  <span class="attr">&quot;--push_checkpoints_to_hub&quot;</span><span class="punctuation">:</span> <span class="keyword">true</span><span class="punctuation">,</span></span><br><span class="line">  <span class="attr">&quot;--hub_model_id&quot;</span><span class="punctuation">:</span> <span class="string">&quot;sd35-training&quot;</span><span class="punctuation">,</span></span><br><span class="line">  <span class="attr">&quot;--resolution&quot;</span><span class="punctuation">:</span> <span class="number">1024</span><span class="punctuation">,</span></span><br><span class="line">  <span class="attr">&quot;--resolution_type&quot;</span><span class="punctuation">:</span> <span class="string">&quot;pixel&quot;</span><span class="punctuation">,</span></span><br><span class="line">  <span class="attr">&quot;--minimum_image_size&quot;</span><span class="punctuation">:</span> <span class="number">1024</span><span class="punctuation">,</span></span><br><span class="line">  <span class="attr">&quot;--instance_prompt&quot;</span><span class="punctuation">:</span> <span class="string">&quot;k4s4 &quot;</span><span class="punctuation">,</span></span><br><span class="line">  <span class="attr">&quot;--validation_prompt&quot;</span><span class="punctuation">:</span> <span class="string">&quot;k4s4, a waist up view of a beautiful blonde woman, green eyes&quot;</span><span class="punctuation">,</span></span><br><span class="line">  <span class="attr">&quot;--validation_guidance&quot;</span><span class="punctuation">:</span> <span class="number">7.5</span><span class="punctuation">,</span></span><br><span class="line">  <span class="attr">&quot;--validation_guidance_rescale&quot;</span><span class="punctuation">:</span> <span class="number">0.0</span><span class="punctuation">,</span></span><br><span class="line">  <span class="attr">&quot;--validation_steps&quot;</span><span class="punctuation">:</span> <span class="number">200</span><span class="punctuation">,</span></span><br><span class="line">  <span class="attr">&quot;--validation_num_inference_steps&quot;</span><span class="punctuation">:</span> <span class="number">30</span><span class="punctuation">,</span></span><br><span class="line">  <span class="attr">&quot;--validation_negative_prompt&quot;</span><span class="punctuation">:</span> <span class="string">&quot;blurry, cropped, ugly&quot;</span><span class="punctuation">,</span></span><br><span class="line">  <span class="attr">&quot;--validation_seed&quot;</span><span class="punctuation">:</span> <span class="number">42</span><span class="punctuation">,</span></span><br><span class="line">  <span class="attr">&quot;--validation_resolution&quot;</span><span class="punctuation">:</span> <span class="number">1024</span><span class="punctuation">,</span></span><br><span class="line">  <span class="attr">&quot;--train_batch_size&quot;</span><span class="punctuation">:</span> <span class="number">6</span><span class="punctuation">,</span></span><br><span class="line">  <span class="attr">&quot;--gradient_accumulation_steps&quot;</span><span class="punctuation">:</span> <span class="number">1</span><span class="punctuation">,</span></span><br><span class="line">  <span class="attr">&quot;--lr_scheduler&quot;</span><span class="punctuation">:</span> <span class="string">&quot;cosine&quot;</span><span class="punctuation">,</span></span><br><span class="line">  <span class="attr">&quot;--lr_warmup_steps&quot;</span><span class="punctuation">:</span> <span class="number">2400</span><span class="punctuation">,</span></span><br><span class="line">  <span class="attr">&quot;--caption_dropout_probability&quot;</span><span class="punctuation">:</span> <span class="number">0</span><span class="punctuation">,</span></span><br><span class="line">  <span class="attr">&quot;--metadata_update_interval&quot;</span><span class="punctuation">:</span> <span class="number">65</span><span class="punctuation">,</span></span><br><span class="line">  <span class="attr">&quot;--vae_batch_size&quot;</span><span class="punctuation">:</span> <span class="number">12</span><span class="punctuation">,</span></span><br><span class="line">  <span class="attr">&quot;--delete_unwanted_images&quot;</span><span class="punctuation">:</span> <span class="keyword">false</span><span class="punctuation">,</span></span><br><span class="line">  <span class="attr">&quot;--delete_problematic_images&quot;</span><span class="punctuation">:</span> <span class="keyword">false</span><span class="punctuation">,</span></span><br><span class="line">  <span class="attr">&quot;--training_scheduler_timestep_spacing&quot;</span><span class="punctuation">:</span> <span class="string">&quot;trailing&quot;</span><span class="punctuation">,</span></span><br><span class="line">  <span class="attr">&quot;--inference_scheduler_timestep_spacing&quot;</span><span class="punctuation">:</span> <span class="string">&quot;trailing&quot;</span><span class="punctuation">,</span></span><br><span class="line">  <span class="attr">&quot;--snr_gamma&quot;</span><span class="punctuation">:</span> <span class="number">5</span><span class="punctuation">,</span></span><br><span class="line">  <span class="attr">&quot;--enable_xformers_memory_efficient_attention&quot;</span><span class="punctuation">:</span> <span class="keyword">true</span><span class="punctuation">,</span></span><br><span class="line">  <span class="attr">&quot;--gradient_checkpointing&quot;</span><span class="punctuation">:</span> <span class="keyword">true</span><span class="punctuation">,</span></span><br><span class="line">  <span class="attr">&quot;--allow_tf32&quot;</span><span class="punctuation">:</span> <span class="keyword">true</span><span class="punctuation">,</span></span><br><span class="line">  <span class="attr">&quot;--optimizer&quot;</span><span class="punctuation">:</span> <span class="string">&quot;adamw_bf16&quot;</span><span class="punctuation">,</span></span><br><span class="line">  <span class="attr">&quot;--use_ema&quot;</span><span class="punctuation">:</span> <span class="keyword">false</span><span class="punctuation">,</span></span><br><span class="line">  <span class="attr">&quot;--ema_decay&quot;</span><span class="punctuation">:</span> <span class="number">0.999</span><span class="punctuation">,</span></span><br><span class="line">  <span class="attr">&quot;--seed&quot;</span><span class="punctuation">:</span> <span class="number">42</span><span class="punctuation">,</span></span><br><span class="line">  <span class="attr">&quot;--mixed_precision&quot;</span><span class="punctuation">:</span> <span class="string">&quot;bf16&quot;</span><span class="punctuation">,</span></span><br><span class="line">  <span class="attr">&quot;--lora_rank&quot;</span><span class="punctuation">:</span> <span class="number">768</span><span class="punctuation">,</span></span><br><span class="line">  <span class="attr">&quot;--lora_alpha&quot;</span><span class="punctuation">:</span> <span class="number">768</span><span class="punctuation">,</span></span><br><span class="line">  <span class="attr">&quot;--lora_type&quot;</span><span class="punctuation">:</span> <span class="string">&quot;standard&quot;</span></span><br><span class="line"><span class="punctuation">&#125;</span></span><br></pre></td></tr></table></figure></li>
</ul>
<p>ì´ì œ ì‚¬ìš©ì ì •ì˜ êµ¬ì„±ì—ì„œ ì´ëŸ¬í•œ ì„¤ì •ì„ ë‹¤ë£¨ê² ìŠµë‹ˆë‹¤.</p>
<figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="punctuation">&#123;</span></span><br><span class="line">  <span class="attr">&quot;--checkpointing_steps&quot;</span><span class="punctuation">:</span> <span class="number">400</span><span class="punctuation">,</span></span><br><span class="line">  <span class="attr">&quot;--checkpoints_total_limit&quot;</span><span class="punctuation">:</span> <span class="number">60</span><span class="punctuation">,</span></span><br><span class="line">  <span class="attr">&quot;--learning_rate&quot;</span><span class="punctuation">:</span> <span class="number">1.05e-3</span><span class="punctuation">,</span></span><br><span class="line">  <span class="attr">&quot;--max_train_steps&quot;</span><span class="punctuation">:</span> <span class="number">24000</span></span><br><span class="line"><span class="punctuation">&#125;</span></span><br></pre></td></tr></table></figure>

<h3 id="Steps-calculation"><a href="#Steps-calculation" class="headerlink" title="Steps calculation"></a>Steps calculation</h3><p>ìµœëŒ€ í›ˆë ¨ ë‹¨ê³„ëŠ” ê°„ë‹¨í•œ ìˆ˜í•™ ë°©ì •ì‹ì„ ê¸°ë°˜ìœ¼ë¡œ ê³„ì‚°í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤(<strong>ë‹¨ì¼ ê°œë…</strong>ì˜ ê²½ìš°).</p>
<p>$$<br>\text{Max training steps} &#x3D; \left(\frac{\text{Number of samples} \times \text{Repeats}}{\text{Batch size}}\right) \times \text{Epochs}<br>$$</p>
<p>ì—¬ê¸°ì—ëŠ” ë„¤ ê°€ì§€ ë³€ìˆ˜ê°€ ìˆìŠµë‹ˆë‹¤.</p>
<ul>
<li>ë°°ì¹˜ í¬ê¸°: í•œ ë²ˆì˜ ë°˜ë³µìœ¼ë¡œ ì²˜ë¦¬ë˜ëŠ” ìƒ˜í”Œ ìˆ˜ì…ë‹ˆë‹¤.</li>
<li>ìƒ˜í”Œ ìˆ˜: ë°ì´í„° ì„¸íŠ¸ì˜ ì´ ìƒ˜í”Œ ìˆ˜ì…ë‹ˆë‹¤.</li>
<li>ë°˜ë³µ íšŸìˆ˜: í•œ ì—í¬í¬ ë‚´ì—ì„œ ë°ì´í„° ì„¸íŠ¸ë¥¼ ë°˜ë³µí•˜ëŠ” íšŸìˆ˜ì…ë‹ˆë‹¤.</li>
<li>Epochs: ì „ì²´ ë°ì´í„°ì„¸íŠ¸ê°€ ì²˜ë¦¬ë˜ëŠ” íšŸìˆ˜ì…ë‹ˆë‹¤.</li>
</ul>
<p>â€˜fantasy artâ€™ ë°ì´í„°ì„¸íŠ¸ì—ëŠ” â€˜476â€™ ì´ë¯¸ì§€ê°€ ìˆìŠµë‹ˆë‹¤. <code>multidatabackend.json</code>ì˜ <code>5</code> ë°˜ë³µ ìœ„ì— ì¶”ê°€í•©ë‹ˆë‹¤. ë‚˜ëŠ” ë‘ ê°€ì§€ ì´ìœ ë¡œ <code>train_batch_size</code>ë¥¼ <code>6</code>ìœ¼ë¡œ ì„ íƒí–ˆìŠµë‹ˆë‹¤:</p>
<ol>
<li>ì´ ê°’ì„ ì‚¬ìš©í•˜ë©´ ì§„í–‰ë¥  í‘œì‹œì¤„ì´ 1~2ì´ˆë§ˆë‹¤ ì—…ë°ì´íŠ¸ë˜ëŠ” ê²ƒì„ ë³¼ ìˆ˜ ìˆìŠµë‹ˆë‹¤.</li>
<li>í•œ ë²ˆì˜ ë°˜ë³µìœ¼ë¡œ â€˜6â€™ê°œì˜ ìƒ˜í”Œì„ ì·¨í•  ìˆ˜ ìˆì„ ë§Œí¼ ì¶©ë¶„íˆ í¬ë¯€ë¡œ í›ˆë ¨ ê³¼ì •ì—ì„œ ë” ë§ì€ ì¼ë°˜í™”ê°€ ì´ë£¨ì–´ì§€ë„ë¡ í•©ë‹ˆë‹¤.</li>
</ol>
<p>30ê°œ ì •ë„ì˜ ì—í¬í¬ë¥¼ ì›í–ˆë‹¤ë©´ ìµœì¢… ê³„ì‚°ì€ ë‹¤ìŒê³¼ ê°™ìŠµë‹ˆë‹¤.</p>
<p>$$<br>\text{Max training steps} &#x3D; \left(\frac{\text{476} \times \text{5}}{\text{6}}\right) \times \text{30}<br>$$</p>
<p>ì´ëŠ” ëŒ€ëµ â€˜11,900â€™ ë‹¨ê³„ì™€ ê°™ìŠµë‹ˆë‹¤.</p>
<p>ê´„í˜¸ ì•ˆì˜ ë¶€ë¶„:</p>
<p>$$<br>\left(\frac{\text{476} \times \text{5}}{\text{6}}\right)<br>$$</p>
<p>ëŠ” ì—í¬í¬ë‹¹ ë‹¨ê³„ ìˆ˜, ì¦‰ â€˜396â€™ì„ ë‚˜íƒ€ëƒ…ë‹ˆë‹¤.</p>
<p>ë”°ë¼ì„œ <code>CHECKPOINTING_STEPS</code>ì— ëŒ€í•´ ì´ ê°’ì„ <code>400</code>ìœ¼ë¡œ ë°˜ì˜¬ë¦¼í–ˆìŠµë‹ˆë‹¤.</p>
<p><a target="_blank" rel="external nofollow noopener noreferrer" href="https://emojipedia.org/warning">**âš ï¸</a>** <code>MAX_NUM_STEPS</code>ì— ëŒ€í•´ <code>11,900</code>ì„ ê³„ì‚°í–ˆì§€ë§Œ ê²°êµ­ <code>24,000</code>ìœ¼ë¡œ ì„¤ì •í–ˆìŠµë‹ˆë‹¤. LoRA í›ˆë ¨ ìƒ˜í”Œì„ ë” ë³´ê³  ì‹¶ì—ˆìŠµë‹ˆë‹¤. ë”°ë¼ì„œ ì›ë˜ â€˜11,900â€™ ì´í›„ì˜ ëª¨ë“  ê°’ì€ ë‚´ê°€ ê³¼ë„í•œ í›ˆë ¨ì„ í–ˆëŠ”ì§€ ì—¬ë¶€ì— ëŒ€í•œ ì¢‹ì€ ì²™ë„ê°€ ë  ê²ƒì…ë‹ˆë‹¤. ê·¸ë˜ì„œ ì´ ë‹¨ê³„ <code>11,900</code> x <code>2</code> &#x3D; <code>23,800</code>ì„ ë‘ ë°°ë¡œ ëŠ˜ë¦° ë‹¤ìŒ ë°˜ì˜¬ë¦¼í–ˆìŠµë‹ˆë‹¤.</p>
<p><code>CHECKPOINTING_STEPS</code>ëŠ” ëª¨ë¸ ì²´í¬í¬ì¸íŠ¸ë¥¼ ì €ì¥í•˜ë ¤ëŠ” ë¹ˆë„ë¥¼ ë‚˜íƒ€ëƒ…ë‹ˆë‹¤. â€˜400â€™ìœ¼ë¡œ ì„¤ì •í•˜ëŠ” ê²ƒì€ ì œê²ŒëŠ” í•œ ì‹œëŒ€ì— ê½¤ ê°€ê¹ê¸° ë•Œë¬¸ì— ê´œì°®ì•„ ë³´ì˜€ìŠµë‹ˆë‹¤.</p>
<p><code>CHECKPOINTING_LIMIT</code>ì€ ì´ì „ ì²´í¬í¬ì¸íŠ¸ë¥¼ ë®ì–´ì“°ê¸° ì „ì— ì €ì¥í•˜ë ¤ëŠ” ì²´í¬í¬ì¸íŠ¸ ìˆ˜ì…ë‹ˆë‹¤. ì œ ê²½ìš°ì—ëŠ” ì²´í¬í¬ì¸íŠ¸ë¥¼ ëª¨ë‘ ìœ ì§€í•˜ê³  ì‹¶ì–´ì„œ â€˜60â€™ì²˜ëŸ¼ ë†’ì€ ìˆ«ìë¡œ ì œí•œì„ ë‘ì—ˆìŠµë‹ˆë‹¤.</p>
<h3 id="Multiple-concepts"><a href="#Multiple-concepts" class="headerlink" title="Multiple concepts"></a>Multiple concepts</h3><p>The above example is trained on a single concept with one unifying trigger word at the beginning: <code>k4s4</code>. However, if your dataset has multiple concepts&#x2F;trigger words, then your step calculation could be something like this so:</p>
<p><code>2</code> concepts <code>[a, b]</code></p>
<p>$$<br>\text{Max steps} &#x3D; \left(\frac{N_a \times R_a + N_b \times R_b}{\text{Batch size}}\right) \times \text{Epochs}<br>$$</p>
<p><code>i</code> concepts</p>
<p>$$<br>\text{Max steps} &#x3D; \left(\frac{\sum_{i \in C} N_i \times R_i}{\text{Batch size}}\right) \times \text{Epochs}<br>$$</p>
<p>ë§ˆì§€ë§‰ìœ¼ë¡œ í•™ìŠµë¥ ì˜ ê²½ìš° â€˜1.5e-3â€™ìœ¼ë¡œ ì„¤ì •í–ˆìŠµë‹ˆë‹¤. ë” ë†’ì„ìˆ˜ë¡ ê¸°ìš¸ê¸°ê°€ ë‹¤ìŒê³¼ ê°™ì´ í­ë°œí•˜ê¸° ë•Œë¬¸ì…ë‹ˆë‹¤.</p>
<p>ë‹¤ë¥¸ ê´€ë ¨ ì„¤ì •ì€ â€˜LoRAâ€™ì™€ ê´€ë ¨ì´ ìˆìŠµë‹ˆë‹¤.</p>
<figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="punctuation">&#123;</span></span><br><span class="line">  <span class="attr">&quot;--lora_rank&quot;</span><span class="punctuation">:</span> <span class="number">768</span><span class="punctuation">,</span></span><br><span class="line">  <span class="attr">&quot;--lora_alpha&quot;</span><span class="punctuation">:</span> <span class="number">768</span><span class="punctuation">,</span></span><br><span class="line">  <span class="attr">&quot;--lora_type&quot;</span><span class="punctuation">:</span> <span class="string">&quot;standard&quot;</span></span><br><span class="line"><span class="punctuation">&#125;</span></span><br></pre></td></tr></table></figure>


<p>ê°œì¸ì ìœ¼ë¡œëŠ” ì¢€ ë” ë†’ì€ â€˜LoRAâ€™ ë­í¬ì™€ ì•ŒíŒŒë¥¼ ì‚¬ìš©í•´ ì•„ì£¼ ë§Œì¡±ìŠ¤ëŸ¬ìš´ ê²°ê³¼ë¥¼ ì–»ì—ˆìŠµë‹ˆë‹¤. ë‚´ YouTube <a target="_blank" rel="external nofollow noopener noreferrer" href="https://youtube.com/@kasukanra">ì±„ë„</a>ì—ì„œ â€˜LoRAâ€™ ìˆœìœ„ë¥¼ ë†’ì¼ìˆ˜ë¡ ì´ë¯¸ì§€ ì¶©ì‹¤ë„ê°€ ì–´ë–»ê²Œ ì¦ê°€í•˜ëŠ”ì§€ì— ëŒ€í•œ ë³´ë‹¤ ì •í™•í•œ ê²½í—˜ì  ë¶„ì„ì„ ë³´ë ¤ë©´ ìµœì‹  ë™ì˜ìƒì„ ì‹œì²­í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤. .</p>
<p>ì–´ì¨Œë“  VRAM, ì €ì¥ ìš©ëŸ‰ ë˜ëŠ” ê·¸ë ‡ê²Œ ë†’ì•„ì§ˆ ì‹œê°„ì´ ì—†ë‹¤ë©´ â€˜256â€™ ë˜ëŠ” â€˜128â€™ê³¼ ê°™ì´ ë” ë‚®ì€ ê°’ì„ ì„ íƒí•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.</p>
<p><code>lora_type</code>ì— ê´€í•´ì„œëŠ”, ë‚˜ëŠ” ì‹œë„ë˜ê³  ì§„ì‹¤ëœ <code>standard</code>ë¥¼ ì‚¬ìš©í•˜ê² ìŠµë‹ˆë‹¤. â€˜LoRAâ€™ì˜ â€˜lycorisâ€™ ìœ í˜•ì— ëŒ€í•œ ë˜ ë‹¤ë¥¸ ì˜µì…˜ì´ ìˆì§€ë§Œ ì•„ì§ì€ ë§¤ìš° ì‹¤í—˜ì ì´ë©° ì˜ íƒìƒ‰ë˜ì§€ ì•Šì•˜ìŠµë‹ˆë‹¤. ë‚˜ëŠ” â€˜lycorisâ€™ì— ëŒ€í•´ ì§ì ‘ ì‹¬ì¸µ ë¶„ì„í–ˆì§€ë§Œ ë§Œì¡±ìŠ¤ëŸ¬ìš´ ê²°ê³¼ë¥¼ ì–»ì„ ìˆ˜ ìˆëŠ” ì˜¬ë°”ë¥¸ ì„¤ì •ì„ ì°¾ì§€ ëª»í–ˆìŠµë‹ˆë‹¤.</p>
<h3 id="Custom-config-json-miscellaneous"><a href="#Custom-config-json-miscellaneous" class="headerlink" title="Custom config.json miscellaneous"></a>Custom <code>config.json</code> miscellaneous</h3><p>ì‚¶ì˜ ì§ˆì„ ìœ„í•´ ë³€ê²½í•  ìˆ˜ ìˆëŠ” ëª‡ ê°€ì§€ ì¶”ê°€ ì„¤ì •ì´ ìˆìŠµë‹ˆë‹¤.</p>
<figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="punctuation">&#123;</span></span><br><span class="line">  <span class="attr">&quot;--validation_prompt&quot;</span><span class="punctuation">:</span> <span class="string">&quot;k4s4, a waist up view of a beautiful blonde woman, green eyes&quot;</span><span class="punctuation">,</span></span><br><span class="line">  <span class="attr">&quot;--validation_guidance&quot;</span><span class="punctuation">:</span> <span class="number">7.5</span><span class="punctuation">,</span></span><br><span class="line">  <span class="attr">&quot;--validation_steps&quot;</span><span class="punctuation">:</span> <span class="number">200</span><span class="punctuation">,</span></span><br><span class="line">  <span class="attr">&quot;--validation_num_inference_steps&quot;</span><span class="punctuation">:</span> <span class="number">30</span><span class="punctuation">,</span></span><br><span class="line">  <span class="attr">&quot;--validation_negative_prompt&quot;</span><span class="punctuation">:</span> <span class="string">&quot;blurry, cropped, ugly&quot;</span><span class="punctuation">,</span></span><br><span class="line">  <span class="attr">&quot;--validation_seed&quot;</span><span class="punctuation">:</span> <span class="number">42</span><span class="punctuation">,</span></span><br><span class="line">  <span class="attr">&quot;--lr_scheduler&quot;</span><span class="punctuation">:</span> <span class="string">&quot;cosine&quot;</span><span class="punctuation">,</span></span><br><span class="line">  <span class="attr">&quot;--lr_warmup_steps&quot;</span><span class="punctuation">:</span> <span class="number">2400</span><span class="punctuation">,</span></span><br><span class="line"><span class="punctuation">&#125;</span></span><br></pre></td></tr></table></figure>

<p><code>&quot;--validation_prompt&quot;: &quot;k4s4, a waist up view of a beautiful blonde woman, green eyes&quot;</code></p>
<p><code>&quot;--validation_guidance&quot;: 7.5</code><br><code>&quot;--validation_steps&quot;: 200</code><br><code>&quot;--validation_num_inference_steps&quot;: 30</code><br><code>&quot;--validation_negative_prompt&quot;: &quot;blurry, cropped, ugly&quot;</code></p>
<p><code>&quot;--lr_scheduler&quot;: &quot;cosine&quot;</code></p>
<p><code>&quot;--lr_warmup_steps&quot;: 2400</code></p>
<p>ì´ê²ƒë“¤ì€ ë§¤ìš° ìëª…í•©ë‹ˆë‹¤:</p>
<p><code>&quot;--validation_prompt&quot;</code></p>
<p>ê²€ì¦ ì´ë¯¸ì§€ë¥¼ ìƒì„±í•˜ëŠ” ë° ì‚¬ìš©í•  í”„ë¡¬í”„íŠ¸ì…ë‹ˆë‹¤. ì´ê²ƒì´ ë‹¹ì‹ ì˜ ê¸ì •ì ì¸ ë©”ì‹œì§€ì…ë‹ˆë‹¤.</p>
<p><code>&quot;--validation_negative_prompt&quot;</code></p>
<p>ë¶€ì •ì ì¸ í”„ë¡¬í”„íŠ¸.</p>
<p><code>&quot;--validation_guidance&quot;</code></p>
<p>Classifier free guidance (CFG) scale.</p>
<p><code>&quot;--validation_num_inference_steps&quot;</code></p>
<p>ì‚¬ìš©í•  ìƒ˜í”Œë§ ë‹¨ê³„ ìˆ˜ì…ë‹ˆë‹¤.</p>
<p><code>&quot;--validation_seed&quot;</code></p>
<p>ê²€ì¦ ì´ë¯¸ì§€ ìƒì„± ì‹œ ì‹œë“œ ê°’ì…ë‹ˆë‹¤.</p>
<p><code>&quot;--lr_warmup_steps&quot;</code></p>
<p>â€˜SimpleTunerâ€™ëŠ” ì„¤ì •í•˜ì§€ ì•Šì„ ê²½ìš° ê¸°ë³¸ ì›Œë°ì—…ì„ ì „ì²´ í›ˆë ¨ ë‹¨ê³„ì˜ â€˜10%â€™ë¡œ ì„¤ì •í–ˆëŠ”ë°, ì´ëŠ” ì œê°€ ìì£¼ ì‚¬ìš©í•˜ëŠ” ê°’ì…ë‹ˆë‹¤. ê·¸ë˜ì„œ (<code>24,000</code> * <code>0.1</code> &#x3D; <code>2,400</code>)ì— í•˜ë“œì½”ë”©í–ˆìŠµë‹ˆë‹¤. ììœ ë¡­ê²Œ ë³€ê²½í•´ ë³´ì„¸ìš”.</p>
<p><code>&quot;--validation_steps&quot;</code></p>
<p>ê²€ì¦ ì´ë¯¸ì§€ë¥¼ ìƒì„±í•˜ë ¤ëŠ” ë¹ˆë„ëŠ” <code>&quot;--validation_steps&quot;</code>ë¡œ ì„¤ì •ë©ë‹ˆë‹¤. ì €ëŠ” 400ì˜ 1&#x2F;2ì¸ 200ìœ¼ë¡œ ì„¤ì •í–ˆìŠµë‹ˆë‹¤(íŒíƒ€ì§€ ì•„íŠ¸ ì˜ˆì œ ë°ì´í„°ì„¸íŠ¸ì— ëŒ€í•œ í•œ ì‹œëŒ€ì˜ ë‹¨ê³„ ìˆ˜). ì´ëŠ” ì—í¬í¬ì˜ 1&#x2F;2ë§ˆë‹¤ ê²€ì¦ ì´ë¯¸ì§€ë¥¼ ìƒì„±í•œë‹¤ëŠ” ì˜ë¯¸ì…ë‹ˆë‹¤. ì˜¨ì „í•œ í™•ì¸ì„ ìœ„í•´ ìµœì†Œí•œ ë°˜ê¸°ì ë§ˆë‹¤ ê²€ì¦ ì´ë¯¸ì§€ë¥¼ ìƒì„±í•˜ëŠ” ê²ƒì´ ì¢‹ìŠµë‹ˆë‹¤. ê·¸ë ‡ì§€ ì•Šìœ¼ë©´ ìµœëŒ€í•œ ë¹¨ë¦¬ ì˜¤ë¥˜ë¥¼ í¬ì°©í•˜ì§€ ëª»í•  ìˆ˜ë„ ìˆìŠµë‹ˆë‹¤.</p>
<p>ë§ˆì§€ë§‰ìœ¼ë¡œ <code>&quot;--lr_scheduler&quot;</code>ì™€ <code>&quot;--lr_warmup_steps&quot;</code>ì…ë‹ˆë‹¤.</p>
<p>ì €ëŠ” â€˜ì½”ì‚¬ì¸â€™ ìŠ¤ì¼€ì¤„ëŸ¬ë¥¼ ì‚¬ìš©í–ˆìŠµë‹ˆë‹¤. ë‹¤ìŒê³¼ ê°™ì€ ëª¨ìŠµì…ë‹ˆë‹¤.</p>
<h3 id="What-happened-to-the-low-level-config-env"><a href="#What-happened-to-the-low-level-config-env" class="headerlink" title="What happened to the low-level config.env ?"></a>What happened to the low-level <code>config.env</code> ?</h3><p>ì•ì„œ ì–¸ê¸‰í–ˆë“¯ì´ <code>SimpleTuner</code>ëŠ” ë‚®ì€ ìˆ˜ì¤€ì˜ <code>config.env</code> í˜•ì‹ì—ì„œ ë²—ì–´ë‚˜ ì‚¬ìš© í¸ì˜ì„±ì„ ìœ„í•´ <code>json</code>ì„ ì„ íƒí•˜ëŠ” ê²ƒìœ¼ë¡œ ë³´ì…ë‹ˆë‹¤. ëŒ€ë¶€ë¶„ì˜ ë‹¤ë¥¸ êµìœ¡ ë¦¬í¬ì§€í† ë¦¬ë„ <code>json</code>ì„ ì‚¬ìš©í•©ë‹ˆë‹¤.</p>
<p>ê·¸ëŸ¬ë‚˜ <a target="_blank" rel="external nofollow noopener noreferrer" href="https://github.com/bghira/SimpleTuner/blob/main/helpers/configuration/loader.py#L17">loader.py</a>ì˜ ì½”ë“œë¥¼ ê¸°ë°˜ìœ¼ë¡œ í•˜ìœ„ ìˆ˜ì¤€ <code>config.env</code>ëŠ” ê³„ì† ì§€ì›ë©ë‹ˆë‹¤. . ë˜í•œ ì´ì „ì˜ ë‚®ì€ ìˆ˜ì¤€ <code>config.env</code> íŒŒì¼ì´ ì´ë¯¸ ìˆëŠ” <code>SimpleTuner</code>ì˜ ì´ì „ ì‚¬ìš©ìëŠ” íŒŒì¼ í˜•ì‹ì„ ì „í™˜í•˜ì§€ ì•Šê³ ë„ ì¼ë¶€ ë§¤ê°œë³€ìˆ˜ë¥¼ ì¡°ì •í•˜ì—¬ ì‹ ì†í•˜ê²Œ ì†ë„ë¥¼ ì–»ì„ ìˆ˜ ìˆìŠµë‹ˆë‹¤(í•´ë‹¹ [OPTIONS.MD](https &#x2F;&#x2F;github.com&#x2F;bghira&#x2F;SimpleTuner&#x2F;blob&#x2F;main&#x2F;OPTIONS.md#environment-configuration-variables)).</p>
<h2 id="ì´ëŠ”-ìœ„ì˜-config-jsonê³¼-ë™ì¼í•œ-ë²„ì „ì´ì§€ë§Œ-env-í˜•ì‹ì…ë‹ˆë‹¤"><a href="#ì´ëŠ”-ìœ„ì˜-config-jsonê³¼-ë™ì¼í•œ-ë²„ì „ì´ì§€ë§Œ-env-í˜•ì‹ì…ë‹ˆë‹¤" class="headerlink" title="ì´ëŠ” ìœ„ì˜ config.jsonê³¼ ë™ì¼í•œ ë²„ì „ì´ì§€ë§Œ .env í˜•ì‹ì…ë‹ˆë‹¤."></a>ì´ëŠ” ìœ„ì˜ <code>config.json</code>ê³¼ ë™ì¼í•œ ë²„ì „ì´ì§€ë§Œ <code>.env</code> í˜•ì‹ì…ë‹ˆë‹¤.</h2><ul>
<li><p>Custom SD3.5 Large <code>LoRA</code> <code>config.env</code></p>
  <figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">export</span> MODEL_TYPE=<span class="string">&#x27;lora&#x27;</span></span><br><span class="line"><span class="built_in">export</span> MODEL_FAMILY=<span class="string">&#x27;sd3&#x27;</span></span><br><span class="line"><span class="built_in">export</span> CONTROLNET=<span class="literal">false</span></span><br><span class="line"><span class="built_in">export</span> USE_DORA=<span class="literal">false</span></span><br><span class="line"><span class="comment"># Restart where we left off. Change this to &quot;checkpoint-1234&quot; to start from a specific checkpoint.</span></span><br><span class="line"><span class="built_in">export</span> RESUME_CHECKPOINT=<span class="string">&quot;latest&quot;</span></span><br><span class="line"><span class="built_in">export</span> CHECKPOINTING_STEPS=400</span><br><span class="line"><span class="comment"># This is how many checkpoints we will keep. Two is safe, but three is safer.</span></span><br><span class="line"><span class="built_in">export</span> CHECKPOINTING_LIMIT=60</span><br><span class="line"></span><br><span class="line"><span class="comment"># This is decided as a relatively conservative &#x27;constant&#x27; learning rate.</span></span><br><span class="line"><span class="comment"># Adjust higher or lower depending on how burnt your model becomes.</span></span><br><span class="line"><span class="built_in">export</span> LEARNING_RATE=1.05e-3</span><br><span class="line"></span><br><span class="line"><span class="comment"># Using a Huggingface Hub model:</span></span><br><span class="line"><span class="built_in">export</span> MODEL_NAME=<span class="string">&quot;stabilityai/stable-diffusion-3.5-large&quot;</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># Make DEBUG_EXTRA_ARGS empty to disable wandb.</span></span><br><span class="line"><span class="built_in">export</span> DEBUG_EXTRA_ARGS=<span class="string">&quot;--report_to=wandb&quot;</span></span><br><span class="line"><span class="built_in">export</span> TRACKER_PROJECT_NAME=<span class="string">&quot;sd35-training&quot;</span></span><br><span class="line"><span class="built_in">export</span> TRACKER_RUN_NAME=<span class="string">&quot;simpletuner-fantasy-art-lora-01&quot;</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># Max number of steps OR epochs can be used. Not both.</span></span><br><span class="line"><span class="built_in">export</span> MAX_NUM_STEPS=24000</span><br><span class="line"><span class="built_in">export</span> NUM_EPOCHS=0</span><br><span class="line"></span><br><span class="line"><span class="comment"># A convenient prefix for all of your training paths.</span></span><br><span class="line"><span class="built_in">export</span> DATALOADER_CONFIG=<span class="string">&quot;/weka2/home-yeo/simpletuner_models/sd3_large/full_finetune/fantasy_art_L_01/datasets/multidatabackend.json&quot;</span></span><br><span class="line"><span class="built_in">export</span> OUTPUT_DIR=<span class="string">&quot;/weka2/home-yeo/simpletuner_models/sd3_large/full_finetune/fantasy_art_L_01/datasets/models&quot;</span></span><br><span class="line"><span class="comment"># Set this to &quot;true&quot; to push your model to Hugging Face Hub.</span></span><br><span class="line"><span class="built_in">export</span> PUSH_TO_HUB=<span class="string">&quot;false&quot;</span></span><br><span class="line"><span class="comment"># If PUSH_TO_HUB and PUSH_CHECKPOINTS are both enabled, every saved checkpoint will be pushed to Hugging Face Hub.</span></span><br><span class="line"><span class="built_in">export</span> PUSH_CHECKPOINTS=<span class="string">&quot;true&quot;</span></span><br><span class="line"><span class="comment"># This will be the model name for your final hub upload, eg. &quot;yourusername/yourmodelname&quot;</span></span><br><span class="line"><span class="comment"># It defaults to the wandb project name, but you can override this here.</span></span><br><span class="line"><span class="comment"># export HUB_MODEL_NAME=$TRACKER_PROJECT_NAME</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># By default, images will be resized so their SMALLER EDGE is 1024 pixels, maintaining aspect ratio.</span></span><br><span class="line"><span class="comment"># Setting this value to 768px might result in more reasonable training data sizes for SDXL.</span></span><br><span class="line"><span class="built_in">export</span> RESOLUTION=1024</span><br><span class="line"><span class="comment"># If you want to have the training data resized by pixel area (Megapixels) rather than edge length,</span></span><br><span class="line"><span class="comment">#  set this value to &quot;area&quot; instead of &quot;pixel&quot;, and uncomment the next RESOLUTION declaration.</span></span><br><span class="line"><span class="built_in">export</span> RESOLUTION_TYPE=<span class="string">&quot;pixel&quot;</span></span><br><span class="line"><span class="comment">#export RESOLUTION=1          # 1.0 Megapixel training sizes</span></span><br><span class="line"><span class="comment"># If RESOLUTION_TYPE=&quot;pixel&quot;, the minimum resolution specifies the smaller edge length, measured in pixels. Recommended: 1024.</span></span><br><span class="line"><span class="comment"># If RESOLUTION_TYPE=&quot;area&quot;, the minimum resolution specifies the total image area, measured in megapixels. Recommended: 1.</span></span><br><span class="line"><span class="built_in">export</span> MINIMUM_RESOLUTION=1024</span><br><span class="line"></span><br><span class="line"><span class="comment"># How many decimals to round aspect buckets to.</span></span><br><span class="line"><span class="comment">#export ASPECT_BUCKET_ROUNDING=2</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># Use this to append an instance prompt to each caption, used for adding trigger words.</span></span><br><span class="line"><span class="comment"># This has not been tested in SDXL.</span></span><br><span class="line"><span class="built_in">export</span> INSTANCE_PROMPT=<span class="string">&quot;k4s4 &quot;</span></span><br><span class="line"><span class="comment"># If you also supply a user prompt library or `--use_prompt_library`, this will be added to those lists.</span></span><br><span class="line"><span class="built_in">export</span> VALIDATION_PROMPT=<span class="string">&quot;k4s4, a waist up view of a beautiful blonde woman, green eyes&quot;</span></span><br><span class="line"><span class="built_in">export</span> VALIDATION_GUIDANCE=7.5</span><br><span class="line"><span class="comment"># You&#x27;ll want to set this to 0.7 if you are training a terminal SNR model.</span></span><br><span class="line"><span class="built_in">export</span> VALIDATION_GUIDANCE_RESCALE=0.0</span><br><span class="line"><span class="comment"># How frequently we will save and run a pipeline for validations.</span></span><br><span class="line"><span class="comment"># export VALIDATION_STEPS=200</span></span><br><span class="line"><span class="built_in">export</span> VALIDATION_STEPS=70</span><br><span class="line"><span class="built_in">export</span> VALIDATION_NUM_INFERENCE_STEPS=30</span><br><span class="line"></span><br><span class="line"><span class="built_in">export</span> VALIDATION_NEGATIVE_PROMPT=<span class="string">&quot;blurry, cropped, ugly&quot;</span></span><br><span class="line"><span class="built_in">export</span> VALIDATION_SEED=42</span><br><span class="line"><span class="built_in">export</span> VALIDATION_RESOLUTION=1024</span><br><span class="line"></span><br><span class="line"><span class="comment"># Adjust this for your GPU memory size. This, and resolution, are the biggest VRAM killers.</span></span><br><span class="line"><span class="built_in">export</span> TRAIN_BATCH_SIZE=6</span><br><span class="line"><span class="comment"># Accumulate your update gradient over many steps, to save VRAM while still having higher effective batch size:</span></span><br><span class="line"><span class="comment"># effective batch size = ($TRAIN_BATCH_SIZE * $GRADIENT_ACCUMULATION_STEPS).</span></span><br><span class="line"><span class="built_in">export</span> GRADIENT_ACCUMULATION_STEPS=1</span><br><span class="line"></span><br><span class="line"><span class="comment"># Use any standard scheduler type. constant, polynomial, constant_with_warmup</span></span><br><span class="line"><span class="built_in">export</span> LR_SCHEDULE=<span class="string">&quot;cosine&quot;</span></span><br><span class="line"><span class="comment"># A warmup period allows the model and the EMA weights more importantly to familiarise itself with the current quanta.</span></span><br><span class="line"><span class="comment"># For the cosine or sine type schedules, the warmup period defines the interval between peaks or valleys.</span></span><br><span class="line"><span class="comment"># Use a sine schedule to simulate a warmup period, or a Cosine period to simulate a polynomial start.</span></span><br><span class="line"><span class="comment"># export LR_WARMUP_STEPS=$((MAX_NUM_STEPS / 10))</span></span><br><span class="line"><span class="built_in">export</span> LR_WARMUP_STEPS=2400</span><br><span class="line"></span><br><span class="line"><span class="comment"># Caption dropout probability. Set to 0.1 for 10% of captions dropped out. Set to 0 to disable.</span></span><br><span class="line"><span class="comment"># You may wish to disable dropout if you want to limit your changes strictly to the prompts you show the model.</span></span><br><span class="line"><span class="comment"># You may wish to increase the rate of dropout if you want to more broadly adopt your changes across the model.</span></span><br><span class="line"><span class="built_in">export</span> CAPTION_DROPOUT_PROBABILITY=0</span><br><span class="line"></span><br><span class="line"><span class="built_in">export</span> METADATA_UPDATE_INTERVAL=65</span><br><span class="line"><span class="built_in">export</span> VAE_BATCH_SIZE=12</span><br><span class="line"></span><br><span class="line"><span class="comment"># If this is set, any images that fail to open will be DELETED to avoid re-checking them every time.</span></span><br><span class="line"><span class="built_in">export</span> DELETE_ERRORED_IMAGES=0</span><br><span class="line"><span class="comment"># If this is set, any images that are too small for the minimum resolution size will be DELETED.</span></span><br><span class="line"><span class="built_in">export</span> DELETE_SMALL_IMAGES=0</span><br><span class="line"></span><br><span class="line"><span class="comment"># Bytedance recommends these be set to &quot;trailing&quot; so that inference and training behave in a more congruent manner.</span></span><br><span class="line"><span class="comment"># To follow the original SDXL training strategy, use &quot;leading&quot; instead, though results are generally worse.</span></span><br><span class="line"><span class="built_in">export</span> TRAINING_SCHEDULER_TIMESTEP_SPACING=<span class="string">&quot;trailing&quot;</span></span><br><span class="line"><span class="built_in">export</span> INFERENCE_SCHEDULER_TIMESTEP_SPACING=<span class="string">&quot;trailing&quot;</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># Removing this option or unsetting it uses vanilla training. Setting it reweights the loss by the position of the timestep in the noise schedule.</span></span><br><span class="line"><span class="comment"># A value &quot;5&quot; is recommended by the researchers. A value of &quot;20&quot; is the least impact, and &quot;1&quot; is the most impact.</span></span><br><span class="line"><span class="built_in">export</span> MIN_SNR_GAMMA=5</span><br><span class="line"></span><br><span class="line"><span class="comment"># Set this to an explicit value of &quot;false&quot; to disable Xformers. Probably required for AMD users.</span></span><br><span class="line"><span class="built_in">export</span> USE_XFORMERS=<span class="literal">true</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># There&#x27;s basically no reason to unset this. However, to disable it, use an explicit value of &quot;false&quot;.</span></span><br><span class="line"><span class="comment"># This will save a lot of memory consumption when enabled.</span></span><br><span class="line"><span class="built_in">export</span> USE_GRADIENT_CHECKPOINTING=<span class="literal">true</span></span><br><span class="line"></span><br><span class="line"><span class="comment">##</span></span><br><span class="line"><span class="comment"># Options below here may require a bit more complicated configuration, so they are not simple variables.</span></span><br><span class="line"><span class="comment">##</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># TF32 is great on Ampere or Ada, not sure about earlier generations.</span></span><br><span class="line"><span class="built_in">export</span> ALLOW_TF32=<span class="literal">true</span></span><br><span class="line"><span class="comment"># AdamW 8Bit is a robust and lightweight choice. Adafactor might reduce memory consumption, and Dadaptation is slow and experimental.</span></span><br><span class="line"><span class="comment"># AdamW is the default optimizer, but it uses a lot of memory and is slower than AdamW8Bit or Adafactor.</span></span><br><span class="line"><span class="comment"># Choices: adamw, adamw8bit, adafactor, dadaptation</span></span><br><span class="line"><span class="comment"># export OPTIMIZER=&quot;adamw_bf16&quot;</span></span><br><span class="line"><span class="built_in">export</span> OPTIMIZER=<span class="string">&quot;adamw_bf16&quot;</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># EMA is a strong regularisation method that uses a lot of extra VRAM to hold two copies of the weights.</span></span><br><span class="line"><span class="comment"># This is worthwhile on large training runs, but not so much for smaller training runs.</span></span><br><span class="line"><span class="built_in">export</span> USE_EMA=<span class="literal">false</span></span><br><span class="line"><span class="built_in">export</span> EMA_DECAY=0.999</span><br><span class="line"></span><br><span class="line"><span class="built_in">export</span> TRAINER_EXTRA_ARGS=<span class="string">&quot;--lora_rank=768 --lora_alpha=768&quot;</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># Reproducible training. Set to -1 to disable.</span></span><br><span class="line"><span class="built_in">export</span> TRAINING_SEED=42</span><br><span class="line"></span><br><span class="line"><span class="comment"># Mixed precision is the best. You honestly might need to YOLO it in fp16 mode for Google Colab type setups.</span></span><br><span class="line"><span class="built_in">export</span> MIXED_PRECISION=<span class="string">&quot;bf16&quot;</span></span><br><span class="line"><span class="built_in">export</span> PURE_BF16=<span class="literal">true</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># This has to be changed if you&#x27;re training with multiple GPUs.</span></span><br><span class="line"><span class="built_in">export</span> TRAINING_NUM_PROCESSES=1</span><br><span class="line"><span class="built_in">export</span> TRAINING_NUM_MACHINES=1</span><br><span class="line"><span class="built_in">export</span> ACCELERATE_EXTRA_ARGS=<span class="string">&quot;&quot;</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># With Pytorch 2.1, you might have pretty good luck here.</span></span><br><span class="line"><span class="comment"># If you&#x27;re using aspect bucketing however, each resolution change will recompile. Seriously, just don&#x27;t do it.</span></span><br><span class="line"><span class="comment"># Well, then again... Pytorch 2.2 has support for dynamic shapes. Why not?</span></span><br><span class="line"><span class="built_in">export</span> TRAINING_DYNAMO_BACKEND=<span class="string">&#x27;no&#x27;</span></span><br><span class="line"></span><br><span class="line"><span class="built_in">export</span> TOKENIZERS_PARALLELISM=<span class="literal">false</span></span><br></pre></td></tr></table></figure></li>
</ul>
<p><a target="_blank" rel="external nofollow noopener noreferrer" href="https://emojipedia.org/index-pointing-up">**â˜ï¸</a>** <code>LoRA</code> ìˆœìœ„&#x2F;ì•ŒíŒŒëŠ” <code>TRAINER_EXTRA_ARGS</code> ë³€ìˆ˜ ë‚´ì—ì„œ ë³€ê²½ë  ìˆ˜ ìˆë‹¤ëŠ” ì ì„ ì§€ì í•˜ê³  ì‹¶ìŠµë‹ˆë‹¤.</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">export</span> TRAINER_EXTRA_ARGS=<span class="string">&quot;--lora_rank=768 --lora_alpha=768&quot;</span></span><br></pre></td></tr></table></figure>

<p><a target="_blank" rel="external nofollow noopener noreferrer" href="https://emojipedia.org/warning">**âš ï¸</a>** <code>.env</code> í˜•ì‹ì„ ì‚¬ìš©í•˜ê¸°ë¡œ ê²°ì •í•œ ê²½ìš° ì¸ë¼ì¸ ì£¼ì„, ì°¸ì¡° ë³€ìˆ˜ ë˜ëŠ” ê³„ì‚°ì´ ì—†ëŠ”ì§€ í™•ì¸í•˜ì„¸ìš”. ì´ê²ƒì€ ìƒˆë¡œìš´ <code>SimpleTuner</code> <a target="_blank" rel="external nofollow noopener noreferrer" href="https://github.com/bghira/SimpleTuner/blob/main/helpers/configuration/env_file.py#L94">env ë„ìš°ë¯¸</a>ê°€ ì‘ë™í•˜ëŠ” ë°©ì‹ì´ë¯€ë¡œ ëª¨ë“  ê²ƒì„ í•˜ë“œ ì½”ë”©í•´ì•¼ í•©ë‹ˆë‹¤. . ****ì˜ˆë¥¼ ë“¤ì–´:</p>
<p><strong>Failure case 1 (inline comments):</strong></p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">export</span> LEARNING_RATE=1.05e-3 <span class="comment">#@param &#123;type:&quot;number&quot;&#125;</span></span><br></pre></td></tr></table></figure>

<p><strong>Failure case 2 (reference variable with <code>TRAINER_EXTRA_ARGS</code>):</strong></p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">export</span> TRAINER_EXTRA_ARGS=<span class="string">&quot;<span class="variable">$&#123;TRAINER_EXTRA_ARGS&#125;</span> --offset_noise --noise_offset=0.02&quot;</span></span><br></pre></td></tr></table></figure>

<p><strong>Failure case 3 (calculations)</strong>:</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">export</span> LR_WARMUP_STEPS=$((MAX_NUM_STEPS / <span class="number">10</span>))</span><br></pre></td></tr></table></figure>

<p>ì›í•˜ëŠ” ê²½ìš° ìœ„ì˜ í•˜ìœ„ ìˆ˜ì¤€ <code>config.env</code>ë¥¼ ê¸°ë³¸ ì°¸ì¡°ë¡œ ì‚¬ìš©í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤. í•˜ìœ„ ìˆ˜ì¤€ <code>env</code> íŒŒì¼ì„ ì‚¬ìš©í•˜ê¸°ë¡œ ê²°ì •í•œ ê²½ìš° ìƒìœ„ ìˆ˜ì¤€ <code>config.env</code>ì—ì„œ <code>CONFIG_BACKEND</code>ë¥¼ <code>env</code>ë¡œ ë³€ê²½í•˜ëŠ” ê²ƒì„ ìŠì§€ ë§ˆì„¸ìš”.</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">TRAINING_NUM_PROCESSES=1</span><br><span class="line">TRAINING_NUM_MACHINES=1</span><br><span class="line">TRAINING_DYNAMO_BACKEND=<span class="string">&#x27;no&#x27;</span></span><br><span class="line">MIXED_PRECISION=<span class="string">&#x27;bf16&#x27;</span></span><br><span class="line"><span class="built_in">export</span> CONFIG_BACKEND=<span class="string">&quot;env&quot;</span></span><br><span class="line"><span class="built_in">export</span> ENV=<span class="string">&quot;sd35_fantasy_art_lora&quot;</span></span><br></pre></td></tr></table></figure>

<h2 id="Training-process"><a href="#Training-process" class="headerlink" title="Training process"></a>Training process</h2><p>ë§ˆì§€ë§‰ìœ¼ë¡œ í›ˆë ¨ ê³¼ì •ì„ ì‹œì‘í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤. ì°¸ê³ ìš©ìœ¼ë¡œ í•„ìš”í•œ ëª¨ë“  íŒŒì¼ì„ ì—¬ê¸°ì— ê°€ì ¸ì˜¤ê² ìŠµë‹ˆë‹¤.</p>
<ul>
<li><p>High-level <code>config.env</code></p>
  <figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">TRAINING_NUM_PROCESSES=1</span><br><span class="line">TRAINING_NUM_MACHINES=1</span><br><span class="line">TRAINING_DYNAMO_BACKEND=<span class="string">&#x27;no&#x27;</span></span><br><span class="line">MIXED_PRECISION=<span class="string">&#x27;bf16&#x27;</span></span><br><span class="line"><span class="built_in">export</span> CONFIG_BACKEND=<span class="string">&quot;json&quot;</span></span><br><span class="line"><span class="built_in">export</span> ENV=<span class="string">&quot;sd35_fantasy_art_lora&quot;</span></span><br></pre></td></tr></table></figure>
</li>
<li><p>Custom SD3.5 Large <code>config.json</code> for LoRA training</p>
  <figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br></pre></td><td class="code"><pre><span class="line"><span class="punctuation">&#123;</span></span><br><span class="line">  <span class="attr">&quot;--model_type&quot;</span><span class="punctuation">:</span> <span class="string">&quot;lora&quot;</span><span class="punctuation">,</span></span><br><span class="line">  <span class="attr">&quot;--model_family&quot;</span><span class="punctuation">:</span> <span class="string">&quot;sd3&quot;</span><span class="punctuation">,</span></span><br><span class="line">  <span class="attr">&quot;--resume_from_checkpoint&quot;</span><span class="punctuation">:</span> <span class="string">&quot;latest&quot;</span><span class="punctuation">,</span></span><br><span class="line">  <span class="attr">&quot;--checkpointing_steps&quot;</span><span class="punctuation">:</span> <span class="number">400</span><span class="punctuation">,</span></span><br><span class="line">  <span class="attr">&quot;--checkpoints_total_limit&quot;</span><span class="punctuation">:</span> <span class="number">60</span><span class="punctuation">,</span></span><br><span class="line">  <span class="attr">&quot;--learning_rate&quot;</span><span class="punctuation">:</span> <span class="number">1.05e-3</span><span class="punctuation">,</span></span><br><span class="line">  <span class="attr">&quot;--pretrained_model_name_or_path&quot;</span><span class="punctuation">:</span> <span class="string">&quot;stabilityai/stable-diffusion-3.5-large&quot;</span><span class="punctuation">,</span></span><br><span class="line">  <span class="attr">&quot;--report_to&quot;</span><span class="punctuation">:</span> <span class="string">&quot;wandb&quot;</span><span class="punctuation">,</span></span><br><span class="line">  <span class="attr">&quot;--tracker_project_name&quot;</span><span class="punctuation">:</span> <span class="string">&quot;sd35-training&quot;</span><span class="punctuation">,</span></span><br><span class="line">  <span class="attr">&quot;--tracker_run_name&quot;</span><span class="punctuation">:</span> <span class="string">&quot;simpletuner-fantasy-art-lora-01&quot;</span><span class="punctuation">,</span></span><br><span class="line">  <span class="attr">&quot;--max_train_steps&quot;</span><span class="punctuation">:</span> <span class="number">24000</span><span class="punctuation">,</span></span><br><span class="line">  <span class="attr">&quot;--num_train_epochs&quot;</span><span class="punctuation">:</span> <span class="number">0</span><span class="punctuation">,</span></span><br><span class="line">  <span class="attr">&quot;--data_backend_config&quot;</span><span class="punctuation">:</span> <span class="string">&quot;/weka2/home-yeo/simpletuner_models/sd3_large/full_finetune/fantasy_art_L_01/datasets/multidatabackend.json&quot;</span><span class="punctuation">,</span></span><br><span class="line">  <span class="attr">&quot;--output_dir&quot;</span><span class="punctuation">:</span> <span class="string">&quot;/weka2/home-yeo/simpletuner_models/sd3_large/full_finetune/fantasy_art_L_01/datasets/models&quot;</span><span class="punctuation">,</span></span><br><span class="line">  <span class="attr">&quot;--push_to_hub&quot;</span><span class="punctuation">:</span> <span class="keyword">false</span><span class="punctuation">,</span></span><br><span class="line">  <span class="attr">&quot;--push_checkpoints_to_hub&quot;</span><span class="punctuation">:</span> <span class="keyword">true</span><span class="punctuation">,</span></span><br><span class="line">  <span class="attr">&quot;--hub_model_id&quot;</span><span class="punctuation">:</span> <span class="string">&quot;sd35-training&quot;</span><span class="punctuation">,</span></span><br><span class="line">  <span class="attr">&quot;--resolution&quot;</span><span class="punctuation">:</span> <span class="number">1024</span><span class="punctuation">,</span></span><br><span class="line">  <span class="attr">&quot;--resolution_type&quot;</span><span class="punctuation">:</span> <span class="string">&quot;pixel&quot;</span><span class="punctuation">,</span></span><br><span class="line">  <span class="attr">&quot;--minimum_image_size&quot;</span><span class="punctuation">:</span> <span class="number">1024</span><span class="punctuation">,</span></span><br><span class="line">  <span class="attr">&quot;--instance_prompt&quot;</span><span class="punctuation">:</span> <span class="string">&quot;k4s4 &quot;</span><span class="punctuation">,</span></span><br><span class="line">  <span class="attr">&quot;--validation_prompt&quot;</span><span class="punctuation">:</span> <span class="string">&quot;k4s4, a waist up view of a beautiful blonde woman, green eyes&quot;</span><span class="punctuation">,</span></span><br><span class="line">  <span class="attr">&quot;--validation_guidance&quot;</span><span class="punctuation">:</span> <span class="number">7.5</span><span class="punctuation">,</span></span><br><span class="line">  <span class="attr">&quot;--validation_guidance_rescale&quot;</span><span class="punctuation">:</span> <span class="number">0.0</span><span class="punctuation">,</span></span><br><span class="line">  <span class="attr">&quot;--validation_steps&quot;</span><span class="punctuation">:</span> <span class="number">200</span><span class="punctuation">,</span></span><br><span class="line">  <span class="attr">&quot;--validation_num_inference_steps&quot;</span><span class="punctuation">:</span> <span class="number">30</span><span class="punctuation">,</span></span><br><span class="line">  <span class="attr">&quot;--validation_negative_prompt&quot;</span><span class="punctuation">:</span> <span class="string">&quot;blurry, cropped, ugly&quot;</span><span class="punctuation">,</span></span><br><span class="line">  <span class="attr">&quot;--validation_seed&quot;</span><span class="punctuation">:</span> <span class="number">42</span><span class="punctuation">,</span></span><br><span class="line">  <span class="attr">&quot;--validation_resolution&quot;</span><span class="punctuation">:</span> <span class="number">1024</span><span class="punctuation">,</span></span><br><span class="line">  <span class="attr">&quot;--train_batch_size&quot;</span><span class="punctuation">:</span> <span class="number">6</span><span class="punctuation">,</span></span><br><span class="line">  <span class="attr">&quot;--gradient_accumulation_steps&quot;</span><span class="punctuation">:</span> <span class="number">1</span><span class="punctuation">,</span></span><br><span class="line">  <span class="attr">&quot;--lr_scheduler&quot;</span><span class="punctuation">:</span> <span class="string">&quot;cosine&quot;</span><span class="punctuation">,</span></span><br><span class="line">  <span class="attr">&quot;--lr_warmup_steps&quot;</span><span class="punctuation">:</span> <span class="number">2400</span><span class="punctuation">,</span></span><br><span class="line">  <span class="attr">&quot;--caption_dropout_probability&quot;</span><span class="punctuation">:</span> <span class="number">0</span><span class="punctuation">,</span></span><br><span class="line">  <span class="attr">&quot;--metadata_update_interval&quot;</span><span class="punctuation">:</span> <span class="number">65</span><span class="punctuation">,</span></span><br><span class="line">  <span class="attr">&quot;--vae_batch_size&quot;</span><span class="punctuation">:</span> <span class="number">12</span><span class="punctuation">,</span></span><br><span class="line">  <span class="attr">&quot;--delete_unwanted_images&quot;</span><span class="punctuation">:</span> <span class="keyword">false</span><span class="punctuation">,</span></span><br><span class="line">  <span class="attr">&quot;--delete_problematic_images&quot;</span><span class="punctuation">:</span> <span class="keyword">false</span><span class="punctuation">,</span></span><br><span class="line">  <span class="attr">&quot;--training_scheduler_timestep_spacing&quot;</span><span class="punctuation">:</span> <span class="string">&quot;trailing&quot;</span><span class="punctuation">,</span></span><br><span class="line">  <span class="attr">&quot;--inference_scheduler_timestep_spacing&quot;</span><span class="punctuation">:</span> <span class="string">&quot;trailing&quot;</span><span class="punctuation">,</span></span><br><span class="line">  <span class="attr">&quot;--snr_gamma&quot;</span><span class="punctuation">:</span> <span class="number">5</span><span class="punctuation">,</span></span><br><span class="line">  <span class="attr">&quot;--enable_xformers_memory_efficient_attention&quot;</span><span class="punctuation">:</span> <span class="keyword">true</span><span class="punctuation">,</span></span><br><span class="line">  <span class="attr">&quot;--gradient_checkpointing&quot;</span><span class="punctuation">:</span> <span class="keyword">true</span><span class="punctuation">,</span></span><br><span class="line">  <span class="attr">&quot;--allow_tf32&quot;</span><span class="punctuation">:</span> <span class="keyword">true</span><span class="punctuation">,</span></span><br><span class="line">  <span class="attr">&quot;--optimizer&quot;</span><span class="punctuation">:</span> <span class="string">&quot;adamw_bf16&quot;</span><span class="punctuation">,</span></span><br><span class="line">  <span class="attr">&quot;--use_ema&quot;</span><span class="punctuation">:</span> <span class="keyword">false</span><span class="punctuation">,</span></span><br><span class="line">  <span class="attr">&quot;--ema_decay&quot;</span><span class="punctuation">:</span> <span class="number">0.999</span><span class="punctuation">,</span></span><br><span class="line">  <span class="attr">&quot;--seed&quot;</span><span class="punctuation">:</span> <span class="number">42</span><span class="punctuation">,</span></span><br><span class="line">  <span class="attr">&quot;--mixed_precision&quot;</span><span class="punctuation">:</span> <span class="string">&quot;bf16&quot;</span><span class="punctuation">,</span></span><br><span class="line">  <span class="attr">&quot;--lora_rank&quot;</span><span class="punctuation">:</span> <span class="number">768</span><span class="punctuation">,</span></span><br><span class="line">  <span class="attr">&quot;--lora_alpha&quot;</span><span class="punctuation">:</span> <span class="number">768</span><span class="punctuation">,</span></span><br><span class="line">  <span class="attr">&quot;--lora_type&quot;</span><span class="punctuation">:</span> <span class="string">&quot;standard&quot;</span></span><br><span class="line"><span class="punctuation">&#125;</span></span><br></pre></td></tr></table></figure>
</li>
<li><p>Custom SD3.5 Large  <code>config.env</code> for LoRA training</p>
  <figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br></pre></td><td class="code"><pre><span class="line"> </span><br><span class="line"><span class="built_in">export</span> MODEL_TYPE=<span class="string">&#x27;lora&#x27;</span></span><br><span class="line"><span class="built_in">export</span> MODEL_FAMILY=<span class="string">&#x27;sd3&#x27;</span></span><br><span class="line"><span class="built_in">export</span> CONTROLNET=<span class="literal">false</span></span><br><span class="line"><span class="built_in">export</span> USE_DORA=<span class="literal">false</span></span><br><span class="line"><span class="comment"># Restart where we left off. Change this to &quot;checkpoint-1234&quot; to start from a specific checkpoint.</span></span><br><span class="line"><span class="built_in">export</span> RESUME_CHECKPOINT=<span class="string">&quot;latest&quot;</span></span><br><span class="line"><span class="built_in">export</span> CHECKPOINTING_STEPS=400</span><br><span class="line"><span class="comment"># This is how many checkpoints we will keep. Two is safe, but three is safer.</span></span><br><span class="line"><span class="built_in">export</span> CHECKPOINTING_LIMIT=60</span><br><span class="line"></span><br><span class="line"><span class="comment"># This is decided as a relatively conservative &#x27;constant&#x27; learning rate.</span></span><br><span class="line"><span class="comment"># Adjust higher or lower depending on how burnt your model becomes.</span></span><br><span class="line"><span class="built_in">export</span> LEARNING_RATE=1.05e-3</span><br><span class="line"></span><br><span class="line"><span class="comment"># Using a Huggingface Hub model:</span></span><br><span class="line"><span class="built_in">export</span> MODEL_NAME=<span class="string">&quot;stabilityai/stable-diffusion-3.5-large&quot;</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># Make DEBUG_EXTRA_ARGS empty to disable wandb.</span></span><br><span class="line"><span class="built_in">export</span> DEBUG_EXTRA_ARGS=<span class="string">&quot;--report_to=wandb&quot;</span></span><br><span class="line"><span class="built_in">export</span> TRACKER_PROJECT_NAME=<span class="string">&quot;sd35-training&quot;</span></span><br><span class="line"><span class="built_in">export</span> TRACKER_RUN_NAME=<span class="string">&quot;simpletuner-fantasy-art-lora-01&quot;</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># Max number of steps OR epochs can be used. Not both.</span></span><br><span class="line"><span class="built_in">export</span> MAX_NUM_STEPS=24000</span><br><span class="line"><span class="built_in">export</span> NUM_EPOCHS=0</span><br><span class="line"></span><br><span class="line"><span class="comment"># A convenient prefix for all of your training paths.</span></span><br><span class="line"><span class="built_in">export</span> DATALOADER_CONFIG=<span class="string">&quot;/weka2/home-yeo/simpletuner_models/sd3_large/full_finetune/fantasy_art_L_01/datasets/multidatabackend.json&quot;</span></span><br><span class="line"><span class="built_in">export</span> OUTPUT_DIR=<span class="string">&quot;/weka2/home-yeo/simpletuner_models/sd3_large/full_finetune/fantasy_art_L_01/datasets/models&quot;</span></span><br><span class="line"><span class="comment"># Set this to &quot;true&quot; to push your model to Hugging Face Hub.</span></span><br><span class="line"><span class="built_in">export</span> PUSH_TO_HUB=<span class="string">&quot;false&quot;</span></span><br><span class="line"><span class="comment"># If PUSH_TO_HUB and PUSH_CHECKPOINTS are both enabled, every saved checkpoint will be pushed to Hugging Face Hub.</span></span><br><span class="line"><span class="built_in">export</span> PUSH_CHECKPOINTS=<span class="string">&quot;true&quot;</span></span><br><span class="line"><span class="comment"># This will be the model name for your final hub upload, eg. &quot;yourusername/yourmodelname&quot;</span></span><br><span class="line"><span class="comment"># It defaults to the wandb project name, but you can override this here.</span></span><br><span class="line"><span class="comment"># export HUB_MODEL_NAME=$TRACKER_PROJECT_NAME</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># By default, images will be resized so their SMALLER EDGE is 1024 pixels, maintaining aspect ratio.</span></span><br><span class="line"><span class="comment"># Setting this value to 768px might result in more reasonable training data sizes for SDXL.</span></span><br><span class="line"><span class="built_in">export</span> RESOLUTION=1024</span><br><span class="line"><span class="comment"># If you want to have the training data resized by pixel area (Megapixels) rather than edge length,</span></span><br><span class="line"><span class="comment">#  set this value to &quot;area&quot; instead of &quot;pixel&quot;, and uncomment the next RESOLUTION declaration.</span></span><br><span class="line"><span class="built_in">export</span> RESOLUTION_TYPE=<span class="string">&quot;pixel&quot;</span></span><br><span class="line"><span class="comment">#export RESOLUTION=1          # 1.0 Megapixel training sizes</span></span><br><span class="line"><span class="comment"># If RESOLUTION_TYPE=&quot;pixel&quot;, the minimum resolution specifies the smaller edge length, measured in pixels. Recommended: 1024.</span></span><br><span class="line"><span class="comment"># If RESOLUTION_TYPE=&quot;area&quot;, the minimum resolution specifies the total image area, measured in megapixels. Recommended: 1.</span></span><br><span class="line"><span class="built_in">export</span> MINIMUM_RESOLUTION=1024</span><br><span class="line"></span><br><span class="line"><span class="comment"># How many decimals to round aspect buckets to.</span></span><br><span class="line"><span class="comment">#export ASPECT_BUCKET_ROUNDING=2</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># Use this to append an instance prompt to each caption, used for adding trigger words.</span></span><br><span class="line"><span class="comment"># This has not been tested in SDXL.</span></span><br><span class="line"><span class="built_in">export</span> INSTANCE_PROMPT=<span class="string">&quot;k4s4 &quot;</span></span><br><span class="line"><span class="comment"># If you also supply a user prompt library or `--use_prompt_library`, this will be added to those lists.</span></span><br><span class="line"><span class="built_in">export</span> VALIDATION_PROMPT=<span class="string">&quot;k4s4, a waist up view of a beautiful blonde woman, green eyes&quot;</span></span><br><span class="line"><span class="built_in">export</span> VALIDATION_GUIDANCE=7.5</span><br><span class="line"><span class="comment"># You&#x27;ll want to set this to 0.7 if you are training a terminal SNR model.</span></span><br><span class="line"><span class="built_in">export</span> VALIDATION_GUIDANCE_RESCALE=0.0</span><br><span class="line"><span class="comment"># How frequently we will save and run a pipeline for validations.</span></span><br><span class="line"><span class="comment"># export VALIDATION_STEPS=200</span></span><br><span class="line"><span class="built_in">export</span> VALIDATION_STEPS=70</span><br><span class="line"><span class="built_in">export</span> VALIDATION_NUM_INFERENCE_STEPS=30</span><br><span class="line"></span><br><span class="line"><span class="built_in">export</span> VALIDATION_NEGATIVE_PROMPT=<span class="string">&quot;blurry, cropped, ugly&quot;</span></span><br><span class="line"><span class="built_in">export</span> VALIDATION_SEED=42</span><br><span class="line"><span class="built_in">export</span> VALIDATION_RESOLUTION=1024</span><br><span class="line"></span><br><span class="line"><span class="comment"># Adjust this for your GPU memory size. This, and resolution, are the biggest VRAM killers.</span></span><br><span class="line"><span class="built_in">export</span> TRAIN_BATCH_SIZE=6</span><br><span class="line"><span class="comment"># Accumulate your update gradient over many steps, to save VRAM while still having higher effective batch size:</span></span><br><span class="line"><span class="comment"># effective batch size = ($TRAIN_BATCH_SIZE * $GRADIENT_ACCUMULATION_STEPS).</span></span><br><span class="line"><span class="built_in">export</span> GRADIENT_ACCUMULATION_STEPS=1</span><br><span class="line"></span><br><span class="line"><span class="comment"># Use any standard scheduler type. constant, polynomial, constant_with_warmup</span></span><br><span class="line"><span class="built_in">export</span> LR_SCHEDULE=<span class="string">&quot;cosine&quot;</span></span><br><span class="line"><span class="comment"># A warmup period allows the model and the EMA weights more importantly to familiarise itself with the current quanta.</span></span><br><span class="line"><span class="comment"># For the cosine or sine type schedules, the warmup period defines the interval between peaks or valleys.</span></span><br><span class="line"><span class="comment"># Use a sine schedule to simulate a warmup period, or a Cosine period to simulate a polynomial start.</span></span><br><span class="line"><span class="comment"># export LR_WARMUP_STEPS=$((MAX_NUM_STEPS / 10))</span></span><br><span class="line"><span class="built_in">export</span> LR_WARMUP_STEPS=2400</span><br><span class="line"></span><br><span class="line"><span class="comment"># Caption dropout probability. Set to 0.1 for 10% of captions dropped out. Set to 0 to disable.</span></span><br><span class="line"><span class="comment"># You may wish to disable dropout if you want to limit your changes strictly to the prompts you show the model.</span></span><br><span class="line"><span class="comment"># You may wish to increase the rate of dropout if you want to more broadly adopt your changes across the model.</span></span><br><span class="line"><span class="built_in">export</span> CAPTION_DROPOUT_PROBABILITY=0</span><br><span class="line"></span><br><span class="line"><span class="built_in">export</span> METADATA_UPDATE_INTERVAL=65</span><br><span class="line"><span class="built_in">export</span> VAE_BATCH_SIZE=12</span><br><span class="line"></span><br><span class="line"><span class="comment"># If this is set, any images that fail to open will be DELETED to avoid re-checking them every time.</span></span><br><span class="line"><span class="built_in">export</span> DELETE_ERRORED_IMAGES=0</span><br><span class="line"><span class="comment"># If this is set, any images that are too small for the minimum resolution size will be DELETED.</span></span><br><span class="line"><span class="built_in">export</span> DELETE_SMALL_IMAGES=0</span><br><span class="line"></span><br><span class="line"><span class="comment"># Bytedance recommends these be set to &quot;trailing&quot; so that inference and training behave in a more congruent manner.</span></span><br><span class="line"><span class="comment"># To follow the original SDXL training strategy, use &quot;leading&quot; instead, though results are generally worse.</span></span><br><span class="line"><span class="built_in">export</span> TRAINING_SCHEDULER_TIMESTEP_SPACING=<span class="string">&quot;trailing&quot;</span></span><br><span class="line"><span class="built_in">export</span> INFERENCE_SCHEDULER_TIMESTEP_SPACING=<span class="string">&quot;trailing&quot;</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># Removing this option or unsetting it uses vanilla training. Setting it reweights the loss by the position of the timestep in the noise schedule.</span></span><br><span class="line"><span class="comment"># A value &quot;5&quot; is recommended by the researchers. A value of &quot;20&quot; is the least impact, and &quot;1&quot; is the most impact.</span></span><br><span class="line"><span class="built_in">export</span> MIN_SNR_GAMMA=5</span><br><span class="line"></span><br><span class="line"><span class="comment"># Set this to an explicit value of &quot;false&quot; to disable Xformers. Probably required for AMD users.</span></span><br><span class="line"><span class="built_in">export</span> USE_XFORMERS=<span class="literal">true</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># There&#x27;s basically no reason to unset this. However, to disable it, use an explicit value of &quot;false&quot;.</span></span><br><span class="line"><span class="comment"># This will save a lot of memory consumption when enabled.</span></span><br><span class="line"><span class="built_in">export</span> USE_GRADIENT_CHECKPOINTING=<span class="literal">true</span></span><br><span class="line"></span><br><span class="line"><span class="comment">##</span></span><br><span class="line"><span class="comment"># Options below here may require a bit more complicated configuration, so they are not simple variables.</span></span><br><span class="line"><span class="comment">##</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># TF32 is great on Ampere or Ada, not sure about earlier generations.</span></span><br><span class="line"><span class="built_in">export</span> ALLOW_TF32=<span class="literal">true</span></span><br><span class="line"><span class="comment"># AdamW 8Bit is a robust and lightweight choice. Adafactor might reduce memory consumption, and Dadaptation is slow and experimental.</span></span><br><span class="line"><span class="comment"># AdamW is the default optimizer, but it uses a lot of memory and is slower than AdamW8Bit or Adafactor.</span></span><br><span class="line"><span class="comment"># Choices: adamw, adamw8bit, adafactor, dadaptation</span></span><br><span class="line"><span class="comment"># export OPTIMIZER=&quot;adamw_bf16&quot;</span></span><br><span class="line"><span class="built_in">export</span> OPTIMIZER=<span class="string">&quot;adamw_bf16&quot;</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># EMA is a strong regularisation method that uses a lot of extra VRAM to hold two copies of the weights.</span></span><br><span class="line"><span class="comment"># This is worthwhile on large training runs, but not so much for smaller training runs.</span></span><br><span class="line"><span class="built_in">export</span> USE_EMA=<span class="literal">false</span></span><br><span class="line"><span class="built_in">export</span> EMA_DECAY=0.999</span><br><span class="line"></span><br><span class="line"><span class="built_in">export</span> TRAINER_EXTRA_ARGS=<span class="string">&quot;--lora_rank=768 --lora_alpha=768&quot;</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># Reproducible training. Set to -1 to disable.</span></span><br><span class="line"><span class="built_in">export</span> TRAINING_SEED=42</span><br><span class="line"></span><br><span class="line"><span class="comment"># Mixed precision is the best. You honestly might need to YOLO it in fp16 mode for Google Colab type setups.</span></span><br><span class="line"><span class="built_in">export</span> MIXED_PRECISION=<span class="string">&quot;bf16&quot;</span></span><br><span class="line"><span class="built_in">export</span> PURE_BF16=<span class="literal">true</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># This has to be changed if you&#x27;re training with multiple GPUs.</span></span><br><span class="line"><span class="built_in">export</span> TRAINING_NUM_PROCESSES=1</span><br><span class="line"><span class="built_in">export</span> TRAINING_NUM_MACHINES=1</span><br><span class="line"><span class="built_in">export</span> ACCELERATE_EXTRA_ARGS=<span class="string">&quot;&quot;</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># With Pytorch 2.1, you might have pretty good luck here.</span></span><br><span class="line"><span class="comment"># If you&#x27;re using aspect bucketing however, each resolution change will recompile. Seriously, just don&#x27;t do it.</span></span><br><span class="line"><span class="comment"># Well, then again... Pytorch 2.2 has support for dynamic shapes. Why not?</span></span><br><span class="line"><span class="built_in">export</span> TRAINING_DYNAMO_BACKEND=<span class="string">&#x27;no&#x27;</span></span><br><span class="line"></span><br><span class="line"><span class="built_in">export</span> TOKENIZERS_PARALLELISM=<span class="literal">false</span></span><br></pre></td></tr></table></figure>
</li>
<li><p>Default <a target="_blank" rel="external nofollow noopener noreferrer" href="http://train.sh/">train.sh</a></p>
  <figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#!/usr/bin/env bash</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># Pull config from config.env</span></span><br><span class="line">[ -f <span class="string">&quot;config/config.env&quot;</span> ] &amp;&amp; <span class="built_in">source</span> config/config.env</span><br><span class="line"></span><br><span class="line"><span class="comment"># If the user has not provided VENV_PATH, we will assume $(pwd)/.venv</span></span><br><span class="line"><span class="keyword">if</span> [ -z <span class="string">&quot;<span class="variable">$&#123;VENV_PATH&#125;</span>&quot;</span> ]; <span class="keyword">then</span></span><br><span class="line">    <span class="comment"># what if we have VIRTUAL_ENV? use that instead</span></span><br><span class="line">    <span class="keyword">if</span> [ -n <span class="string">&quot;<span class="variable">$&#123;VIRTUAL_ENV&#125;</span>&quot;</span> ]; <span class="keyword">then</span></span><br><span class="line">        <span class="built_in">export</span> VENV_PATH=<span class="string">&quot;<span class="variable">$&#123;VIRTUAL_ENV&#125;</span>&quot;</span></span><br><span class="line">    <span class="keyword">else</span></span><br><span class="line">        <span class="built_in">export</span> VENV_PATH=<span class="string">&quot;<span class="subst">$(pwd)</span>/.venv&quot;</span></span><br><span class="line">    <span class="keyword">fi</span></span><br><span class="line"><span class="keyword">fi</span></span><br><span class="line"><span class="keyword">if</span> [ -z <span class="string">&quot;<span class="variable">$&#123;DISABLE_LD_OVERRIDE&#125;</span>&quot;</span> ]; <span class="keyword">then</span></span><br><span class="line">    <span class="built_in">export</span> NVJITLINK_PATH=<span class="string">&quot;<span class="subst">$(find <span class="string">&quot;<span class="variable">$&#123;VENV_PATH&#125;</span>&quot;</span> -name nvjitlink -type d)</span>/lib&quot;</span></span><br><span class="line">    <span class="comment"># if it&#x27;s not empty, we will add it to LD_LIBRARY_PATH at the front:</span></span><br><span class="line">    <span class="keyword">if</span> [ -n <span class="string">&quot;<span class="variable">$&#123;NVJITLINK_PATH&#125;</span>&quot;</span> ]; <span class="keyword">then</span></span><br><span class="line">        <span class="built_in">export</span> LD_LIBRARY_PATH=<span class="string">&quot;<span class="variable">$&#123;NVJITLINK_PATH&#125;</span>:<span class="variable">$&#123;LD_LIBRARY_PATH&#125;</span>&quot;</span></span><br><span class="line">    <span class="keyword">fi</span></span><br><span class="line"><span class="keyword">fi</span></span><br><span class="line"></span><br><span class="line"><span class="built_in">export</span> TOKENIZERS_PARALLELISM=<span class="literal">false</span></span><br><span class="line"><span class="built_in">export</span> PLATFORM</span><br><span class="line">PLATFORM=$(<span class="built_in">uname</span> -s)</span><br><span class="line"><span class="keyword">if</span> [[ <span class="string">&quot;<span class="variable">$PLATFORM</span>&quot;</span> == <span class="string">&quot;Darwin&quot;</span> ]]; <span class="keyword">then</span></span><br><span class="line">    <span class="built_in">export</span> MIXED_PRECISION=<span class="string">&quot;no&quot;</span></span><br><span class="line"><span class="keyword">fi</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> [ -z <span class="string">&quot;<span class="variable">$&#123;ACCELERATE_EXTRA_ARGS&#125;</span>&quot;</span> ]; <span class="keyword">then</span></span><br><span class="line">    ACCELERATE_EXTRA_ARGS=<span class="string">&quot;&quot;</span></span><br><span class="line"><span class="keyword">fi</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> [ -z <span class="string">&quot;<span class="variable">$&#123;TRAINING_NUM_PROCESSES&#125;</span>&quot;</span> ]; <span class="keyword">then</span></span><br><span class="line">    <span class="built_in">echo</span> <span class="string">&quot;Set custom env vars permanently in config/config.env:&quot;</span></span><br><span class="line">    <span class="built_in">printf</span> <span class="string">&quot;TRAINING_NUM_PROCESSES not set, defaulting to 1.\n&quot;</span></span><br><span class="line">    TRAINING_NUM_PROCESSES=1</span><br><span class="line"><span class="keyword">fi</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> [ -z <span class="string">&quot;<span class="variable">$&#123;TRAINING_NUM_MACHINES&#125;</span>&quot;</span> ]; <span class="keyword">then</span></span><br><span class="line">    <span class="built_in">printf</span> <span class="string">&quot;TRAINING_NUM_MACHINES not set, defaulting to 1.\n&quot;</span></span><br><span class="line">    TRAINING_NUM_MACHINES=1</span><br><span class="line"><span class="keyword">fi</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> [ -z <span class="string">&quot;<span class="variable">$&#123;MIXED_PRECISION&#125;</span>&quot;</span> ]; <span class="keyword">then</span></span><br><span class="line">    <span class="built_in">printf</span> <span class="string">&quot;MIXED_PRECISION not set, defaulting to bf16.\n&quot;</span></span><br><span class="line">    MIXED_PRECISION=bf16</span><br><span class="line"><span class="keyword">fi</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> [ -z <span class="string">&quot;<span class="variable">$&#123;TRAINING_DYNAMO_BACKEND&#125;</span>&quot;</span> ]; <span class="keyword">then</span></span><br><span class="line">    <span class="built_in">printf</span> <span class="string">&quot;TRAINING_DYNAMO_BACKEND not set, defaulting to no.\n&quot;</span></span><br><span class="line">    TRAINING_DYNAMO_BACKEND=<span class="string">&quot;no&quot;</span></span><br><span class="line"><span class="keyword">fi</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> [ -z <span class="string">&quot;<span class="variable">$&#123;ENV&#125;</span>&quot;</span> ]; <span class="keyword">then</span></span><br><span class="line">    <span class="built_in">printf</span> <span class="string">&quot;ENV not set, defaulting to default.\n&quot;</span></span><br><span class="line">    <span class="built_in">export</span> ENV=<span class="string">&quot;default&quot;</span></span><br><span class="line"><span class="keyword">fi</span></span><br><span class="line"><span class="built_in">export</span> ENV_PATH=<span class="string">&quot;&quot;</span></span><br><span class="line"><span class="keyword">if</span> [[ <span class="string">&quot;<span class="variable">$ENV</span>&quot;</span> != <span class="string">&quot;default&quot;</span> ]]; <span class="keyword">then</span></span><br><span class="line">    <span class="built_in">export</span> ENV_PATH=<span class="string">&quot;<span class="variable">$&#123;ENV&#125;</span>/&quot;</span></span><br><span class="line"><span class="keyword">fi</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> [ -z <span class="string">&quot;<span class="variable">$&#123;CONFIG_BACKEND&#125;</span>&quot;</span> ]; <span class="keyword">then</span></span><br><span class="line">    <span class="keyword">if</span> [ -n <span class="string">&quot;<span class="variable">$&#123;CONFIG_TYPE&#125;</span>&quot;</span> ]; <span class="keyword">then</span></span><br><span class="line">        <span class="built_in">export</span> CONFIG_BACKEND=<span class="string">&quot;<span class="variable">$&#123;CONFIG_TYPE&#125;</span>&quot;</span></span><br><span class="line">    <span class="keyword">fi</span></span><br><span class="line"><span class="keyword">fi</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> [ -z <span class="string">&quot;<span class="variable">$&#123;CONFIG_BACKEND&#125;</span>&quot;</span> ]; <span class="keyword">then</span></span><br><span class="line">    <span class="built_in">export</span> CONFIG_BACKEND=<span class="string">&quot;env&quot;</span></span><br><span class="line">    <span class="built_in">export</span> CONFIG_PATH=<span class="string">&quot;config/<span class="variable">$&#123;ENV_PATH&#125;</span>config&quot;</span></span><br><span class="line">    <span class="keyword">if</span> [ -f <span class="string">&quot;<span class="variable">$&#123;CONFIG_PATH&#125;</span>.json&quot;</span> ]; <span class="keyword">then</span></span><br><span class="line">        <span class="built_in">export</span> CONFIG_BACKEND=<span class="string">&quot;json&quot;</span></span><br><span class="line">    <span class="keyword">elif</span> [ -f <span class="string">&quot;<span class="variable">$&#123;CONFIG_PATH&#125;</span>.toml&quot;</span> ]; <span class="keyword">then</span></span><br><span class="line">        <span class="built_in">export</span> CONFIG_BACKEND=<span class="string">&quot;toml&quot;</span></span><br><span class="line">    <span class="keyword">elif</span> [ -f <span class="string">&quot;<span class="variable">$&#123;CONFIG_PATH&#125;</span>.env&quot;</span> ]; <span class="keyword">then</span></span><br><span class="line">        <span class="built_in">export</span> CONFIG_BACKEND=<span class="string">&quot;env&quot;</span></span><br><span class="line">    <span class="keyword">fi</span></span><br><span class="line">    <span class="built_in">echo</span> <span class="string">&quot;Using <span class="variable">$&#123;CONFIG_BACKEND&#125;</span> backend: <span class="variable">$&#123;CONFIG_PATH&#125;</span>.<span class="variable">$&#123;CONFIG_BACKEND&#125;</span>&quot;</span></span><br><span class="line"><span class="keyword">fi</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># Update dependencies</span></span><br><span class="line"><span class="keyword">if</span> [ -z <span class="string">&quot;<span class="variable">$&#123;DISABLE_UPDATES&#125;</span>&quot;</span> ]; <span class="keyword">then</span></span><br><span class="line">    <span class="built_in">echo</span> <span class="string">&#x27;Updating dependencies. Set DISABLE_UPDATES to prevent this.&#x27;</span></span><br><span class="line">    <span class="keyword">if</span> [ -f <span class="string">&quot;pyproject.toml&quot;</span> ] &amp;&amp; [ -f <span class="string">&quot;poetry.lock&quot;</span> ]; <span class="keyword">then</span></span><br><span class="line">        nvidia-smi 2&gt; /dev/null &amp;&amp; poetry install</span><br><span class="line">        <span class="built_in">uname</span> -s | grep -q Darwin &amp;&amp; poetry install -C install/apple</span><br><span class="line">        rocm-smi 2&gt; /dev/null &amp;&amp; poetry install -C install/rocm</span><br><span class="line">    <span class="keyword">fi</span></span><br><span class="line"><span class="keyword">fi</span></span><br><span class="line"><span class="comment"># Run the training script.</span></span><br><span class="line"><span class="keyword">if</span> [[ -z <span class="string">&quot;<span class="variable">$&#123;ACCELERATE_CONFIG_PATH&#125;</span>&quot;</span> ]]; <span class="keyword">then</span></span><br><span class="line">    ACCELERATE_CONFIG_PATH=<span class="string">&quot;<span class="variable">$&#123;HOME&#125;</span>/.cache/huggingface/accelerate/default_config.yaml&quot;</span></span><br><span class="line"><span class="keyword">fi</span></span><br><span class="line"><span class="keyword">if</span> [ -f <span class="string">&quot;<span class="variable">$&#123;ACCELERATE_CONFIG_PATH&#125;</span>&quot;</span> ]; <span class="keyword">then</span></span><br><span class="line">    <span class="built_in">echo</span> <span class="string">&quot;Using Accelerate config file: <span class="variable">$&#123;ACCELERATE_CONFIG_PATH&#125;</span>&quot;</span></span><br><span class="line">    accelerate launch --config_file=<span class="string">&quot;<span class="variable">$&#123;ACCELERATE_CONFIG_PATH&#125;</span>&quot;</span> train.py</span><br><span class="line"><span class="keyword">else</span></span><br><span class="line">    <span class="built_in">echo</span> <span class="string">&quot;Accelerate config file not found: <span class="variable">$&#123;ACCELERATE_CONFIG_PATH&#125;</span>. Using values from config.env.&quot;</span></span><br><span class="line">    accelerate launch <span class="variable">$&#123;ACCELERATE_EXTRA_ARGS&#125;</span> --mixed_precision=<span class="string">&quot;<span class="variable">$&#123;MIXED_PRECISION&#125;</span>&quot;</span> --num_processes=<span class="string">&quot;<span class="variable">$&#123;TRAINING_NUM_PROCESSES&#125;</span>&quot;</span> --num_machines=<span class="string">&quot;<span class="variable">$&#123;TRAINING_NUM_MACHINES&#125;</span>&quot;</span> --dynamo_backend=<span class="string">&quot;<span class="variable">$&#123;TRAINING_DYNAMO_BACKEND&#125;</span>&quot;</span> train.py</span><br><span class="line"></span><br><span class="line"><span class="keyword">fi</span></span><br><span class="line"></span><br><span class="line"><span class="built_in">exit</span> 0</span><br></pre></td></tr></table></figure></li>
</ul>
<h3 id="Possible-accelerate-issues"><a href="#Possible-accelerate-issues" class="headerlink" title="Possible accelerate issues"></a>Possible <code>accelerate</code> issues</h3><p>ì—¬ê¸°ì„œëŠ” í›ˆë ¨ì„ ì‹œì‘í•˜ëŠ” ë° ë°©í•´ê°€ ë  ìˆ˜ ìˆëŠ” í•œ ê°€ì§€ ì‘ì€ ì‚¬í•­ì„ ì–¸ê¸‰í•˜ê³  ì‹¶ìŠµë‹ˆë‹¤. ë ë¶€ë¶„ì— ìˆëŠ” ê¸°ë³¸ <code>train.sh</code> ì•ˆì—ëŠ” í›ˆë ¨ì„ ì‹¤í–‰í•˜ëŠ” ëª…ë ¹ì´ ìˆìŠµë‹ˆë‹¤.</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">accelerate launch --config_file=<span class="string">&quot;<span class="variable">$&#123;ACCELERATE_CONFIG_PATH&#125;</span>&quot;</span> train.py</span><br></pre></td></tr></table></figure>

<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># Run the training script.</span></span><br><span class="line"><span class="keyword">if</span> [[ -z <span class="string">&quot;$&#123;ACCELERATE_CONFIG_PATH&#125;&quot;</span> ]]; then</span><br><span class="line">    ACCELERATE_CONFIG_PATH=<span class="string">&quot;$&#123;HOME&#125;/.cache/huggingface/accelerate/default_config.yaml&quot;</span></span><br><span class="line">fi</span><br><span class="line"><span class="keyword">if</span> [ -f <span class="string">&quot;$&#123;ACCELERATE_CONFIG_PATH&#125;&quot;</span> ]; then</span><br><span class="line">    echo <span class="string">&quot;Using Accelerate config file: $&#123;ACCELERATE_CONFIG_PATH&#125;&quot;</span></span><br><span class="line">    accelerate launch --config_file=<span class="string">&quot;$&#123;ACCELERATE_CONFIG_PATH&#125;&quot;</span> train.py</span><br><span class="line"><span class="keyword">else</span></span><br><span class="line">    echo <span class="string">&quot;Accelerate config file not found: $&#123;ACCELERATE_CONFIG_PATH&#125;. Using values from config.env.&quot;</span></span><br><span class="line">    accelerate launch $&#123;ACCELERATE_EXTRA_ARGS&#125; --mixed_precision=<span class="string">&quot;$&#123;MIXED_PRECISION&#125;&quot;</span> --num_processes=<span class="string">&quot;$&#123;TRAINING_NUM_PROCESSES&#125;&quot;</span> --num_machines=<span class="string">&quot;$&#123;TRAINING_NUM_MACHINES&#125;&quot;</span> --dynamo_backend=<span class="string">&quot;$&#123;TRAINING_DYNAMO_BACKEND&#125;&quot;</span> train.py</span><br><span class="line"></span><br><span class="line">fi</span><br></pre></td></tr></table></figure>


<p>ì´ê²ƒì´ ì²˜ìŒìœ¼ë¡œ í›ˆë ¨ ì €ì¥ì†Œë¥¼ ì„¤ì¹˜í•˜ëŠ” ê²ƒì´ë¼ë©´ ì•„ë§ˆë„ ì˜¤ë¥˜ ì—†ì´ ì‹¤í–‰ë  ê²ƒì…ë‹ˆë‹¤. ê·¸ëŸ¬ë‚˜ ë‹¤ë¥¸ ì €ì¥ì†Œì—ì„œ <code>accelerate</code>ë¥¼ ì‚¬ìš©í•œ ê²½ìš° <code>default_config.yaml</code>ì„ ì´ë¯¸ êµ¬ì„±í–ˆì„ ê°€ëŠ¥ì„±ì´ ë†’ìŠµë‹ˆë‹¤. í›ˆë ¨ì—ì„œ ì˜¤ë¥˜ê°€ ë°œìƒí•˜ëŠ” ê²½ìš° ì¼ë°˜ í›ˆë ¨ì„ ìœ„í•´ ì—¬ê¸°ì— ìì²´ <code>config.yaml</code>ì„ ì œê³µí–ˆìŠµë‹ˆë‹¤. ë˜í•œ â€˜LoRAâ€™ êµìœ¡ì´ ì•„ë‹Œ ì™„ì „í•œ ë¯¸ì„¸ ì¡°ì •ì„ ì‹œë„í•˜ë ¤ëŠ” ê²½ìš° â€˜DeepSpeedâ€™ â€˜config.yamlâ€™ì„ ì œê³µí–ˆìŠµë‹ˆë‹¤.</p>
<p>â€˜DeepSpeedâ€™ëŠ” GPU VRAMì´ ì¶©ë¶„í•˜ì§€ ì•Šì„ ë•Œ ë‚´ë¶€ì˜ íŠ¹ìˆ˜ ê¸°ìˆ ì„ ì‚¬ìš©í•˜ì—¬ ìµœì í™” ìƒíƒœ, ê·¸ë¼ë°ì´ì…˜ ë° ê¸°íƒ€ ë§¤ê°œë³€ìˆ˜ë¥¼ CPU ë©”ëª¨ë¦¬(RAM)ë¡œ ì˜¤í”„ë¡œë“œí•©ë‹ˆë‹¤. â€˜80GBâ€™ VRAMê³¼ â€˜128GBâ€™ CPU RAMì„ ê°–ì¶˜ ë‹¨ì¼ â€˜H100â€™ GPUì—ì„œëŠ” â€˜SD3.5 Largeâ€™ë¡œ ì™„ì „í•œ ë¯¸ì„¸ ì¡°ì •ì„ ìˆ˜í–‰í•  ìˆ˜ ìˆì—ˆìŠµë‹ˆë‹¤. VRAMì´ ë¶€ì¡±í•˜ê³  CPU RAMìœ¼ë¡œ ì˜¤í”„ë¡œë“œí•´ì•¼ í•  ë•Œë§ˆë‹¤ ì´ <code>config.yaml</code>ì„ ì‚¬ìš©í•  ìˆ˜ë„ ìˆìŠµë‹ˆë‹¤.</p>
<ul>
<li><p>Custom general use <code>base_config.yaml</code></p>
  <figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">compute_environment:</span> <span class="string">LOCAL_MACHINE</span></span><br><span class="line"><span class="attr">debug:</span> <span class="literal">false</span></span><br><span class="line"><span class="attr">distributed_type:</span> <span class="string">&#x27;NO&#x27;</span></span><br><span class="line"><span class="attr">downcast_bf16:</span> <span class="string">&#x27;no&#x27;</span></span><br><span class="line"><span class="attr">enable_cpu_affinity:</span> <span class="literal">false</span></span><br><span class="line"><span class="attr">gpu_ids:</span> <span class="string">all</span></span><br><span class="line"><span class="attr">machine_rank:</span> <span class="number">0</span></span><br><span class="line"><span class="attr">main_training_function:</span> <span class="string">main</span></span><br><span class="line"><span class="attr">mixed_precision:</span> <span class="string">bf16</span></span><br><span class="line"><span class="attr">num_machines:</span> <span class="number">1</span></span><br><span class="line"><span class="attr">num_processes:</span> <span class="number">1</span></span><br><span class="line"><span class="attr">rdzv_backend:</span> <span class="string">static</span></span><br><span class="line"><span class="attr">same_network:</span> <span class="literal">true</span></span><br><span class="line"><span class="attr">tpu_env:</span> []</span><br><span class="line"><span class="attr">tpu_use_cluster:</span> <span class="literal">false</span></span><br><span class="line"><span class="attr">tpu_use_sudo:</span> <span class="literal">false</span></span><br><span class="line"><span class="attr">use_cpu:</span> <span class="literal">false</span></span><br></pre></td></tr></table></figure>
</li>
<li><p>Custom <code>DeepSpeed 2</code> <code>deepspeed_config.yaml</code></p>
  <figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">compute_environment:</span> <span class="string">LOCAL_MACHINE</span></span><br><span class="line"><span class="attr">debug:</span> <span class="literal">false</span></span><br><span class="line"><span class="attr">deepspeed_config:</span></span><br><span class="line">  <span class="attr">gradient_accumulation_steps:</span> <span class="number">8</span></span><br><span class="line">  <span class="attr">gradient_clipping:</span> <span class="number">1.0</span></span><br><span class="line">  <span class="attr">offload_optimizer_device:</span> <span class="string">cpu</span></span><br><span class="line">  <span class="attr">offload_param_device:</span> <span class="string">cpu</span></span><br><span class="line">  <span class="attr">zero3_init_flag:</span> <span class="literal">false</span></span><br><span class="line">  <span class="attr">zero_stage:</span> <span class="number">2</span></span><br><span class="line"><span class="attr">distributed_type:</span> <span class="string">DEEPSPEED</span></span><br><span class="line"><span class="attr">downcast_bf16:</span> <span class="string">&#x27;no&#x27;</span></span><br><span class="line"><span class="attr">enable_cpu_affinity:</span> <span class="literal">true</span></span><br><span class="line"><span class="attr">machine_rank:</span> <span class="number">0</span></span><br><span class="line"><span class="attr">main_training_function:</span> <span class="string">main</span></span><br><span class="line"><span class="attr">mixed_precision:</span> <span class="string">bf16</span></span><br><span class="line"><span class="attr">num_machines:</span> <span class="number">1</span></span><br><span class="line"><span class="attr">num_processes:</span> <span class="number">1</span></span><br><span class="line"><span class="attr">rdzv_backend:</span> <span class="string">static</span></span><br><span class="line"><span class="attr">same_network:</span> <span class="literal">true</span></span><br><span class="line"><span class="attr">tpu_env:</span> []</span><br><span class="line"><span class="attr">tpu_use_cluster:</span> <span class="literal">false</span></span><br><span class="line"><span class="attr">tpu_use_sudo:</span> <span class="literal">false</span></span><br><span class="line"><span class="attr">use_cpu:</span> <span class="literal">false</span></span><br></pre></td></tr></table></figure></li>
</ul>
<p>ì´ëŸ¬í•œ <code>yaml</code> íŒŒì¼ì„ ë°°ì¹˜í•  ìœ„ì¹˜ë¥¼ ì„ íƒí•  ë•Œë§ˆë‹¤ <code>train.sh</code> ì½”ë“œì—ì„œ í•´ë‹¹ íŒŒì¼ì„ ì˜¬ë°”ë¥´ê²Œ ì°¸ì¡°í•´ì•¼ í•©ë‹ˆë‹¤. ì˜ˆë¥¼ ë“¤ì–´, ì €ëŠ” <code>SimpleTuner</code> ë””ë ‰í† ë¦¬ì˜ ë£¨íŠ¸ì— íŒŒì¼ì„ ë°°ì¹˜í•©ë‹ˆë‹¤. ë”°ë¼ì„œ ì½”ë“œì˜ â€˜ACCELERATE_CONFIG_PATHâ€™ ë¶€ë¶„ì´ ê·¸ì— ë”°ë¼ ìˆ˜ì •ë©ë‹ˆë‹¤.</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># Run the training script with base config.</span></span><br><span class="line"><span class="keyword">if</span> [[ -z <span class="string">&quot;<span class="variable">$&#123;ACCELERATE_CONFIG_PATH&#125;</span>&quot;</span> ]]; <span class="keyword">then</span></span><br><span class="line">    ACCELERATE_CONFIG_PATH=<span class="string">&quot;<span class="variable">$&#123;HOME&#125;</span>/SimpleTuner/base_config.yaml&quot;</span></span><br><span class="line"><span class="keyword">fi</span></span><br></pre></td></tr></table></figure>

<p>or</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># Run the training script with DeepSpeed config.</span></span><br><span class="line"><span class="keyword">if</span> [[ -z <span class="string">&quot;<span class="variable">$&#123;ACCELERATE_CONFIG_PATH&#125;</span>&quot;</span> ]]; <span class="keyword">then</span></span><br><span class="line">    ACCELERATE_CONFIG_PATH=<span class="string">&quot;<span class="variable">$&#123;HOME&#125;</span>/SimpleTuner/deepspeed_config.yaml&quot;</span></span><br><span class="line"><span class="keyword">fi</span></span><br></pre></td></tr></table></figure>

<p>ê²°êµ­ <code>DeepSpeed</code> ì§€ì› í›ˆë ¨ì„ ì‹œë„í•˜ê²Œ ëœë‹¤ë©´, ì´ì— ë”°ë¼ ì‚¬ìš©í•  ìˆ˜ ìˆëŠ” í•˜ìœ„ ìˆ˜ì¤€ <code>config.env</code> ìƒ˜í”Œì´ ìˆìŠµë‹ˆë‹¤.</p>
<ul>
<li><p>Custom SD3.5 Large <code>full</code> fine-tune<code>config.json</code></p>
  <figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br></pre></td><td class="code"><pre><span class="line"><span class="punctuation">&#123;</span></span><br><span class="line">  <span class="attr">&quot;--model_type&quot;</span><span class="punctuation">:</span> <span class="string">&quot;full&quot;</span><span class="punctuation">,</span></span><br><span class="line">  <span class="attr">&quot;--model_family&quot;</span><span class="punctuation">:</span> <span class="string">&quot;sd3&quot;</span><span class="punctuation">,</span></span><br><span class="line">  <span class="attr">&quot;--resume_from_checkpoint&quot;</span><span class="punctuation">:</span> <span class="string">&quot;latest&quot;</span><span class="punctuation">,</span></span><br><span class="line">  <span class="attr">&quot;--checkpointing_steps&quot;</span><span class="punctuation">:</span> <span class="number">100</span><span class="punctuation">,</span></span><br><span class="line">  <span class="attr">&quot;--checkpoints_total_limit&quot;</span><span class="punctuation">:</span> <span class="number">100</span><span class="punctuation">,</span></span><br><span class="line">  <span class="attr">&quot;--learning_rate&quot;</span><span class="punctuation">:</span> <span class="number">5e-5</span><span class="punctuation">,</span></span><br><span class="line">  <span class="attr">&quot;--pretrained_model_name_or_path&quot;</span><span class="punctuation">:</span> <span class="string">&quot;stabilityai/stable-diffusion-3.5-large&quot;</span><span class="punctuation">,</span></span><br><span class="line">  <span class="attr">&quot;--report_to&quot;</span><span class="punctuation">:</span> <span class="string">&quot;wandb&quot;</span><span class="punctuation">,</span></span><br><span class="line">  <span class="attr">&quot;--tracker_project_name&quot;</span><span class="punctuation">:</span> <span class="string">&quot;sd35-training&quot;</span><span class="punctuation">,</span></span><br><span class="line">  <span class="attr">&quot;--tracker_run_name&quot;</span><span class="punctuation">:</span> <span class="string">&quot;simpletuner-fantasy-art-full-01&quot;</span><span class="punctuation">,</span></span><br><span class="line">  <span class="attr">&quot;--max_train_steps&quot;</span><span class="punctuation">:</span> <span class="number">24000</span><span class="punctuation">,</span></span><br><span class="line">  <span class="attr">&quot;--num_train_epochs&quot;</span><span class="punctuation">:</span> <span class="number">0</span><span class="punctuation">,</span></span><br><span class="line">  <span class="attr">&quot;--data_backend_config&quot;</span><span class="punctuation">:</span> <span class="string">&quot;/weka2/home-yeo/simpletuner_models/sd3_large/full_finetune/fantasy_art_L_01/datasets/multidatabackend.json&quot;</span><span class="punctuation">,</span></span><br><span class="line">  <span class="attr">&quot;--output_dir&quot;</span><span class="punctuation">:</span> <span class="string">&quot;/weka2/home-yeo/simpletuner_models/sd3_large/full_finetune/fantasy_art_L_01/datasets/models&quot;</span><span class="punctuation">,</span></span><br><span class="line">  <span class="attr">&quot;--push_to_hub&quot;</span><span class="punctuation">:</span> <span class="keyword">false</span><span class="punctuation">,</span></span><br><span class="line">  <span class="attr">&quot;--push_checkpoints_to_hub&quot;</span><span class="punctuation">:</span> <span class="keyword">true</span><span class="punctuation">,</span></span><br><span class="line">  <span class="attr">&quot;--hub_model_id&quot;</span><span class="punctuation">:</span> <span class="string">&quot;sd35-training&quot;</span><span class="punctuation">,</span></span><br><span class="line">  <span class="attr">&quot;--resolution&quot;</span><span class="punctuation">:</span> <span class="number">1024</span><span class="punctuation">,</span></span><br><span class="line">  <span class="attr">&quot;--resolution_type&quot;</span><span class="punctuation">:</span> <span class="string">&quot;pixel&quot;</span><span class="punctuation">,</span></span><br><span class="line">  <span class="attr">&quot;--minimum_image_size&quot;</span><span class="punctuation">:</span> <span class="number">1024</span><span class="punctuation">,</span></span><br><span class="line">  <span class="attr">&quot;--instance_prompt&quot;</span><span class="punctuation">:</span> <span class="string">&quot;k4s4 &quot;</span><span class="punctuation">,</span></span><br><span class="line">  <span class="attr">&quot;--validation_prompt&quot;</span><span class="punctuation">:</span> <span class="string">&quot;k4s4, a waist up view of a beautiful blonde woman, green eyes&quot;</span><span class="punctuation">,</span></span><br><span class="line">  <span class="attr">&quot;--validation_guidance&quot;</span><span class="punctuation">:</span> <span class="number">7.5</span><span class="punctuation">,</span></span><br><span class="line">  <span class="attr">&quot;--validation_guidance_rescale&quot;</span><span class="punctuation">:</span> <span class="number">0.0</span><span class="punctuation">,</span></span><br><span class="line">  <span class="attr">&quot;--validation_steps&quot;</span><span class="punctuation">:</span> <span class="number">25</span><span class="punctuation">,</span></span><br><span class="line">  <span class="attr">&quot;--validation_num_inference_steps&quot;</span><span class="punctuation">:</span> <span class="number">30</span><span class="punctuation">,</span></span><br><span class="line">  <span class="attr">&quot;--validation_negative_prompt&quot;</span><span class="punctuation">:</span> <span class="string">&quot;blurry, cropped, ugly&quot;</span><span class="punctuation">,</span></span><br><span class="line">  <span class="attr">&quot;--validation_seed&quot;</span><span class="punctuation">:</span> <span class="number">42</span><span class="punctuation">,</span></span><br><span class="line">  <span class="attr">&quot;--validation_resolution&quot;</span><span class="punctuation">:</span> <span class="number">1024</span><span class="punctuation">,</span></span><br><span class="line">  <span class="attr">&quot;--train_batch_size&quot;</span><span class="punctuation">:</span> <span class="number">6</span><span class="punctuation">,</span></span><br><span class="line">  <span class="attr">&quot;--gradient_accumulation_steps&quot;</span><span class="punctuation">:</span> <span class="number">1</span><span class="punctuation">,</span></span><br><span class="line">  <span class="attr">&quot;--lr_scheduler&quot;</span><span class="punctuation">:</span> <span class="string">&quot;cosine&quot;</span><span class="punctuation">,</span></span><br><span class="line">  <span class="attr">&quot;--lr_warmup_steps&quot;</span><span class="punctuation">:</span> <span class="number">2400</span><span class="punctuation">,</span></span><br><span class="line">  <span class="attr">&quot;--caption_dropout_probability&quot;</span><span class="punctuation">:</span> <span class="number">0</span><span class="punctuation">,</span></span><br><span class="line">  <span class="attr">&quot;--metadata_update_interval&quot;</span><span class="punctuation">:</span> <span class="number">65</span><span class="punctuation">,</span></span><br><span class="line">  <span class="attr">&quot;--vae_batch_size&quot;</span><span class="punctuation">:</span> <span class="number">12</span><span class="punctuation">,</span></span><br><span class="line">  <span class="attr">&quot;--delete_unwanted_images&quot;</span><span class="punctuation">:</span> <span class="keyword">false</span><span class="punctuation">,</span></span><br><span class="line">  <span class="attr">&quot;--delete_problematic_images&quot;</span><span class="punctuation">:</span> <span class="keyword">false</span><span class="punctuation">,</span></span><br><span class="line">  <span class="attr">&quot;--training_scheduler_timestep_spacing&quot;</span><span class="punctuation">:</span> <span class="string">&quot;trailing&quot;</span><span class="punctuation">,</span></span><br><span class="line">  <span class="attr">&quot;--inference_scheduler_timestep_spacing&quot;</span><span class="punctuation">:</span> <span class="string">&quot;trailing&quot;</span><span class="punctuation">,</span></span><br><span class="line">  <span class="attr">&quot;--snr_gamma&quot;</span><span class="punctuation">:</span> <span class="number">5</span><span class="punctuation">,</span></span><br><span class="line">  <span class="attr">&quot;--enable_xformers_memory_efficient_attention&quot;</span><span class="punctuation">:</span> <span class="keyword">true</span><span class="punctuation">,</span></span><br><span class="line">  <span class="attr">&quot;--gradient_checkpointing&quot;</span><span class="punctuation">:</span> <span class="keyword">true</span><span class="punctuation">,</span></span><br><span class="line">  <span class="attr">&quot;--allow_tf32&quot;</span><span class="punctuation">:</span> <span class="keyword">true</span><span class="punctuation">,</span></span><br><span class="line">  <span class="attr">&quot;--optimizer&quot;</span><span class="punctuation">:</span> <span class="string">&quot;adamw_bf16&quot;</span><span class="punctuation">,</span></span><br><span class="line">  <span class="attr">&quot;--use_ema&quot;</span><span class="punctuation">:</span> <span class="keyword">false</span><span class="punctuation">,</span></span><br><span class="line">  <span class="attr">&quot;--ema_decay&quot;</span><span class="punctuation">:</span> <span class="number">0.999</span><span class="punctuation">,</span></span><br><span class="line">  <span class="attr">&quot;--seed&quot;</span><span class="punctuation">:</span> <span class="number">42</span><span class="punctuation">,</span></span><br><span class="line">  <span class="attr">&quot;--mixed_precision&quot;</span><span class="punctuation">:</span> <span class="string">&quot;bf16&quot;</span><span class="punctuation">,</span></span><br><span class="line"><span class="punctuation">&#125;</span></span><br></pre></td></tr></table></figure>
</li>
<li><p>Custom SD3.5 Large <code>full</code> fine-tune<code>config.env</code></p>
  <figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br></pre></td><td class="code"><pre><span class="line"> </span><br><span class="line"><span class="built_in">export</span> MODEL_TYPE=<span class="string">&#x27;full&#x27;</span></span><br><span class="line"><span class="built_in">export</span> MODEL_FAMILY=<span class="string">&#x27;sd3&#x27;</span></span><br><span class="line"><span class="built_in">export</span> CONTROLNET=<span class="literal">false</span></span><br><span class="line"><span class="built_in">export</span> USE_DORA=<span class="literal">false</span></span><br><span class="line"><span class="comment"># Restart where we left off. Change this to &quot;checkpoint-1234&quot; to start from a specific checkpoint.</span></span><br><span class="line"><span class="built_in">export</span> RESUME_CHECKPOINT=<span class="string">&quot;latest&quot;</span></span><br><span class="line"><span class="built_in">export</span> CHECKPOINTING_STEPS=100</span><br><span class="line"><span class="comment"># This is how many checkpoints we will keep. Two is safe, but three is safer.</span></span><br><span class="line"><span class="built_in">export</span> CHECKPOINTING_LIMIT=100</span><br><span class="line"></span><br><span class="line"><span class="comment"># This is decided as a relatively conservative &#x27;constant&#x27; learning rate.</span></span><br><span class="line"><span class="comment"># Adjust higher or lower depending on how burnt your model becomes.</span></span><br><span class="line"><span class="built_in">export</span> LEARNING_RATE=5e-5</span><br><span class="line"></span><br><span class="line"><span class="comment"># Using a Huggingface Hub model:</span></span><br><span class="line"><span class="built_in">export</span> MODEL_NAME=<span class="string">&quot;stabilityai/stable-diffusion-3.5-large&quot;</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># Make DEBUG_EXTRA_ARGS empty to disable wandb.</span></span><br><span class="line"><span class="built_in">export</span> DEBUG_EXTRA_ARGS=<span class="string">&quot;--report_to=wandb&quot;</span></span><br><span class="line"><span class="built_in">export</span> TRACKER_PROJECT_NAME=<span class="string">&quot;sd35-training&quot;</span></span><br><span class="line"><span class="built_in">export</span> TRACKER_RUN_NAME=<span class="string">&quot;simpletuner-fantasy-art-full-01&quot;</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># Max number of steps OR epochs can be used. Not both.</span></span><br><span class="line"><span class="built_in">export</span> MAX_NUM_STEPS=24000</span><br><span class="line"><span class="built_in">export</span> NUM_EPOCHS=0</span><br><span class="line"></span><br><span class="line"><span class="comment"># A convenient prefix for all of your training paths.</span></span><br><span class="line"><span class="built_in">export</span> DATALOADER_CONFIG=<span class="string">&quot;/weka2/home-yeo/simpletuner_models/sd3_large/full_finetune/fantasy_art_full_L_01/datasets/multidatabackend.json&quot;</span></span><br><span class="line"><span class="built_in">export</span> OUTPUT_DIR=<span class="string">&quot;/weka2/home-yeo/simpletuner_models/sd3_large/full_finetune/fantasy_art_full_L_01/datasets/models&quot;</span></span><br><span class="line"><span class="comment"># Set this to &quot;true&quot; to push your model to Hugging Face Hub.</span></span><br><span class="line"><span class="built_in">export</span> PUSH_TO_HUB=<span class="string">&quot;false&quot;</span></span><br><span class="line"><span class="comment"># If PUSH_TO_HUB and PUSH_CHECKPOINTS are both enabled, every saved checkpoint will be pushed to Hugging Face Hub.</span></span><br><span class="line"><span class="built_in">export</span> PUSH_CHECKPOINTS=<span class="string">&quot;true&quot;</span></span><br><span class="line"><span class="comment"># This will be the model name for your final hub upload, eg. &quot;yourusername/yourmodelname&quot;</span></span><br><span class="line"><span class="comment"># It defaults to the wandb project name, but you can override this here.</span></span><br><span class="line"><span class="comment"># export HUB_MODEL_NAME=$TRACKER_PROJECT_NAME</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># By default, images will be resized so their SMALLER EDGE is 1024 pixels, maintaining aspect ratio.</span></span><br><span class="line"><span class="comment"># Setting this value to 768px might result in more reasonable training data sizes for SDXL.</span></span><br><span class="line"><span class="built_in">export</span> RESOLUTION=1024</span><br><span class="line"><span class="comment"># If you want to have the training data resized by pixel area (Megapixels) rather than edge length,</span></span><br><span class="line"><span class="comment">#  set this value to &quot;area&quot; instead of &quot;pixel&quot;, and uncomment the next RESOLUTION declaration.</span></span><br><span class="line"><span class="built_in">export</span> RESOLUTION_TYPE=<span class="string">&quot;pixel&quot;</span></span><br><span class="line"><span class="comment">#export RESOLUTION=1          # 1.0 Megapixel training sizes</span></span><br><span class="line"><span class="comment"># If RESOLUTION_TYPE=&quot;pixel&quot;, the minimum resolution specifies the smaller edge length, measured in pixels. Recommended: 1024.</span></span><br><span class="line"><span class="comment"># If RESOLUTION_TYPE=&quot;area&quot;, the minimum resolution specifies the total image area, measured in megapixels. Recommended: 1.</span></span><br><span class="line"><span class="built_in">export</span> MINIMUM_RESOLUTION=1024</span><br><span class="line"></span><br><span class="line"><span class="comment"># How many decimals to round aspect buckets to.</span></span><br><span class="line"><span class="comment">#export ASPECT_BUCKET_ROUNDING=2</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># Use this to append an instance prompt to each caption, used for adding trigger words.</span></span><br><span class="line"><span class="comment"># This has not been tested in SDXL.</span></span><br><span class="line"><span class="built_in">export</span> INSTANCE_PROMPT=<span class="string">&quot;k4s4 &quot;</span></span><br><span class="line"><span class="comment"># If you also supply a user prompt library or `--use_prompt_library`, this will be added to those lists.</span></span><br><span class="line"><span class="built_in">export</span> VALIDATION_PROMPT=<span class="string">&quot;k4s4, a waist up view of a beautiful blonde woman, green eyes&quot;</span></span><br><span class="line"><span class="built_in">export</span> VALIDATION_GUIDANCE=7.5</span><br><span class="line"><span class="comment"># You&#x27;ll want to set this to 0.7 if you are training a terminal SNR model.</span></span><br><span class="line"><span class="built_in">export</span> VALIDATION_GUIDANCE_RESCALE=0.0</span><br><span class="line"><span class="comment"># How frequently we will save and run a pipeline for validations.</span></span><br><span class="line"><span class="comment"># export VALIDATION_STEPS=200</span></span><br><span class="line"><span class="built_in">export</span> VALIDATION_STEPS=25</span><br><span class="line"><span class="built_in">export</span> VALIDATION_NUM_INFERENCE_STEPS=30</span><br><span class="line"></span><br><span class="line"><span class="built_in">export</span> VALIDATION_NEGATIVE_PROMPT=<span class="string">&quot;blurry, cropped, ugly&quot;</span></span><br><span class="line"><span class="built_in">export</span> VALIDATION_SEED=42</span><br><span class="line"><span class="built_in">export</span> VALIDATION_RESOLUTION=1024</span><br><span class="line"></span><br><span class="line"><span class="comment"># Adjust this for your GPU memory size. This, and resolution, are the biggest VRAM killers.</span></span><br><span class="line"><span class="built_in">export</span> TRAIN_BATCH_SIZE=6</span><br><span class="line"><span class="comment"># Accumulate your update gradient over many steps, to save VRAM while still having higher effective batch size:</span></span><br><span class="line"><span class="comment"># effective batch size = ($TRAIN_BATCH_SIZE * $GRADIENT_ACCUMULATION_STEPS).</span></span><br><span class="line"><span class="built_in">export</span> GRADIENT_ACCUMULATION_STEPS=1</span><br><span class="line"></span><br><span class="line"><span class="comment"># Use any standard scheduler type. constant, polynomial, constant_with_warmup</span></span><br><span class="line"><span class="built_in">export</span> LR_SCHEDULE=<span class="string">&quot;cosine&quot;</span></span><br><span class="line"><span class="comment"># A warmup period allows the model and the EMA weights more importantly to familiarise itself with the current quanta.</span></span><br><span class="line"><span class="comment"># For the cosine or sine type schedules, the warmup period defines the interval between peaks or valleys.</span></span><br><span class="line"><span class="comment"># Use a sine schedule to simulate a warmup period, or a Cosine period to simulate a polynomial start.</span></span><br><span class="line"><span class="comment"># export LR_WARMUP_STEPS=$((MAX_NUM_STEPS / 10))</span></span><br><span class="line"><span class="built_in">export</span> LR_WARMUP_STEPS=2400</span><br><span class="line"></span><br><span class="line"><span class="comment"># Caption dropout probability. Set to 0.1 for 10% of captions dropped out. Set to 0 to disable.</span></span><br><span class="line"><span class="comment"># You may wish to disable dropout if you want to limit your changes strictly to the prompts you show the model.</span></span><br><span class="line"><span class="comment"># You may wish to increase the rate of dropout if you want to more broadly adopt your changes across the model.</span></span><br><span class="line"><span class="built_in">export</span> CAPTION_DROPOUT_PROBABILITY=0</span><br><span class="line"></span><br><span class="line"><span class="built_in">export</span> METADATA_UPDATE_INTERVAL=65</span><br><span class="line"><span class="built_in">export</span> VAE_BATCH_SIZE=12</span><br><span class="line"></span><br><span class="line"><span class="comment"># If this is set, any images that fail to open will be DELETED to avoid re-checking them every time.</span></span><br><span class="line"><span class="built_in">export</span> DELETE_ERRORED_IMAGES=0</span><br><span class="line"><span class="comment"># If this is set, any images that are too small for the minimum resolution size will be DELETED.</span></span><br><span class="line"><span class="built_in">export</span> DELETE_SMALL_IMAGES=0</span><br><span class="line"></span><br><span class="line"><span class="comment"># Bytedance recommends these be set to &quot;trailing&quot; so that inference and training behave in a more congruent manner.</span></span><br><span class="line"><span class="comment"># To follow the original SDXL training strategy, use &quot;leading&quot; instead, though results are generally worse.</span></span><br><span class="line"><span class="built_in">export</span> TRAINING_SCHEDULER_TIMESTEP_SPACING=<span class="string">&quot;trailing&quot;</span></span><br><span class="line"><span class="built_in">export</span> INFERENCE_SCHEDULER_TIMESTEP_SPACING=<span class="string">&quot;trailing&quot;</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># Removing this option or unsetting it uses vanilla training. Setting it reweights the loss by the position of the timestep in the noise schedule.</span></span><br><span class="line"><span class="comment"># A value &quot;5&quot; is recommended by the researchers. A value of &quot;20&quot; is the least impact, and &quot;1&quot; is the most impact.</span></span><br><span class="line"><span class="built_in">export</span> MIN_SNR_GAMMA=5</span><br><span class="line"></span><br><span class="line"><span class="comment"># Set this to an explicit value of &quot;false&quot; to disable Xformers. Probably required for AMD users.</span></span><br><span class="line"><span class="built_in">export</span> USE_XFORMERS=<span class="literal">true</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># There&#x27;s basically no reason to unset this. However, to disable it, use an explicit value of &quot;false&quot;.</span></span><br><span class="line"><span class="comment"># This will save a lot of memory consumption when enabled.</span></span><br><span class="line"><span class="built_in">export</span> USE_GRADIENT_CHECKPOINTING=<span class="literal">true</span></span><br><span class="line"></span><br><span class="line"><span class="comment">##</span></span><br><span class="line"><span class="comment"># Options below here may require a bit more complicated configuration, so they are not simple variables.</span></span><br><span class="line"><span class="comment">##</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># TF32 is great on Ampere or Ada, not sure about earlier generations.</span></span><br><span class="line"><span class="built_in">export</span> ALLOW_TF32=<span class="literal">true</span></span><br><span class="line"><span class="comment"># AdamW 8Bit is a robust and lightweight choice. Adafactor might reduce memory consumption, and Dadaptation is slow and experimental.</span></span><br><span class="line"><span class="comment"># AdamW is the default optimizer, but it uses a lot of memory and is slower than AdamW8Bit or Adafactor.</span></span><br><span class="line"><span class="comment"># Choices: adamw, adamw8bit, adafactor, dadaptation</span></span><br><span class="line"><span class="comment"># export OPTIMIZER=&quot;adamw_bf16&quot;</span></span><br><span class="line"><span class="built_in">export</span> OPTIMIZER=<span class="string">&quot;adamw_bf16&quot;</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># EMA is a strong regularisation method that uses a lot of extra VRAM to hold two copies of the weights.</span></span><br><span class="line"><span class="comment"># This is worthwhile on large training runs, but not so much for smaller training runs.</span></span><br><span class="line"><span class="built_in">export</span> USE_EMA=<span class="literal">false</span></span><br><span class="line"><span class="built_in">export</span> EMA_DECAY=0.999</span><br><span class="line"></span><br><span class="line"><span class="built_in">export</span> TRAINER_EXTRA_ARGS=<span class="string">&quot;&quot;</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># Reproducible training. Set to -1 to disable.</span></span><br><span class="line"><span class="built_in">export</span> TRAINING_SEED=42</span><br><span class="line"></span><br><span class="line"><span class="comment"># Mixed precision is the best. You honestly might need to YOLO it in fp16 mode for Google Colab type setups.</span></span><br><span class="line"><span class="built_in">export</span> MIXED_PRECISION=<span class="string">&quot;bf16&quot;</span></span><br><span class="line"><span class="built_in">export</span> PURE_BF16=<span class="literal">true</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># This has to be changed if you&#x27;re training with multiple GPUs.</span></span><br><span class="line"><span class="built_in">export</span> TRAINING_NUM_PROCESSES=1</span><br><span class="line"><span class="built_in">export</span> TRAINING_NUM_MACHINES=1</span><br><span class="line"><span class="built_in">export</span> ACCELERATE_EXTRA_ARGS=<span class="string">&quot;&quot;</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># With Pytorch 2.1, you might have pretty good luck here.</span></span><br><span class="line"><span class="comment"># If you&#x27;re using aspect bucketing however, each resolution change will recompile. Seriously, just don&#x27;t do it.</span></span><br><span class="line"><span class="comment"># Well, then again... Pytorch 2.2 has support for dynamic shapes. Why not?</span></span><br><span class="line"><span class="built_in">export</span> TRAINING_DYNAMO_BACKEND=<span class="string">&#x27;no&#x27;</span></span><br><span class="line"></span><br><span class="line"><span class="built_in">export</span> TOKENIZERS_PARALLELISM=<span class="literal">false</span></span><br></pre></td></tr></table></figure></li>
</ul>
<p>Changed parameters</p>
<figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="punctuation">&#123;</span></span><br><span class="line">	<span class="attr">&quot;--model_type&quot;</span><span class="punctuation">:</span> <span class="string">&quot;full&quot;</span><span class="punctuation">,</span></span><br><span class="line">	<span class="attr">&quot;--checkpointing_steps&quot;</span><span class="punctuation">:</span> <span class="number">100</span><span class="punctuation">,</span></span><br><span class="line">  <span class="attr">&quot;--checkpoints_total_limit&quot;</span><span class="punctuation">:</span> <span class="number">100</span><span class="punctuation">,</span></span><br><span class="line">  <span class="attr">&quot;--learning_rate&quot;</span><span class="punctuation">:</span> <span class="number">5e-5</span><span class="punctuation">,</span></span><br><span class="line">  <span class="attr">&quot;--tracker_run_name&quot;</span><span class="punctuation">:</span> <span class="string">&quot;simpletuner-fantasy-art-full-01&quot;</span></span><br><span class="line"><span class="punctuation">&#125;</span></span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>íŠ¹íˆ í•™ìŠµë¥ ì´ â€˜5e-5â€™ë¡œ ê°ì†Œí–ˆìŠµë‹ˆë‹¤.</p>
<p>ëª¨ë“  ê²ƒì´ ì •ìƒì´ë©´ ê³„ì†í•´ì„œ í›ˆë ¨ì„ ì‹œì‘í•˜ì‹­ì‹œì˜¤.</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">bash train.sh</span><br></pre></td></tr></table></figure>

<h3 id="Memory-usage"><a href="#Memory-usage" class="headerlink" title="Memory usage"></a>Memory usage</h3><p>í…ìŠ¤íŠ¸ ì¸ì½”ë”ë¥¼ í›ˆë ¨í•˜ì§€ ì•ŠëŠ” ê²½ìš°(ìš°ë¦¬ëŠ” ê·¸ë ‡ì§€ ì•ŠìŠµë‹ˆë‹¤) â€˜SimpleTunerâ€™ë¥¼ ì‚¬ìš©í•˜ë©´ ì•½ â€˜10.4GBâ€™ì˜ VRAMì„ ì ˆì•½í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.</p>
<p>â€˜ë°°ì¹˜ í¬ê¸°â€™ë¥¼ â€˜6â€™ìœ¼ë¡œ ì„¤ì •í•˜ê³  â€˜lora ìˆœìœ„&#x2F;ì•ŒíŒŒâ€™ë¥¼ â€˜768â€™ë¡œ ì„¤ì •í•˜ë©´ í›ˆë ¨ì—ì„œ ì•½ â€˜32GBâ€™ì˜ VRAMì„ ì†Œë¹„í•©ë‹ˆë‹¤.</p>
<p>ë‹¹ì—°íˆ ì´ëŠ” ì†Œë¹„ì â€˜24GBâ€™ VRAM GPUì˜ ë²”ìœ„ë¥¼ ë²—ì–´ë‚©ë‹ˆë‹¤. ê·¸ë˜ì„œ <code>batch size</code>ë¥¼ <code>1</code>, <code>lora Rank/alpha</code>ë¥¼ <code>128</code>ë¡œ ì‚¬ìš©í•˜ì—¬ ë©”ëª¨ë¦¬ ë¹„ìš©ì„ ì¤„ì´ë ¤ê³  í–ˆìŠµë‹ˆë‹¤.</p>
<p>ì ì •ì ìœ¼ë¡œ VRAM ë¹„ìš©ì„ ì•½ â€˜19.65GBâ€™ VRAMìœ¼ë¡œ ë‚®ì¶œ ìˆ˜ ìˆì—ˆìŠµë‹ˆë‹¤.</p>
<p>ê·¸ëŸ¬ë‚˜ ìœ íš¨ì„± ê²€ì‚¬ í”„ë¡¬í”„íŠ¸ì— ëŒ€í•œ ì¶”ë¡ ì„ ì‹¤í–‰í•˜ë©´ VRAMì´ ìµœëŒ€ â€˜23.37GBâ€™ê¹Œì§€ ê¸‰ì¦í•©ë‹ˆë‹¤.</p>
<p>ì•ˆì „ì„ ìœ„í•´ â€˜lora ìˆœìœ„&#x2F;ì•ŒíŒŒâ€™ë¥¼ â€˜64â€™ë¡œ ë”ìš± ì¤„ì—¬ì•¼ í•  ìˆ˜ë„ ìˆìŠµë‹ˆë‹¤. ê·¸ë ‡ë‹¤ë©´ í›ˆë ¨ ì¤‘ì— ì•½ â€˜18.83GBâ€™ì˜ VRAMì„ ì†Œë¹„í•˜ê²Œ ë©ë‹ˆë‹¤.</p>
<p>ê²€ì¦ ì¶”ë¡  ì¤‘ì—ëŠ” ìµœëŒ€ ì•½ â€˜21.50GBâ€™ì˜ VRAMì´ ì‚¬ìš©ë©ë‹ˆë‹¤. ì´ ì •ë„ë©´ ì¶©ë¶„íˆ ì•ˆì „í•´ ë³´ì…ë‹ˆë‹¤.</p>
<p>â€˜ë°°ì¹˜ í¬ê¸°â€™ â€˜6â€™ ë° â€˜lora ìˆœìœ„&#x2F;ì•ŒíŒŒâ€™ â€˜768â€™ì˜ ë” ë†’ì€ ì‚¬ì–‘ êµìœ¡ì„ ì‚¬ìš©í•˜ê¸°ë¡œ ê²°ì •í•œ ê²½ìš° [ìœ„](https:&#x2F;&#x2F; <a target="_blank" rel="external nofollow noopener noreferrer" href="http://www.notion.so/Stable-Diffusion-3-5-Large-Fine-tuning-Tutorial-11a61cdcd1968027a15bdbd7c40be8c6?pvs=21">www.notion.so/Stable-Diffusion-3-5-Large-Fine-tuning-Tutorial-11a61cdcd1968027a15bdbd7c40be8c6?pvs=21</a>) GPU VRAMì´ ë¶€ì¡±í•˜ê³  CPU RAMì´ ì¶©ë¶„í•œ ê²½ìš°.</p>
<h3 id="Monitoring-the-training"><a href="#Monitoring-the-training" class="headerlink" title="Monitoring the training"></a>Monitoring the training</h3><p>í›ˆë ¨ ê³¼ì •ì—ì„œ ê²€ì¦ ì´ë¯¸ì§€ê°€ í”½ì…€í™”ë˜ê±°ë‚˜ ê²€ê²Œ ë³€í•˜ëŠ” ê²½ìš°ê°€ ìˆì„ ìˆ˜ ìˆìŠµë‹ˆë‹¤. ì´ëŠ” â€˜1.05e-3â€™ì´ë¼ëŠ” ë§¤ìš° ê³µê²©ì ì¸ í•™ìŠµë¥ ì„ ì‚¬ìš©í•˜ê³  ìˆê¸° ë•Œë¬¸ì…ë‹ˆë‹¤. ë” ì•ˆì „í•˜ê²Œ í”Œë ˆì´í•˜ê³  ì‹¶ë‹¤ë©´ â€˜9.5e-4â€™ë¥¼ ì‚¬ìš©í•˜ë©´ í”½ì…€í™” ë¬¸ì œê°€ ê±°ì˜ ë°œìƒí•˜ì§€ ì•ŠìŠµë‹ˆë‹¤. ê·¸ëŸ¼ì—ë„ ë¶ˆêµ¬í•˜ê³  ë‘ ì†ì‹¤ ê³¡ì„ ì€ ê²°êµ­ í›Œë¥­í•˜ê²Œ ìˆ˜ë ´í–ˆìŠµë‹ˆë‹¤.</p>
<p>í•˜ì§€ë§Œ ìš°ë ¤ì‚¬í•­ì„ í•´ì†Œí•˜ê¸° ìœ„í•´ ì–´ë–¤ ëª¨ìŠµì¼ì§€ ëª‡ ê°€ì§€ ì˜ˆë¥¼ ë³´ì—¬ë“œë¦¬ê³  ì‹¶ìŠµë‹ˆë‹¤.</p>
<h3 id="Observing-training-loss"><a href="#Observing-training-loss" class="headerlink" title="Observing training loss"></a>Observing training loss</h3><h3 id="LoRA"><a href="#LoRA" class="headerlink" title="LoRA"></a><code>LoRA</code></h3><p>íŒíƒ€ì§€ ì•„íŠ¸ â€˜LoRAâ€™ ìˆ˜ë ¨ì„ í†µí•´ ì–»ì€ í”¼ê·œì–´ë“¤ì…ë‹ˆë‹¤. ì†ì‹¤ì´ ê°ì†Œí•˜ê³  ìˆìœ¼ë©° ì•„ì§ ìˆ˜ë ´ë˜ì§€ ì•Šì•˜ìŠµë‹ˆë‹¤. ê·¸ëŸ¬ë‚˜ í™•ì‚° ëª¨ë¸ì„ ë¯¸ì„¸ ì¡°ì •í•œ ê²½í—˜ì´ ìˆëŠ” ê²½ìš° ì†ì‹¤ ìµœì†Œí™”ëŠ” ë¯¸ì  ê·¹ëŒ€í™”ì™€ ê±°ì˜ ê´€ë ¨ì´ ì—†ìŠµë‹ˆë‹¤. ë˜í•œ ë†’ì€ í•™ìŠµë¥ ì„ ì‚¬ìš©í•˜ëŠ” ê²½ìš° ì†ì‹¤ ê³¡ì„ ì˜ ìµœê³ ì  ê·¼ì²˜ì—ì„œ ê²€ì¦ ì´ë¯¸ì§€ì˜ í”½ì…€í™” ë˜ëŠ” í’ˆì§ˆ ì €í•˜ê°€ ë°œìƒí•  ìˆ˜ ìˆìŒì„ í™•ì¸í–ˆìŠµë‹ˆë‹¤. í›ˆë ¨ì´ ëª¨ë¸ ê°€ì¤‘ì¹˜ê°€ ë§Œì¡±ìŠ¤ëŸ½ì§€ ì•Šì€ í•™ìŠµ ì†ë„ì— ë„ë‹¬í•˜ë©´ ì´ëŠ” ì˜ë¯¸ê°€ ìˆìŠµë‹ˆë‹¤.</p>
<p>í•™ìŠµë¥ ì´ ë†’ìœ¼ë©´ ì—´ì°¨ ì†ì‹¤ë„ ìµœê³ ì ì— ë‹¬í•©ë‹ˆë‹¤.</p>
<h2 id="Evaluating-the-results"><a href="#Evaluating-the-results" class="headerlink" title="Evaluating the results"></a>Evaluating the results</h2><h3 id="How-to-actually-get-the-LoRA-models-into-ComfyUI"><a href="#How-to-actually-get-the-LoRA-models-into-ComfyUI" class="headerlink" title="How to actually get the LoRA models into ComfyUI"></a>How to actually get the LoRA models into ComfyUI</h3><p>ì´ì œ ëª¨ë¸ì´ ëª¨ë‘ í›ˆë ¨ë˜ì—ˆìœ¼ë¯€ë¡œ <code>ComfyUI</code>ë¥¼ ì‚¬ìš©í•˜ì—¬ í…ŒìŠ¤íŠ¸í•  ì°¨ë¡€ì…ë‹ˆë‹¤. ê·¸ëŸ¬ë‚˜ SimpleTunerê°€ ëª¨ë¸ì„ ì €ì¥í•˜ëŠ” ë°©ì‹ìœ¼ë¡œ ì¸í•´ â€˜ComfyUI&#x2F;models&#x2F;lorasâ€™ ë””ë ‰í„°ë¦¬ë¡œ ê°€ì ¸ì˜¤ê¸°ê°€ ì•½ê°„ ì–´ë µìŠµë‹ˆë‹¤.</p>
<p>ëª¨ë¸ì„ ì €ì¥í•œ ë””ë ‰í„°ë¦¬ë¡œ ì´ë™í•˜ë©´ í•´ë‹¹ í˜•ì‹ì´ ì´ í˜•ì‹ì¸ ê²ƒì„ ë³¼ ìˆ˜ ìˆìŠµë‹ˆë‹¤.</p>
<p>ê° ë””ë ‰í† ë¦¬ì—ì„œ ì›í•˜ëŠ” íŒŒì¼ì€ <code>pytorch_lora_weights.safetensors</code> íŒŒì¼ì…ë‹ˆë‹¤. ì´ëŸ¬í•œ íŒŒì¼ì„ <code>ComfyUI</code>ë¡œ ê°€ì ¸ì˜¤ëŠ” í”„ë¡œì„¸ìŠ¤ë¥¼ ê°„ì†Œí™”í•˜ê¸° ìœ„í•´ ë‹¤ìŒ ìŠ¤í¬ë¦½íŠ¸ë¥¼ ì‘ì„±í–ˆìŠµë‹ˆë‹¤.</p>
<ul>
<li><p><code>create_symlinks_lora.sh</code></p>
  <figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#!/bin/bash</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># Source directory where the models are stored</span></span><br><span class="line">SOURCE_DIR=<span class="string">&quot;/weka2/home-yeo/simpletuner_models/sd3_large/full_finetune/fantasy_art_L_01/datasets/models&quot;</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># Target directory for symlinks</span></span><br><span class="line">TARGET_DIR=<span class="string">&quot;/weka2/home-yeo/ComfyUI/models/loras/sd35_large/fantasy_art&quot;</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># Ensure target directory exists or create it</span></span><br><span class="line"><span class="built_in">mkdir</span> -p <span class="string">&quot;<span class="variable">$&#123;TARGET_DIR&#125;</span>&quot;</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># Iterate over each checkpoint directory</span></span><br><span class="line"><span class="keyword">for</span> CHECKPOINT_DIR <span class="keyword">in</span> <span class="variable">$&#123;SOURCE_DIR&#125;</span>/checkpoint-*; <span class="keyword">do</span></span><br><span class="line">    <span class="comment"># Check if it&#x27;s indeed a directory</span></span><br><span class="line">    <span class="keyword">if</span> [ -d <span class="string">&quot;<span class="variable">$&#123;CHECKPOINT_DIR&#125;</span>&quot;</span> ]; <span class="keyword">then</span></span><br><span class="line">        <span class="comment"># Extract the checkpoint number from the directory name</span></span><br><span class="line">        CHECKPOINT_NAME=$(<span class="built_in">basename</span> <span class="variable">$&#123;CHECKPOINT_DIR&#125;</span>)</span><br><span class="line">        </span><br><span class="line">        <span class="comment"># Define the source file path</span></span><br><span class="line">        SOURCE_FILE=<span class="string">&quot;<span class="variable">$&#123;CHECKPOINT_DIR&#125;</span>/pytorch_lora_weights.safetensors&quot;</span></span><br><span class="line">        </span><br><span class="line">        <span class="comment"># Define the symlink name with &#x27;lora&#x27; added before &#x27;safetensors&#x27;</span></span><br><span class="line">        LINK_NAME=<span class="string">&quot;<span class="variable">$&#123;TARGET_DIR&#125;</span>/<span class="variable">$&#123;CHECKPOINT_NAME&#125;</span>_lora.safetensors&quot;</span></span><br><span class="line">        </span><br><span class="line">        <span class="comment"># Check if the source file exists</span></span><br><span class="line">        <span class="keyword">if</span> [ -f <span class="string">&quot;<span class="variable">$&#123;SOURCE_FILE&#125;</span>&quot;</span> ]; <span class="keyword">then</span></span><br><span class="line">            <span class="comment"># Create a symlink in the target directory</span></span><br><span class="line">            <span class="built_in">echo</span> <span class="string">&quot;Creating symlink from <span class="variable">$&#123;SOURCE_FILE&#125;</span> to <span class="variable">$&#123;LINK_NAME&#125;</span>&quot;</span></span><br><span class="line">            <span class="built_in">ln</span> -s <span class="string">&quot;<span class="variable">$&#123;SOURCE_FILE&#125;</span>&quot;</span> <span class="string">&quot;<span class="variable">$&#123;LINK_NAME&#125;</span>&quot;</span></span><br><span class="line">            <span class="built_in">echo</span> <span class="string">&quot;Symlink created for <span class="variable">$&#123;CHECKPOINT_NAME&#125;</span>&quot;</span></span><br><span class="line">        <span class="keyword">else</span></span><br><span class="line">            <span class="built_in">echo</span> <span class="string">&quot;File not found: <span class="variable">$&#123;SOURCE_FILE&#125;</span>&quot;</span></span><br><span class="line">        <span class="keyword">fi</span></span><br><span class="line">    <span class="keyword">else</span></span><br><span class="line">        <span class="built_in">echo</span> <span class="string">&quot;Not a directory: <span class="variable">$&#123;CHECKPOINT_DIR&#125;</span>&quot;</span></span><br><span class="line">    <span class="keyword">fi</span></span><br><span class="line"><span class="keyword">done</span></span><br><span class="line"></span><br><span class="line"><span class="built_in">echo</span> <span class="string">&quot;Symlinking complete.&quot;</span></span><br></pre></td></tr></table></figure></li>
</ul>
<p>ìœ„ì˜ ì‰˜ ìŠ¤í¬ë¦½íŠ¸ê°€ ìˆ˜í–‰í•  ì‘ì—…ì€ <code>SimpleTuner</code>ì—ì„œ <code>SOURCE_DIR</code>ì„ ë°˜ë³µí•œ ë‹¤ìŒ <em><strong>ë§Œ</strong></em> <code>pytorch_lora_weights.safetensors</code> íŒŒì¼ì„ <code>TARGET_DIR</code>ì— ì‹¬ë³¼ë¦­ ë§í¬í•˜ëŠ” ê²ƒì…ë‹ˆë‹¤. ì´ íŒŒì¼ì€ <code>ComfyUI ë‚´ë¶€ ë””ë ‰í† ë¦¬ì—¬ì•¼ í•©ë‹ˆë‹¤. /ëª¨ë¸/ë¡œë¼ìŠ¤</code>. íŒŒì¼ì„ ì¶”ì í•˜ê¸° ìœ„í•´ íŒŒì¼ ì´ë¦„ ì•ˆì— í•´ë‹¹ ì²´í¬í¬ì¸íŠ¸ ë²ˆí˜¸ê°€ í¬í•¨ë˜ë„ë¡ ì´ë¦„ë„ ë³€ê²½í–ˆìŠµë‹ˆë‹¤.</p>
<h3 id="Determining-the-best-checkpoint"><a href="#Determining-the-best-checkpoint" class="headerlink" title="Determining the best checkpoint"></a>Determining the best checkpoint</h3><p>ì œê°€ ì‚¬ìš©í•˜ê³  ìˆëŠ” ê¸°ë³¸ì ì¸ â€˜SD3.5 Largeâ€™ ì›Œí¬í”Œë¡œëŠ” ì´ê²ƒì´ì—ˆìŠµë‹ˆë‹¤.</p>
<p>ê°€ì¥ ì¢‹ì€ ì²´í¬í¬ì¸íŠ¸ë¥¼ ê²°ì •í•˜ëŠ” ë°©ë²•ì€ íŠ¹ì • í”„ë¡¬í”„íŠ¸ì— ëŒ€í•´ xì¶•ì— ì²´í¬í¬ì¸íŠ¸ ë²ˆí˜¸ë¥¼ í‘œì‹œí•˜ëŠ” ê²ƒì…ë‹ˆë‹¤. ê·¸ë˜ì„œ ì €ëŠ” ë‹¤ìŒê³¼ ê°™ì€ ë‹¨ì¼ ìŠ¤íŠ¸ë¦½ì„ ì–»ìŠµë‹ˆë‹¤.</p>
<p>íŒíƒ€ì§€ ì•„íŠ¸ â€˜LoRAâ€™</p>
<p>Prompt</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">a three fourth perspective waist up portrait view of a young woman with messy long blonde hair and light purple eyes, looking at viewer with a closed mouth smile, wearing tight black dress, a faded pink simple background during golden hour</span><br></pre></td></tr></table></figure>



<p>ì´ë¥¼ ìœ„í•´ <code>ComfyUI</code> ì›Œí¬í”Œë¡œì˜ <code>api</code> ë²„ì „ì— ë¡œë“œë˜ëŠ” ì‚¬ìš©ì ì •ì˜ ìŠ¤í¬ë¦½íŠ¸ë¥¼ ì‚¬ìš©í•©ë‹ˆë‹¤. ì €ì¥(API í˜•ì‹) ë²„íŠ¼ì„ í´ë¦­í•˜ë©´ ëª¨ë“  ì›Œí¬í”Œë¡œìš°ë¥¼ â€˜APIâ€™ í˜•ì‹ìœ¼ë¡œ ì €ì¥í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤. ê·€í•˜ê°€ ì‚¬ìš©í•  ìˆ˜ ìˆë„ë¡ ì´ë¯¸ ìœ„ ë²„ì „ì„ ì €ì¥í–ˆìŠµë‹ˆë‹¤. â€˜ComfyUIâ€™ API ì‚¬ìš©ì— ëŒ€í•œ ë” ì‹¬ì¸µì ì¸ ë¹„ë””ì˜¤ ê°€ì´ë“œë¥¼ ì›í•˜ì‹œë©´ ì œê°€ ì‘ë…„ì— <a target="_blank" rel="external nofollow noopener noreferrer" href="https://youtu.be/WwsJ_QIgsG8">ì—¬ê¸°</a>ë¥¼ ë§Œë“¤ì—ˆìŠµë‹ˆë‹¤.</p>
<p><code>ComfyUI</code>ê°€ ì‹¤í–‰ ì¤‘ì¸ì§€ í™•ì¸í•œ í›„ ì•„ë˜ ìŠ¤í¬ë¦½íŠ¸ë¥¼ ì‹¤í–‰í•˜ì„¸ìš”. ë˜í•œ ìŠ¤í¬ë¦½íŠ¸ë¥¼ ì‹¤í–‰í•˜ëŠ” ë™ì¼í•œ ìœ„ì¹˜ì— <code>.env</code> íŒŒì¼ì„ ì„¤ì •í•´ì•¼ í•©ë‹ˆë‹¤.</p>
<ul>
<li><p><code>API script</code></p>
<p>This is my custom <code>python</code> script:</p>
  <figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br></pre></td><td class="code"><pre><span class="line">import os</span><br><span class="line">import json</span><br><span class="line">import random</span><br><span class="line">from urllib import request</span><br><span class="line">import datetime</span><br><span class="line">from PIL import Image, ImageDraw, ImageFont</span><br><span class="line">import time</span><br><span class="line">import re</span><br><span class="line">import urllib.error</span><br><span class="line"></span><br><span class="line">from dotenv import load_dotenv</span><br><span class="line">load_dotenv()</span><br><span class="line"></span><br><span class="line"># Configuration</span><br><span class="line">api_workflow_dir = os.getenv(&quot;API_WORKFLOW_DIR&quot;)</span><br><span class="line">lora_dir = os.getenv(&quot;LORA_DIR&quot;)</span><br><span class="line"></span><br><span class="line">api_workflow_file = os.getenv(&quot;API_WORKFLOW_FILE&quot;)</span><br><span class="line">api_endpoint = os.getenv(&quot;API_ENDPOINT&quot;)</span><br><span class="line">image_output_dir = os.getenv(&quot;IMAGE_OUTPUT_DIR&quot;)</span><br><span class="line">font_ttf_path = os.getenv(&quot;FONT_TTF_PATH&quot;)</span><br><span class="line"></span><br><span class="line">comfyui_output_dir = os.getenv(&quot;COMFYUI_OUTPUT_DIR&quot;)</span><br><span class="line"></span><br><span class="line">api_endpoint = f&quot;http://&#123;api_endpoint&#125;/prompt&quot;</span><br><span class="line"></span><br><span class="line">workflow_file_path = os.path.join(api_workflow_dir, api_workflow_file)</span><br><span class="line">workflow = json.load(open(workflow_file_path))</span><br><span class="line"></span><br><span class="line">current_datetime = datetime.datetime.now().strftime(&quot;%Y-%m-%d_%H-%M-%S&quot;)</span><br><span class="line">relative_output_path = current_datetime</span><br><span class="line"></span><br><span class="line">directory_creation_timeout = 3000  # Timeout for directory creation in seconds</span><br><span class="line">image_generation_timeout = 30000  # Timeout for image generation in seconds</span><br><span class="line"></span><br><span class="line">def get_checkpoint_number(filename):</span><br><span class="line">    match = re.search(r&#x27;checkpoint-(\d+)&#x27;, filename)</span><br><span class="line">    if match:</span><br><span class="line">        return int(match.group(1))</span><br><span class="line">    match = re.search(r&#x27;/checkpoint-(\d+)/&#x27;, filename)</span><br><span class="line">    if match:</span><br><span class="line">        return int(match.group(1))</span><br><span class="line">    return None</span><br><span class="line"></span><br><span class="line">def get_most_recent_output_folder(base_dir):</span><br><span class="line">    folders = [f for f in os.listdir(base_dir) if os.path.isdir(os.path.join(base_dir, f))]</span><br><span class="line">    if not folders:</span><br><span class="line">        return None</span><br><span class="line">    return max(folders, key=lambda f: os.path.getctime(os.path.join(base_dir, f)))</span><br><span class="line"></span><br><span class="line">def process_loras(lora_dir, workflow):</span><br><span class="line">    print(f&quot;Scanning directory: &#123;lora_dir&#125;&quot;)</span><br><span class="line">    </span><br><span class="line">    # Extract the last two directories from LORA_DIR</span><br><span class="line">    lora_path_parts = lora_dir.split(&#x27;/&#x27;)</span><br><span class="line">    dynamic_lora_path = &#x27;/&#x27;.join(lora_path_parts[-2:])</span><br><span class="line">    </span><br><span class="line">    all_items = os.listdir(lora_dir)</span><br><span class="line">    </span><br><span class="line">    lora_items = [f for f in all_items if f.endswith(&#x27;_lora.safetensors&#x27;)]</span><br><span class="line">    </span><br><span class="line">    lora_items.sort(key=lambda x: int(x.split(&#x27;-&#x27;)[1].split(&#x27;_&#x27;)[0]))</span><br><span class="line">    </span><br><span class="line">    print(f&quot;Found items: &#123;lora_items&#125;&quot;)</span><br><span class="line">    </span><br><span class="line">    for item in lora_items:</span><br><span class="line">        checkpoint_num = item.split(&#x27;-&#x27;)[1].split(&#x27;_&#x27;)[0]</span><br><span class="line">        </span><br><span class="line">        print(f&quot;Processing: &#123;item&#125;&quot;)</span><br><span class="line"></span><br><span class="line">        # Update the LoRA loader node</span><br><span class="line">        lora_loader_node = workflow[&quot;276&quot;]</span><br><span class="line">        lora_loader_node[&quot;inputs&quot;][&quot;lora_name&quot;] = f&quot;&#123;dynamic_lora_path&#125;/&#123;item&#125;&quot;</span><br><span class="line"></span><br><span class="line">        save_image = workflow[&quot;314&quot;]</span><br><span class="line">        filename_prefix = f&quot;checkpoint-&#123;checkpoint_num&#125;&quot;</span><br><span class="line">        save_image[&quot;inputs&quot;][&quot;output_path&quot;] = relative_output_path</span><br><span class="line">        save_image[&quot;inputs&quot;][&quot;filename_prefix&quot;] = filename_prefix</span><br><span class="line"></span><br><span class="line">        success = queue_prompt(workflow)</span><br><span class="line">        if not success:</span><br><span class="line">            print(f&quot;Failed to queue prompt for checkpoint &#123;checkpoint_num&#125;&quot;)</span><br><span class="line">        else:</span><br><span class="line">            print(f&quot;Successfully queued prompt for checkpoint &#123;checkpoint_num&#125;&quot;)</span><br><span class="line"></span><br><span class="line">    if not lora_items:</span><br><span class="line">        print(&quot;No LoRA files found in the directory.&quot;)</span><br><span class="line">    </span><br><span class="line">    return len(lora_items)</span><br><span class="line"></span><br><span class="line">def create_image_strip(lora_dir, image_folder, output_filename):</span><br><span class="line">    lora_files = [f for f in os.listdir(lora_dir) if f.endswith(&#x27;_lora.safetensors&#x27;)]</span><br><span class="line">    lora_files.sort(key=get_checkpoint_number)</span><br><span class="line">    checkpoints = [get_checkpoint_number(f) for f in lora_files if get_checkpoint_number(f) is not None]</span><br><span class="line"></span><br><span class="line">    images = []</span><br><span class="line">    for checkpoint in checkpoints:</span><br><span class="line">        filename = f&quot;checkpoint-&#123;checkpoint&#125;_0001.png&quot;</span><br><span class="line">        filepath = os.path.join(image_folder, filename)</span><br><span class="line">        if os.path.exists(filepath):</span><br><span class="line">            try:</span><br><span class="line">                img = Image.open(filepath)</span><br><span class="line">                images.append(img)</span><br><span class="line">            except IOError as e:</span><br><span class="line">                print(f&quot;Cannot open image: &#123;filepath&#125;&quot;)</span><br><span class="line">                print(f&quot;Error: &#123;e&#125;&quot;)</span><br><span class="line"></span><br><span class="line">    if not images:</span><br><span class="line">        print(&quot;No valid images found.&quot;)</span><br><span class="line">        return</span><br><span class="line"></span><br><span class="line">    img_width, img_height = images[0].size</span><br><span class="line">    strip_width = img_width * len(images)</span><br><span class="line">    label_height = 50  # Space for labels</span><br><span class="line">    strip_height = img_height + label_height</span><br><span class="line"></span><br><span class="line">    strip_image = Image.new(&#x27;RGB&#x27;, (strip_width, strip_height), &#x27;white&#x27;)</span><br><span class="line">    draw = ImageDraw.Draw(strip_image)</span><br><span class="line">    font = ImageFont.truetype(font_ttf_path, 20)</span><br><span class="line"></span><br><span class="line">    for i, (img, checkpoint) in enumerate(zip(images, checkpoints)):</span><br><span class="line">        strip_image.paste(img, (i * img_width, label_height))</span><br><span class="line">        </span><br><span class="line">        label = f&quot;checkpoint-&#123;checkpoint&#125;&quot;</span><br><span class="line">        label_width = draw.textlength(label, font=font)</span><br><span class="line">        label_x = i * img_width + (img_width - label_width) // 2</span><br><span class="line">        draw.text((label_x, 10), label, fill=&quot;black&quot;, font=font)</span><br><span class="line"></span><br><span class="line">    strip_image.save(output_filename)</span><br><span class="line">    print(f&quot;Image strip saved to: &#123;output_filename&#125;&quot;)</span><br><span class="line"></span><br><span class="line">def queue_prompt(workflow):</span><br><span class="line">    p = &#123;&quot;prompt&quot;: workflow&#125;</span><br><span class="line">    data = json.dumps(p).encode(&#x27;utf-8&#x27;)</span><br><span class="line">    req = request.Request(api_endpoint, data=data, headers=&#123;&#x27;Content-Type&#x27;: &#x27;application/json&#x27;&#125;)</span><br><span class="line">    try:</span><br><span class="line">        with request.urlopen(req) as response:</span><br><span class="line">            print(f&quot;API request successful. Status code: &#123;response.getcode()&#125;&quot;)</span><br><span class="line">            return True</span><br><span class="line">    except urllib.error.URLError as e:</span><br><span class="line">        if hasattr(e, &#x27;reason&#x27;):</span><br><span class="line">            print(f&quot;Failed to reach the server. Reason: &#123;e.reason&#125;&quot;)</span><br><span class="line">        elif hasattr(e, &#x27;code&#x27;):</span><br><span class="line">            print(f&quot;The server couldn&#x27;t fulfill the request. Error code: &#123;e.code&#125;&quot;)</span><br><span class="line">        print(f&quot;API endpoint: &#123;api_endpoint&#125;&quot;)</span><br><span class="line">    except Exception as e:</span><br><span class="line">        print(f&quot;An error occurred: &#123;str(e)&#125;&quot;)</span><br><span class="line">    return False</span><br><span class="line"></span><br><span class="line">def wait_for_directory_creation(directory, timeout):</span><br><span class="line">    print(f&quot;Waiting for directory &#123;directory&#125; to be created...&quot;)</span><br><span class="line">    start_time = time.time()</span><br><span class="line">    while time.time() - start_time &lt; timeout:</span><br><span class="line">        if os.path.exists(directory):</span><br><span class="line">            print(f&quot;Directory &#123;directory&#125; found.&quot;)</span><br><span class="line">            return True</span><br><span class="line">        time.sleep(5)  # Check every 5 seconds</span><br><span class="line">    print(f&quot;Timeout waiting for directory &#123;directory&#125; to be created.&quot;)</span><br><span class="line">    return False</span><br><span class="line"></span><br><span class="line">def wait_for_images(image_folder, expected_count, timeout):</span><br><span class="line">    print(&quot;Waiting for images to be generated...&quot;)</span><br><span class="line">    start_time = time.time()</span><br><span class="line">    while time.time() - start_time &lt; timeout:</span><br><span class="line">        if os.path.exists(image_folder):</span><br><span class="line">            image_files = [f for f in os.listdir(image_folder) if f.endswith(&#x27;.png&#x27;)]</span><br><span class="line">            if len(image_files) &gt;= expected_count:</span><br><span class="line">                print(f&quot;Found all &#123;expected_count&#125; images.&quot;)</span><br><span class="line">                return True</span><br><span class="line">        time.sleep(5)  # Check every 5 seconds</span><br><span class="line">    print(&quot;Timeout waiting for images to be generated.&quot;)</span><br><span class="line">    return False</span><br><span class="line"></span><br><span class="line">if __name__ == &quot;__main__&quot;:</span><br><span class="line">    print(f&quot;LoRA directory: &#123;lora_dir&#125;&quot;)</span><br><span class="line"></span><br><span class="line">    # Generate images</span><br><span class="line">    expected_image_count = process_loras(lora_dir, workflow)</span><br><span class="line"></span><br><span class="line">    absolute_output_path = os.path.join(comfyui_output_dir, current_datetime)</span><br><span class="line">    print(f&quot;Absolute output path: &#123;absolute_output_path&#125;&quot;)</span><br><span class="line"></span><br><span class="line">    # Create the image strip</span><br><span class="line">    if wait_for_directory_creation(absolute_output_path, directory_creation_timeout):</span><br><span class="line">        print(f&quot;Expected image count: &#123;expected_image_count&#125;&quot;)</span><br><span class="line">        if wait_for_images(absolute_output_path, expected_image_count, image_generation_timeout):</span><br><span class="line">            output_strip_filename = os.path.join(absolute_output_path, &quot;output_image_strip.png&quot;)</span><br><span class="line">            create_image_strip(lora_dir, absolute_output_path, output_strip_filename)</span><br><span class="line">        else:</span><br><span class="line">            print(&quot;Failed to generate all images in time.&quot;)</span><br><span class="line">    else:</span><br><span class="line">        print(&quot;Output directory was not created.&quot;)</span><br></pre></td></tr></table></figure>
</li>
<li><p>sample <code>.env</code> file</p>
  <figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">API_WORKFLOW_DIR=/weka2/home-yeo/workflows</span><br><span class="line">COMFYUI_OUTPUT_DIR = /weka2/home-yeo/ComfyUI/output/</span><br><span class="line">LORA_DIR=/admin/home-yeo/workspace/ComfyUI/models/loras/sd35_large/fantasy_art_01</span><br><span class="line">API_WORKFLOW_FILE=sd35_fantasy_art_02_api.json</span><br><span class="line">API_ENDPOINT=127.0.0.1:8188</span><br><span class="line">FONT_TTF_PATH=/weka2/home-yeo/fonts/arial.ttf</span><br><span class="line">BOLD_FONT_TTF_PATH=/weka2/home-yeo/fonts/arialbd.ttf</span><br></pre></td></tr></table></figure></li>
</ul>
<p>Fantasy Art <code>LoRA</code></p>
<p>Prompt</p>
<figure class="highlight markdown"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">a three fourth perspective waist up portrait view of a young woman with messy long blonde hair and light purple eyes, looking at viewer with a closed mouth smile, wearing tight black dress, a faded pink simple background during golden hour</span><br></pre></td></tr></table></figure>

<p>ê²°êµ­ â€˜24,000â€™ ë‹¨ê³„ì—ì„œ ê±°ì˜ ë§ˆì§€ë§‰ì— ì²´í¬í¬ì¸íŠ¸ë¥¼ ì„ íƒí•˜ê²Œ ë˜ì—ˆìŠµë‹ˆë‹¤.</p>
<p>ë‚˜ëŠ” ë˜í•œ ê±´ì „ì„± í™•ì¸ì„ ìœ„í•´ ìˆ˜í–‰í•œ ë‹¤ë¥¸ ëª¨ë“  í›ˆë ¨ì— ëŒ€í•´ ë™ì¼í•œ ì‹¤í—˜ì„ ì‹¤í–‰í–ˆìŠµë‹ˆë‹¤.</p>
<p>Cinema Photo <code>LoRA</code></p>
<p>Prompt</p>
<figure class="highlight markdown"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">a few hooded figures walking on an empty road in the rain, desolate, high skyscrapers</span><br></pre></td></tr></table></figure>

<p>John Singer Sargent <code>LoRA</code></p>
<p>Prompt</p>
<figure class="highlight markdown"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">an abandoned beach with a lighthouse</span><br></pre></td></tr></table></figure>

<p>Underexposed Photography <code>LoRA</code></p>
<p>Prompt</p>
<figure class="highlight markdown"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">waist up view of a woman posing on a runway, streetwear in the style of alexander mcqueen</span><br></pre></td></tr></table></figure>


<p>ì „ë¬¸ì ì¸ ì´ìœ ë¡œ ì›ë˜ ê·¸ë¦¬ë“œì˜ íŠ¹ì • ë¶€ë¶„ì´ ìƒëµë˜ì—ˆìŠµë‹ˆë‹¤. ì „ì²´ ê·¸ë¦¬ë“œì—ëŠ” ëª¨ë“  ì²­ì¤‘ì—ê²Œ ì í•©í•˜ì§€ ì•Šì„ ìˆ˜ ìˆëŠ” ì½˜í…ì¸ ê°€ í¬í•¨ë˜ì–´ ìˆìœ¼ë¯€ë¡œ ê¸°ìˆ ì ì¸ ì¸¡ë©´ì— ì´ˆì ì„ ë§ì¶”ê¸° ìœ„í•´ ì˜ë¦° ë²„ì „ì´ í‘œì‹œë©ë‹ˆë‹¤.</p>
<p>Pixel Art <code>LoRA</code></p>
<p>Prompt</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">a plush chibi mythical creature</span><br></pre></td></tr></table></figure>

<p>Ethnic Paint <code>LoRA</code></p>
<p>Prompt</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">a skyline view of a futuristic maritime village floating above ground, <span class="keyword">in</span> the clouds, towering skyscrapers, golden hour, day time lighting</span><br></pre></td></tr></table></figure>

<h2 id="A-x2F-B-evaluation"><a href="#A-x2F-B-evaluation" class="headerlink" title="A&#x2F;B evaluation"></a>A&#x2F;B evaluation</h2><h3 id="Improving-x2F-tuning-generations-with-APG-scaling"><a href="#Improving-x2F-tuning-generations-with-APG-scaling" class="headerlink" title="Improving&#x2F;tuning generations with APG scaling"></a>Improving&#x2F;tuning generations with APG scaling</h3><p>ìµœê³ ì˜ ë¯¸ì  ê²°ê³¼ë¥¼ ì œê³µí•˜ëŠ” â€˜LoRAâ€™ ì²´í¬í¬ì¸íŠ¸ë¥¼ ì°¾ì•˜ìœ¼ë©´ â€˜APGâ€™ ìŠ¤ì¼€ì¼ë§ì„ í†µí•´ ì´ë¥¼ ë”ìš± í–¥ìƒì‹œí‚¬ ìˆ˜ ìˆìŠµë‹ˆë‹¤. â€˜APGâ€™ ìŠ¤ì¼€ì¼ë§ì€ ì ì‘í˜• ì˜ˆì¸¡ ì§€ì¹¨ì„ ì˜ë¯¸í•©ë‹ˆë‹¤.</p>
<p><a target="_blank" rel="external nofollow noopener noreferrer" href="https://arxiv.org/abs/2410.02416">APG ë…¼ë¬¸</a> ì´ˆë¡ì˜ í•µì‹¬ ë¶€ë¶„</p>
<figure class="highlight markdown"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">Our approach, termed adaptive projected guidance (APG), retains the quality-boosting advantages of CFG while enabling the use of higher guidance scales without oversaturation. APG is easy to implement and introduces practically no additional computational overhead to the sampling process.</span><br></pre></td></tr></table></figure>

<p>ì´ê²ƒì´ ì´ ìƒ˜í”Œ ì›Œí¬í”Œë¡œì— í¬í•¨ëœ <a target="_blank" rel="external nofollow noopener noreferrer" href="https://github.com/logtd/ComfyUI-APGScaling">ComfyUI ë…¸ë“œ</a>ì…ë‹ˆë‹¤. ì„¸ ê°€ì§€ ë‹¤ë¥¸ ì´ë¯¸ì§€ë¥¼ ìƒì„±í•©ë‹ˆë‹¤. í•˜ë‚˜ëŠ” ê¸°ë³¸ ì´ë¯¸ì§€, í•˜ë‚˜ëŠ” ***<code>APG</code> ìŠ¤ì¼€ì¼ë§ ì—†ì´ ***<code>LoRA</code> ì ìš©, ì„¸ ë²ˆì§¸ ì´ë¯¸ì§€ëŠ” ***<code>ì‚¬ìš©***</code> LoRA<code> ì ìš© APG</code> ìŠ¤ì¼€ì¼ë§.</p>
<p>The parameters for APG are:</p>
<figure class="highlight markdown"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">eta</span><br><span class="line">norm<span class="emphasis">_threshold</span></span><br><span class="line"><span class="emphasis">use_</span>momentum</span><br><span class="line">momentum</span><br></pre></td></tr></table></figure>

<p>ì´ ë…¸ë“œì— ëŒ€í•´ ê·¸ë ‡ê²Œ ë§ì´ ì‹¬ì¸µ ë¶„ì„í•˜ì§€ëŠ” ì•Šì•˜ì§€ë§Œ ì´ë¯¸ì§€ í’ˆì§ˆì´ ì¢‹ë“  ë‚˜ì˜ë“  ë³€ê²½ë©ë‹ˆë‹¤.</p>
<h3 id="Before-and-after-comparison"><a href="#Before-and-after-comparison" class="headerlink" title="Before and after comparison"></a>Before and after comparison</h3><p>Fantasy Art</p>
<p>Prompt</p>
<figure class="highlight markdown"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">a three fourth perspective waist up portrait view of a young woman with messy long blonde hair and light purple eyes, perfect face, looking at viewer with a closed mouth smile, wearing loose black dress, a faded pink simple background during golden hour</span><br></pre></td></tr></table></figure>

<p><code>Base model</code></p>
<p><code>LoRA</code></p>
<p><code>LoRA</code> + <code>APG</code></p>
<p>Cinema Photo</p>
<p>Prompt</p>
<figure class="highlight markdown"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">a wide view of a figure looking up at a meteor breaking apart</span><br></pre></td></tr></table></figure>

<p><code>Base model</code></p>
<p><code>LoRA</code></p>
<p><code>LoRA</code> + <code>APG</code></p>
<p>John Singer Sargent</p>
<p>Prompt</p>
<figure class="highlight markdown"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">an abandoned beach with a lighthouse</span><br></pre></td></tr></table></figure>

<p><code>Base model</code></p>
<p><code>LoRA</code></p>
<p><code>LoRA</code> + <code>APG</code></p>
<p>Underexposed Photography</p>
<p>Prompt</p>
<figure class="highlight markdown"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">waist up view of a woman posing on a runway, streetwear in the style of alexander mcqueen</span><br></pre></td></tr></table></figure>

<p><code>Base model</code></p>
<p><code>LoRA</code></p>
<p><code>LoRA</code> + <code>APG</code></p>
<p>Pixel Art</p>
<p>Prompt</p>
<figure class="highlight markdown"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">a sci-fi venetian town near the water</span><br></pre></td></tr></table></figure>

<p><code>Base model</code></p>
<p><code>LoRA</code></p>
<p><code>LoRA</code> + <code>APG</code></p>
<p>Ethnic Paint</p>
<p>Prompt</p>
<figure class="highlight markdown"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">a man in his late 30s to early 40s, rendered in a dark, moody style, The subject is depicted from the shoulders up, facing the viewer directly, He has a full, thick beard and mustache, which is dark and well-groomed, with a few strands of gray, His hair is short and neatly combed, with a few strands falling over his forehead, His eyes are dark and piercing, with a slight hint of sadness or introspection, </span><br></pre></td></tr></table></figure>

<p><code>Base model</code></p>
<p><code>LoRA</code></p>
<p><code>LoRA</code> + <code>APG</code></p>
<p><code>APG</code> ëŠ” ê·¸ ë§ì— ì¶©ì‹¤í•œ ê²ƒ ê°™ìŠµë‹ˆë‹¤. ì±„ë„ë¥¼ ì¤„ì—¬ì¤ë‹ˆë‹¤. ê°œì¸ì ìœ¼ë¡œ ë‚˜ëŠ” ë°”ëœ ìƒ‰ìƒì„ ì„ í˜¸í•˜ì§€ ì•Šì§€ë§Œ ë°‹ë°‹í•œ â€œRAWâ€ ê°™ì€ ì´ë¯¸ì§€ë¥¼ ì–»ì„ ìˆ˜ ìˆëŠ” ì¢‹ì€ ë°©ë²•ì´ ë  ìˆ˜ ìˆìŠµë‹ˆë‹¤.</p>
<h2 id="Other-fine-tuning-tools-x2F-libraries-for-SD3-5"><a href="#Other-fine-tuning-tools-x2F-libraries-for-SD3-5" class="headerlink" title="Other fine-tuning tools&#x2F;libraries for SD3.5"></a>Other fine-tuning tools&#x2F;libraries for SD3.5</h2><p>Hugging Faceì˜ <a target="_blank" rel="external nofollow noopener noreferrer" href="https://huggingface.co/blog/sd3-5#training-loras-with-sd35-large-with-Quantization">ì´ ìŠ¤í¬ë¦½íŠ¸ ë° êµ¬ì„±</a>ì„ ì°¸ì¡°í•˜ì„¸ìš”. ì´ëŠ” ì‚¬ìš©í•˜ê¸°ê°€ ë” ê°„ë‹¨í•˜ì§€ë§Œ ê²°ê³¼ëŠ” ì•½ê°„ ë” ë‚˜ì  ìˆ˜ ìˆìŠµë‹ˆë‹¤.</p>
<h2 id="Conclusion-amp-Feedback"><a href="#Conclusion-amp-Feedback" class="headerlink" title="Conclusion &amp; Feedback"></a>Conclusion &amp; Feedback</h2><p>ì—¬ê¸° ìˆëŠ” ëª¨ë“  ì •ë³´ê°€ ì¶œì‹œì¼ì— SD3.5 Largeë¥¼ ë¯¸ì„¸ ì¡°ì •í•˜ëŠ” ë° ë„ì›€ì´ ë˜ê¸°ë¥¼ ë°”ëë‹ˆë‹¤. â€˜DiTâ€™ ì•„í‚¤í…ì²˜ëŠ” ì—¬ì „íˆ ìƒëŒ€ì ìœ¼ë¡œ ìƒˆë¡œìš´ ê²ƒì´ê¸° ë•Œë¬¸ì— ìš°ë¦¬ëŠ” êµ¬ì„±, ì§ˆê° ë° ì „ì²´ì ì¸ ë¯¸í•™ ì¸¡ë©´ì—ì„œ ìµœê³ ì˜ ì´ë¯¸ì§€ í’ˆì§ˆì„ ë‹¬ì„±í•˜ê¸° ìœ„í•´ ë‹¤ì–‘í•œ ë°©ë²•ì„ ì‹œë„í–ˆìŠµë‹ˆë‹¤. ìµœìƒì˜ ê²°ê³¼ë¥¼ ì–»ì§€ ëª»í•˜ëŠ” ë¬¸ì œê°€ ë°œìƒí•˜ëŠ” ê²½ìš° í›ˆë ¨ ì¤‘ì— ë³´ë‹¤ ì„¸ë¶€ì ì¸ ë ˆì´ì–´ ì¡°ì‘ì„ ì ê·¹ ê¶Œì¥í•©ë‹ˆë‹¤.</p>
<h2 id="Two-cents-from-Dango"><a href="#Two-cents-from-Dango" class="headerlink" title="Two cents from Dango"></a>Two cents from Dango</h2><p>ë”°ë¼ì„œ SD3.5 ì‹œë¦¬ì¦ˆì˜ ì£¼ìš” ì„¤ê³„ì ì¤‘ í•˜ë‚˜ì¸ Dangoì˜ ì¶”ê°€ ì •ë³´ëŠ” ë‹¤ìŒê³¼ ê°™ìŠµë‹ˆë‹¤.</p>
<p><a target="_blank" rel="external nofollow noopener noreferrer" href="https://huggingface.co/Dango233">Dangoâ€™s Hugging Face profile</a></p>
<h3 id="Diving-into-SD3-5-Large-Architecture"><a href="#Diving-into-SD3-5-Large-Architecture" class="headerlink" title="Diving into SD3.5 Large Architecture"></a>Diving into SD3.5 Large Architecture</h3><p>SD 3.5 Largeì˜ í° ê·¸ë¦¼ì„ ì´í•´í•˜ê¸° ìœ„í•´ ë¨¼ì € ì•„í‚¤í…ì²˜ë¥¼ ì¸ì‡„í•´ ë³´ê² ìŠµë‹ˆë‹¤.</p>
<p>ëª¨ë¸ì„ ë¡œì»¬ ë””ë ‰í„°ë¦¬ì— ë‹¤ìš´ë¡œë“œí•˜ëŠ” ê²½ìš° <code>stable-diffusion-3-medium-diffusers</code>ì™€ ìœ ì‚¬í•œ íŒŒì¼ êµ¬ì¡°ë¥¼ ê°€ì ¸ì•¼ í•©ë‹ˆë‹¤.</p>
<p>SD3.5 Largeì˜ ê²½ìš° ë‹¤ìŒê³¼ ê°™ìŠµë‹ˆë‹¤.</p>
<p>í‚¤ë¥¼ ë‚˜ì—´í•˜ë ¤ê³  í•˜ë©´ ìƒ¤ë”©ëœ ë””í“¨ì € í˜•ì‹ì˜ ê¸°ë³¸ ëª¨ë¸ì—ì„œ ì˜¤ë¥˜ê°€ ë°œìƒí•˜ë¯€ë¡œ ì´ë¥¼ ë‹¨ì¼ ëª¨ë¸ë¡œ ë³‘í•©í•˜ëŠ” ì½”ë“œì…ë‹ˆë‹¤. ì´ ì‹œì ì—ì„œ ë‚˜ëŠ” ëª¨ë¸ì˜ ë¡œì»¬ ë²„ì „ìœ¼ë¡œ ì‘ì—…í•˜ê³  ìˆì—ˆì§€ë§Œ <code>.cache</code>ì— ë‹¤ìš´ë¡œë“œí•œ Hugging Face ë²„ì „ê³¼ ë™ì¼í•©ë‹ˆë‹¤.</p>
<p>Example path:</p>
<figure class="highlight markdown"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">/home-kasukanra/.cache/huggingface/hub/models--stabilityai--stable-diffusion-3.5-large/snapshots/1a43aa3b9bb52ead637f9693a228092aa802a5dd/transformer</span><br></pre></td></tr></table></figure>

<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line">import safetensors.torch</span><br><span class="line"></span><br><span class="line">shards = [</span><br><span class="line">    &quot;/weka2/home-yeo/sd3_diffusers/ckpts/35L_1024_rc6b/test_convert/transformer/diffusion_pytorch_model-00001-of-00002.safetensors&quot;,</span><br><span class="line">    &quot;/weka2/home-yeo/sd3_diffusers/ckpts/35L_1024_rc6b/test_convert/transformer/diffusion_pytorch_model-00002-of-00002.safetensors&quot;</span><br><span class="line">]</span><br><span class="line"></span><br><span class="line"># Initialize an empty state dictionary</span><br><span class="line">combined_state_dict = &#123;&#125;</span><br><span class="line"></span><br><span class="line"># Load each shard and merge into combined_state_dict</span><br><span class="line">for shard in shards:</span><br><span class="line">    ckpt = safetensors.torch.load_file(shard)</span><br><span class="line">    combined_state_dict.update(ckpt)</span><br><span class="line"></span><br><span class="line"># Specify the output path for the combined model</span><br><span class="line">output_path = &quot;/weka2/home-yeo/sd3_diffusers/ckpts/35L_1024_rc6b/merged/combined_model.safetensors&quot;</span><br><span class="line"></span><br><span class="line"># Save the combined state dictionary to a single .safetensors file</span><br><span class="line">safetensors.torch.save_file(combined_state_dict, output_path)</span><br><span class="line">print(f&quot;Combined model saved successfully at &#123;output_path&#125;&quot;)</span><br><span class="line"></span><br></pre></td></tr></table></figure>


<p>ì œ ê²½ìš°ì—ëŠ” ë³‘í•©ëœ ëª¨ë¸(<code>combined_model.safetensors</code>)ì´ ìˆìœ¼ë©´ ì´ ìŠ¤í¬ë¦½íŠ¸ë¥¼ ì‹¤í–‰í•˜ì—¬ ì•„í‚¤í…ì²˜ë¥¼ í…ìŠ¤íŠ¸ íŒŒì¼ì— ì €ì¥í•˜ì„¸ìš”. ìŠ¤í¬ë¦½íŠ¸ëŠ” ë³€í™˜ê¸° ëª¨ë¸ì˜ ì¼ë°˜ì ì¸ ìˆœì°¨ íë¦„ì„ ì¶œë ¥í•©ë‹ˆë‹¤.</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line">import safetensors.torch</span><br><span class="line">import re</span><br><span class="line">import json</span><br><span class="line">from collections import defaultdict</span><br><span class="line"></span><br><span class="line">def group_keys(keys):</span><br><span class="line">    groups = defaultdict(list)</span><br><span class="line">    for key in keys:</span><br><span class="line">        if &#x27;transformer_blocks&#x27; in key:</span><br><span class="line">            block_num = int(re.search(r&#x27;transformer_blocks\.(\d+)&#x27;, key).group(1))</span><br><span class="line">            groups[f&#x27;transformer_block_&#123;block_num&#125;&#x27;].append(key)</span><br><span class="line">        elif &#x27;embed&#x27; in key:</span><br><span class="line">            groups[&#x27;embedding&#x27;].append(key)</span><br><span class="line">        elif &#x27;pos_embed&#x27; in key:</span><br><span class="line">            groups[&#x27;positional_embedding&#x27;].append(key)</span><br><span class="line">        elif &#x27;time_text_embed&#x27; in key:</span><br><span class="line">            groups[&#x27;time_text_embedding&#x27;].append(key)</span><br><span class="line">        elif &#x27;norm_out&#x27; in key:</span><br><span class="line">            groups[&#x27;output_normalization&#x27;].append(key)</span><br><span class="line">        elif &#x27;proj_out&#x27; in key:</span><br><span class="line">            groups[&#x27;output_projection&#x27;].append(key)</span><br><span class="line">        else:</span><br><span class="line">            groups[&#x27;other&#x27;].append(key)</span><br><span class="line">    return groups</span><br><span class="line"></span><br><span class="line">def order_groups(groups):</span><br><span class="line">    order = [</span><br><span class="line">        &#x27;embedding&#x27;,</span><br><span class="line">        &#x27;positional_embedding&#x27;,</span><br><span class="line">        &#x27;time_text_embedding&#x27;,</span><br><span class="line">    ] + [f&#x27;transformer_block_&#123;i&#125;&#x27; for i in range(38)] + [</span><br><span class="line">        &#x27;output_normalization&#x27;,</span><br><span class="line">        &#x27;output_projection&#x27;,</span><br><span class="line">        &#x27;other&#x27;</span><br><span class="line">    ]</span><br><span class="line">    return &#123;k: groups[k] for k in order if k in groups&#125;</span><br><span class="line"></span><br><span class="line">def pretty_print_and_save(ckpt, output_file):</span><br><span class="line">    keys_list = list(ckpt.keys())</span><br><span class="line">    grouped_keys = group_keys(keys_list)</span><br><span class="line">    ordered_groups = order_groups(grouped_keys)</span><br><span class="line">    </span><br><span class="line">    output = []</span><br><span class="line">    for group, keys in ordered_groups.items():</span><br><span class="line">        output.append(f&quot;\n&#123;group.upper()&#125;:&quot;)</span><br><span class="line">        output.extend(sorted(keys))</span><br><span class="line">    </span><br><span class="line">    pretty_output = &#x27;\n&#x27;.join(output)</span><br><span class="line">    </span><br><span class="line">    with open(output_file, &#x27;w&#x27;) as f:</span><br><span class="line">        f.write(pretty_output)</span><br><span class="line">    </span><br><span class="line">    print(f&quot;Grouped keys have been saved to &#123;output_file&#125;&quot;)</span><br><span class="line"></span><br><span class="line"># Load the checkpoint</span><br><span class="line">checkpoint_path = &quot;/weka2/home-yeo/sd3_diffusers/ckpts/35L_1024_rc6b/merged/combined_model.safetensors&quot;</span><br><span class="line">ckpt = safetensors.torch.load_file(checkpoint_path)</span><br><span class="line"></span><br><span class="line"># Pretty-print and save the grouped keys to a file</span><br><span class="line">output_file = &quot;ckpt_keys_grouped_output.txt&quot;</span><br><span class="line">pretty_print_and_save(ckpt, output_file)</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<h1 id="ì°¸ì¡°"><a href="#ì°¸ì¡°" class="headerlink" title="ì°¸ì¡°"></a>ì°¸ì¡°</h1><hr>
<ul>
<li><a target="_blank" rel="external nofollow noopener noreferrer" href="https://stabilityai.notion.site/Stable-Diffusion-3-5-Large-Fine-tuning-Tutorial-11a61cdcd1968027a15bdbd7c40be8c6">Stable Diffusion 3.5 Large Fine-tuning Tutorial</a></li>
</ul>
</div></article><div class="post-meta__tag-list"><a class="post-meta__tags" href="../../../tags/stable-diffusion/">stable diffusion</a><a class="post-meta__tags" href="../../../tags/LORA/">LORA</a><a class="post-meta__tags" href="../../../tags/Lora/">Lora</a><a class="post-meta__tags" href="../../../tags/%ED%9B%88%EB%A0%A8/">í›ˆë ¨</a><a class="post-meta__tags" href="../../../tags/%ED%95%99%EC%8A%B5/">í•™ìŠµ</a><a class="post-meta__tags" href="../../../tags/SD-3-5/">SD 3.5</a><a class="post-meta__tags" href="../../../tags/Large/">Large</a><a class="post-meta__tags" href="../../../tags/Fine-tuning/">Fine-tuning</a><a class="post-meta__tags" href="../../../tags/Tutorial/">Tutorial</a></div><nav id="pagination"><div class="prev-post pull-left"><a href="../../11/2024-11-01-python_poetry/"><i class="fa fa-chevron-left">  </i><span>Poetry: debugging</span></a></div><div class="next-post pull-right"><a href="../2024-10-18-Effective_Python_CHAPTER_2/"><span>CHAPTER 2 ë¦¬ìŠ¤íŠ¸ì™€ ë”•ì…”ë„ˆë¦¬</span><i class="fa fa-chevron-right"></i></a></div></nav><div id="disqus_thread"></div><script>var unused = null;
var disqus_config = function () {
  this.page.url = 'https://sejoung.github.io/2024/10/2024-10-25-Stable%20Diffusion_3_5_Large_Fine-tuning_Tutorial/';
  this.page.identifier = '2024/10/2024-10-25-Stable Diffusion_3_5_Large_Fine-tuning_Tutorial/';
  this.page.title = 'Stable Diffusion 3.5 Large Fine-tuning Tutorial';
}
var d = document, s = d.createElement('script');
s.src = "https://" + 'kimsejoung' +".disqus.com/embed.js";
s.setAttribute('data-timestamp', '' + +new Date());
(d.head || d.body).appendChild(s);</script><script id="dsq-count-scr" src="https://kimsejoung.disqus.com/count.js" async></script></div></div><footer class="footer-bg" style="background-image: url(https://upload.wikimedia.org/wikipedia/commons/thumb/0/09/Van_Gogh_-_Terrasse_des_Caf%C3%A9s_an_der_Place_du_Forum_in_Arles_am_Abend1.jpeg/1024px-Van_Gogh_-_Terrasse_des_Caf%C3%A9s_an_der_Place_du_Forum_in_Arles_am_Abend1.jpeg)"><div class="layout" id="footer"><div class="copyright">&copy;2017 - 2026 By sejoung kim</div><div class="footer-links"><a href="/privacy">Privacy</a><span class="footer-separator">|</span><a href="/terms">Terms</a><span class="footer-separator">|</span><a href="/contact">Contact</a></div><div class="framework-info"><span>Driven - </span><a target="_blank" rel="external nofollow noopener noreferrer" href="http://hexo.io"><span>Hexo</span></a><span class="footer-separator">|</span><span>Theme - </span><a target="_blank" rel="external nofollow noopener noreferrer" href="https://github.com/Molunerfinn/hexo-theme-melody"><span>Melody</span></a></div><div class="busuanzi"><script async src="//busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js"></script><span id="busuanzi_container_page_pv"><i class="fa fa-file-o"></i><span id="busuanzi_value_page_pv"></span><span></span></span></div></div></footer><i class="fa fa-arrow-up" id="go-up" aria-hidden="true"></i><script src="../../../js/third-party/anime.min.js"></script><script src="../../../js/third-party/jquery.min.js"></script><script src="../../../js/third-party/jquery.fancybox.min.js"></script><script src="../../../js/third-party/velocity.min.js"></script><script src="../../../js/third-party/velocity.ui.min.js"></script><script src="../../../js/utils.js?version=1.7.0"></script><script src="../../../js/fancybox.js?version=1.7.0"></script><script src="../../../js/sidebar.js?version=1.7.0"></script><script src="../../../js/copy.js?version=1.7.0"></script><script src="../../../js/fireworks.js?version=1.7.0"></script><script src="../../../js/transition.js?version=1.7.0"></script><script src="../../../js/scroll.js?version=1.7.0"></script><script src="../../../js/head.js?version=1.7.0"></script><script src="../../../js/search/local-search.js"></script><script>if(/Android|webOS|iPhone|iPod|iPad|BlackBerry/i.test(navigator.userAgent)) {
  $('#nav').addClass('is-mobile')
  $('footer').addClass('is-mobile')
  $('#top-container').addClass('is-mobile')
}</script><div class="search-dialog" id="local-search"><div class="search-dialog__title" id="local-search-title">Local search</div><div id="local-input-panel"><div id="local-search-input"><div class="local-search-box"><input class="local-search-box--input" placeholder="Search for Posts"></div></div></div><hr><div id="local-search-results"><div id="local-hits"></div><div id="local-stats"><div class="local-search-stats__hr" id="hr"><span>Powered by</span> <a target="_blank" rel="external nofollow noopener noreferrer" href="https://github.com/wzpan/hexo-generator-search" style="color:#49B1F5;">hexo-generator-search</a></div></div></div><span class="search-close-button"><i class="fa fa-times"></i></span></div><div class="search-mask"></div></body></html>