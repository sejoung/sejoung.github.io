<!DOCTYPE html><html lang="lang"><head><meta charset="UTF-8"><meta http-equiv="X-UA-Compatible" content="IE=edge"><meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1"><meta name="description" content="스프링을 활용한 쿼리와 명령간에 데이터 동기화"><meta name="keywords" content="spring,cqrs"><meta name="author" content="sejoung"><meta name="copyright" content="sejoung"><title>스프링을 활용한 쿼리와 명령간에 데이터 동기화 | 폭간의 기술블로그</title><link rel="shortcut icon" href="../../../my-favicon.ico"><link rel="stylesheet" href="../../../css/index.css?version=1.7.0"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/font-awesome@4.7.0/css/font-awesome.min.css?version=1.7.0"><meta name="format-detection" content="telephone=no"><meta http-equiv="x-dns-prefetch-control" content="on"><link rel="dns-prefetch" href="https://cdn.jsdelivr.net"><script async src="https://www.googletagmanager.com/gtag/js?id=G-NVRTGLD8RZ"></script><script>window.dataLayer = window.dataLayer || [];
function gtag(){dataLayer.push(arguments);}
gtag('js', new Date());
gtag('config', 'G-NVRTGLD8RZ');</script><script>var GLOBAL_CONFIG = { 
  root: '/',
  algolia: undefined,
  localSearch: {"path":"search.xml","languages":{"hits_empty":"We didn't find any results for the search: ${query}"}},
  copy: {
    success: 'Copy successfully',
    error: 'Copy error',
    noSupport: 'The browser does not support'
  }
} </script><meta name="generator" content="Hexo 5.4.2"></head><body><i class="fa fa-arrow-right" id="toggle-sidebar" aria-hidden="true"></i><div id="sidebar" data-display="true"><div class="toggle-sidebar-info text-center"><span data-toggle="Toggle article">Toggle site</span><hr></div><div class="sidebar-toc"><div class="sidebar-toc__title">Catalog</div><div class="sidebar-toc__progress"><span class="progress-notice">You've read</span><span class="progress-num">0</span><span class="progress-percentage">%</span><div class="sidebar-toc__progress-bar"></div></div><div class="sidebar-toc__content"><ol class="toc"><li class="toc-item toc-level-2"><a class="toc-link" href="#%EC%8A%A4%ED%94%84%EB%A7%81%EC%9D%84-%ED%99%9C%EC%9A%A9%ED%95%9C-%EC%BF%BC%EB%A6%AC%EC%99%80-%EB%AA%85%EB%A0%B9%EA%B0%84%EC%97%90-%EB%8D%B0%EC%9D%B4%ED%84%B0-%EB%8F%99%EA%B8%B0%ED%99%94"><span class="toc-number">1.</span> <span class="toc-text">스프링을 활용한 쿼리와 명령간에 데이터 동기화</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%EB%AA%85%EC%8B%9C%EC%A0%81-%EB%8F%99%EA%B8%B0%ED%99%94"><span class="toc-number">1.1.</span> <span class="toc-text">명시적 동기화</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%EC%8A%A4%ED%94%84%EB%A7%81-%EC%95%A0%ED%94%8C%EB%A6%AC%EC%BC%80%EC%9D%B4%EC%85%98-%EC%9D%B4%EB%B2%A4%ED%8A%B8%EC%99%80%EC%9D%98-%EC%95%94%EC%8B%9C-%EC%A0%81-%EB%8F%99%EA%B8%B0%ED%99%94"><span class="toc-number">1.2.</span> <span class="toc-text">스프링 애플리케이션 이벤트와의 암시 적 동기화</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%EB%8D%B0%EC%9D%B4%ED%84%B0%EB%B2%A0%EC%9D%B4%EC%8A%A4-%ED%8A%B8%EB%A6%AC%EA%B1%B0"><span class="toc-number">1.3.</span> <span class="toc-text">데이터베이스 트리거</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%ED%8A%B8%EB%9E%9C%EC%9E%AD%EC%85%98-%EB%A1%9C%EA%B7%B8-%ED%85%8C%EC%9D%BC%EB%A7%81"><span class="toc-number">1.4.</span> <span class="toc-text">트랜잭션 로그 테일링</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%EB%8F%84%EB%A9%94%EC%9D%B8-%EC%9D%B4%EB%B2%A4%ED%8A%B8-%EC%86%8C%EA%B0%9C"><span class="toc-number">1.5.</span> <span class="toc-text">도메인 이벤트 소개</span></a></li></ol></li></ol><li class="toc-item toc-level-1"><a class="toc-link" href="#%EC%B0%B8%EC%A1%B0"><span class="toc-number"></span> <span class="toc-text">참조</span></a></li></div></div><div class="author-info hide"><div class="author-info__avatar text-center"><img src="https://avatars0.githubusercontent.com/u/4936005?s=400&amp;u=a679b941fe377418e7e4efcf916c6a636d7178ee&amp;v=4"></div><div class="author-info__name text-center">sejoung</div><div class="author-info__description text-center">잘정리하자</div><div class="follow-button"><a target="_blank" rel="external nofollow noopener noreferrer" href="https://github.com/sejoung">Follow Me</a></div><hr><div class="author-info-articles"><a class="author-info-articles__archives article-meta" href="../../../archives"><span class="pull-left">Articles</span><span class="pull-right">761</span></a><a class="author-info-articles__tags article-meta" href="../../../tags"><span class="pull-left">Tags</span><span class="pull-right">804</span></a><a class="author-info-articles__categories article-meta" href="../../../categories"><span class="pull-left">Categories</span><span class="pull-right">75</span></a></div><hr><div class="author-info-links"><div class="author-info-links__title text-center">Links</div><a class="author-info-links__name text-center" target="_blank" rel="external nofollow noopener noreferrer" href="https://blog.naver.com/sanaes">naverblog</a><a class="author-info-links__name text-center" target="_blank" rel="external nofollow noopener noreferrer" href="https://www.linkedin.com/in/sanaes/">linkedin</a><a class="author-info-links__name text-center" target="_blank" rel="external nofollow noopener noreferrer" href="https://www.slideshare.net/sejoung">slideshare</a></div></div></div><div id="content-outer"><div id="top-container" style="background-image: url(https://upload.wikimedia.org/wikipedia/commons/thumb/0/09/Van_Gogh_-_Terrasse_des_Caf%C3%A9s_an_der_Place_du_Forum_in_Arles_am_Abend1.jpeg/1024px-Van_Gogh_-_Terrasse_des_Caf%C3%A9s_an_der_Place_du_Forum_in_Arles_am_Abend1.jpeg)"><div id="page-header"><span class="pull-left"> <a id="site-name" href="../../../index.html">폭간의 기술블로그</a></span><i class="fa fa-bars toggle-menu pull-right" aria-hidden="true"></i><span class="pull-right menus">   <a class="site-page" href="/">Home</a><a class="site-page" href="/archives">Archives</a><a class="site-page" href="/tags">Tags</a><a class="site-page" href="/categories">Categories</a></span><span class="pull-right"><a class="site-page social-icon search"><i class="fa fa-search"></i><span> Search</span></a></span></div><div id="post-info"><div id="post-title">스프링을 활용한 쿼리와 명령간에 데이터 동기화</div><div id="post-meta"><time class="post-meta__date"><i class="fa fa-calendar" aria-hidden="true"></i> 2020-04-28</time><span class="post-meta__separator">|</span><i class="fa fa-inbox post-meta__icon" aria-hidden="true"></i><a class="post-meta__categories" href="../../../categories/java/">java</a><span class="post-meta__separator">|</span><i class="fa fa-comment-o post-meta__icon" aria-hidden="true"></i><a href="#disqus_thread"><span class="disqus-comment-count" data-disqus-identifier="2020/04/2020-04-28-Spring_and_Data_Synchronization_Between_Queries_and_Commands/"></span></a></div></div></div><div class="layout" id="content-inner"><article id="post"><div class="article-container" id="post-content"><h2 id="스프링을-활용한-쿼리와-명령간에-데이터-동기화"><a href="#스프링을-활용한-쿼리와-명령간에-데이터-동기화" class="headerlink" title="스프링을 활용한 쿼리와 명령간에 데이터 동기화"></a>스프링을 활용한 쿼리와 명령간에 데이터 동기화</h2><ul>
<li>CQRS 란 무엇입니까?</li>
</ul>
<p>이 패턴은 시스템을 서로 다른 두 부분으로 나눕니다.<br>CQRS는 쓰기 (실행 명령)에 사용되는 구성 요소와 조회 구성 요소를 분리합니다.<br>따라서 명령 서비스 와 쿼리 서비스 는 분리되어 있으며 별도로 운영 할 수 있습니다.</p>
<p>CQS로 시작합시다 (나중에 R을 추가하겠습니다)</p>
<p>CQRS를 이해하기위한 여정에서 유명한 Command-Query Separation 인 CQS부터 시작하겠습니다. (이 접근 방식에서 “R”이없는 것은 의도적 인 것입니다.)</p>
<p>CQS (패턴은 객체의 메소드가 다음과 같이 그룹화되어야한다고 말합니다.)</p>
<ul>
<li>명령 : 시스템 상태를 변경할 수 있으며 값을 반환하지 않습니다.</li>
<li>쿼리 : 시스템 상태를 변경할수없고 (부작용이 없음) 값을 반환 할수 있다.</li>
</ul>
<p>이 명확한 분리는 개발자에게 유용합니다. 이유는 다음과 같습니다. 쿼리와 명령은 근본적으로 다른 작업입니다.<br>확장 성 특성이 다르기 때문에 분리하는 데 유용합니다. 쿼리를 반복 할 수 있습니다.<br>쿼리는 안전하고 여러번 하더라도 결과는 달라지지 않습니다.<br>일관성에 대한 걱정없이 다른 순서의 쿼리를 처리 할 수​있습니다. </p>
<p>반대로, 명령은 반복해서 안전하지 않습니다. 명령의 순서가 중요합니다.</p>
<p>이러한 원칙을 염두에두고 샘플 앱을 구축하면 이해도를 높일 수 있습니다.<br>CQS 팁에 따라 신용 카드 개체를 작성해 봅시다. </p>
<p>다음과 같은 요구 사항을 스스로 살펴 보겠습니다.</p>
<ul>
<li>사용자는 신용 카드에 연결된 계정에 충분한 돈이 있으면 주어진 금액을 인출(Withdraw) 할 수 있습니다. 이것을 Withdraw 이라고합니다</li>
<li>사용자는 신용 카드에 연결된 계정에서 모든 출금 목록을 볼 수 있습니다. 우리는 이것을 Show Me Withdrawals 라고 부릅니다.</li>
</ul>
<p>Withdraw 명령 이나 Show Me Withdrawals 쿼리 두 가지 기본 사용 사례 입니다.</p>
<p>또한 출금 요청은 모든 이전 출금 명령 의 세부 사항을 리턴해야 합니다.<br>이러한 명령과 쿼리는 모두 동일한 데이터 저장소를 사용할 때 간단합니다.</p>
<p>명령 및 쿼리 소스를 일관성있게 만드는 메커니즘이 있다면 별도의 데이터 저장소를 사용할 수 있습니다.<br>이러한 개념을 설명하기 위해 튜토리얼의 재미있는 그림에 색상 코드를 사용하십시오.</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line"><span class="keyword">package</span> io.dddbyexamples.cqrs.model;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> lombok.Getter;</span><br><span class="line"><span class="keyword">import</span> lombok.NoArgsConstructor;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> javax.persistence.*;</span><br><span class="line"><span class="keyword">import</span> java.math.BigDecimal;</span><br><span class="line"><span class="keyword">import</span> java.util.ArrayList;</span><br><span class="line"><span class="keyword">import</span> java.util.Collections;</span><br><span class="line"><span class="keyword">import</span> java.util.List;</span><br><span class="line"><span class="keyword">import</span> java.util.UUID;</span><br><span class="line"></span><br><span class="line"><span class="meta">@Entity</span></span><br><span class="line"><span class="meta">@NoArgsConstructor</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">CreditCard</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Id</span> <span class="meta">@GeneratedValue</span> <span class="meta">@Getter</span></span><br><span class="line">    <span class="keyword">private</span> UUID id;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> BigDecimal initialLimit;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="type">BigDecimal</span> <span class="variable">usedLimit</span> <span class="operator">=</span> BigDecimal.ZERO;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@OneToMany(cascade = CascadeType.ALL)</span></span><br><span class="line">    <span class="meta">@JoinColumn(name = &quot;cardId&quot;)</span></span><br><span class="line">    <span class="keyword">private</span> List&lt;Withdrawal&gt; withdrawals = <span class="keyword">new</span> <span class="title class_">ArrayList</span>&lt;&gt;();</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="title function_">CreditCard</span><span class="params">(BigDecimal limit)</span> &#123;</span><br><span class="line">        <span class="built_in">this</span>.initialLimit = limit;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">withdraw</span><span class="params">(BigDecimal amount)</span> &#123;</span><br><span class="line">        <span class="keyword">if</span> (thereIsMoneyToWithdraw(amount)) &#123;</span><br><span class="line">            usedLimit = usedLimit.add(amount);</span><br><span class="line">            withdrawals.add(<span class="keyword">new</span> <span class="title class_">Withdrawal</span>(amount, id));</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">NotEnoughMoneyException</span>(id, amount, availableBalance());</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> BigDecimal <span class="title function_">availableBalance</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> initialLimit.subtract(usedLimit);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="type">boolean</span> <span class="title function_">thereIsMoneyToWithdraw</span><span class="params">(BigDecimal amount)</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> availableBalance().compareTo(amount) &gt;= <span class="number">0</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> List&lt;Withdrawal&gt; <span class="title function_">getWithdrawals</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> Collections.unmodifiableList(withdrawals);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>이 기사의 주요 목표는 동기화를 설명하는 것입니다.<br>이러한 이유로 우리는 일을 단순하게 유지하고 금전적 가치를 BigDecimals로 나타냅니다.<br>실제로는 이 클래스가 나타내는 개념을 모델링하는 데 더 많은 시간을 할애 할 수 있습니다.</p>
<p>withdraw 명령 과 getWithdrawals 쿼리는 분리가 명확하다</p>
<p>신용카드 클래스는 새 명령 을 받은 후 비즈니스 불변량을 확인합니다.<br>쿼리는 즉시 모든 과거 출금을 반환합니다.<br>명령과 쿼리를 처리하는 하나의 모델이 있습니다.<br>신용 카드 클래스는 언급 된 동기화 메커니즘입니다.</p>
<p>쿼리와 명령이 분리되어 있지만 서로 연결되어 있습니다.<br>하나의 객체가 두 기능을 모두 처리하기 때문입니다.<br>이 방법이 문제입니까? 우리에게 가장 적합한 대답은 아닐 수도 있습니다.<br>이유를 자세히 살펴 보겠습니다.</p>
<ul>
<li><p>인출을 위해 객체 관계형 매퍼와 지연 로딩을 사용하면 문제가 발생할 수 있습니다.<br>일관성이없는 상태에서 객체를 만들 수 있습니다.<br>초기 상태를로드하고 (사용 된 제한으로) 동시 스레드에 의해 새 인출을 작성하고 새 인출을 사용하여 지연 콜렉션을 로드한다고 가정하십시오.<br>물론 이에 대한 해결책이 있습니다.<br>예를 들어, withdrawals 값을 세어 로드하거나 사용 한도를 계산할 수 있습니다.</p>
</li>
<li><p>withdrawals 명령은 현재 인출의 목록에 새 withdrawals 를 추가합니다.<br>이 작업은 명령을 수락하거나 거부 할 필요가 없습니다.<br>그러나 앞으로 정확한 쿼리를 수행해야합니다.</p>
</li>
<li><p>새 출금을 추가하려면 출금 목록에 액세스해야합니다.<br>게으른 로딩은 어떻습니까? Object-Relational Mapper가 데이터베이스에서 전체 컬렉션을 가져 와서 단순히 새로운 인출을 추가합니까?<br>그들 중 일부는이 작업을 간단한 삽입으로 취급합니다.<br>그러나 일부는 그렇지 않습니다.<br>애플리케이션 메모리에 많은 수의 불필요한 인출을 로드 할 위험이 있습니다.</p>
</li>
</ul>
<p>대부분의 시스템은 쓰기보다 훨씬 더 많은 읽기를 가지고 있습니다.<br>즉, 시스템이 다른 모델과 다른 데이터 구조의 이점을 누릴 수 있습니다.<br>다시 말해, 이러한 비 기능적 요구 사항은 다른 설계 결정으로 이어질 수 있습니다.</p>
<p>이 두 가지 진실을 기억하십시오 :</p>
<ul>
<li>읽기는 반복해도 안전하지만 명령은 안전하지 않습니다.</li>
<li>읽기는 캐시 가능하지만 명령은 캐시 할 수 없습니다.</li>
</ul>
<p>서로 다른 객체로 해당 사용 사례를 처리하고 싶다고 가정 해 봅시다.<br>별도의 스토리지에 대해서는 아무 것도 말하지 않습니다.<br>적어도 아직은 아닙니다.</p>
<p>기존 코드와 데이터로 상황에 직면 할 수도 있습니다.<br>새로운 코드를 제공하기 위해 동기화 해야합니다.<br>다음 섹션에서 사용할 일부 동기화 기술이 도움이 될 수 있습니다.</p>
<p>이제 사용 사례를 분리합시다</p>
<p>신용 카드를 별도의 개체로 나누는 한 가지 방법 :</p>
<ul>
<li>출발 클래스에서 인출 컬렉션을 제거합시다 .</li>
<li>그리고 고객의 출금 목록을 나타내는 새로운 개념을 소개합니다. 인출은 좋은 선택 인 것 같습니다.</li>
</ul>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line"><span class="keyword">package</span> io.dddbyexamples.cqrs.model;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> lombok.Getter;</span><br><span class="line"><span class="keyword">import</span> lombok.NoArgsConstructor;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> javax.persistence.Entity;</span><br><span class="line"><span class="keyword">import</span> javax.persistence.GeneratedValue;</span><br><span class="line"><span class="keyword">import</span> javax.persistence.Id;</span><br><span class="line"><span class="keyword">import</span> java.math.BigDecimal;</span><br><span class="line"><span class="keyword">import</span> java.util.UUID;</span><br><span class="line"></span><br><span class="line"><span class="meta">@Entity</span></span><br><span class="line"><span class="meta">@NoArgsConstructor</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">CreditCard</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Id</span> <span class="meta">@GeneratedValue</span> <span class="meta">@Getter</span> <span class="keyword">private</span> UUID id;</span><br><span class="line">    <span class="keyword">private</span> BigDecimal initialLimit;</span><br><span class="line">    <span class="keyword">private</span> <span class="type">BigDecimal</span> <span class="variable">usedLimit</span> <span class="operator">=</span> BigDecimal.ZERO;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="title function_">CreditCard</span><span class="params">(BigDecimal limit)</span> &#123;</span><br><span class="line">        <span class="built_in">this</span>.initialLimit = limit;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">withdraw</span><span class="params">(BigDecimal amount)</span> &#123;</span><br><span class="line">        <span class="keyword">if</span> (thereIsMoneyToWithdraw(amount)) &#123;</span><br><span class="line">            usedLimit = usedLimit.add(amount);</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">NotEnoughMoneyException</span>(id, amount, availableBalance());</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> BigDecimal <span class="title function_">availableBalance</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> initialLimit.subtract(usedLimit);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="type">boolean</span> <span class="title function_">thereIsMoneyToWithdraw</span><span class="params">(BigDecimal amount)</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> availableBalance().compareTo(amount) &gt;= <span class="number">0</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>WithdrawalsFinder 내에서 데이터베이스에 대한 직접 쿼리를 사용하거나 읽기 전용 트랜잭션을 사용할 수 있습니다.<br>그러나 중요한 것은 더러운 점검 페널티를 피한다는 것입니다.<br>이것이 무엇이며 왜 피하고 싶습니까? 더티 검사는 객체 관계 맵퍼에 내장 된 메커니즘으로 객체의 변화를 감지합니다.<br>물론 쿼리는 상태를 변경하지 않으므로 더티 검사는 쓸모가 없습니다.<br>Spring은 읽기 전용 트랜잭션을 사용할 때 사용하지 않도록 설정합니다.</p>
<p>쿼리 결과를 변경 불가능한 데이터 구조에 매핑하는 것으로 충분합니다</p>
<p>요약 : 엔터티 데이터의 일부를 읽기 용으로, 나머지는 쓰기 용으로 매핑하는 것에 대해 생각해 보셨을 것입니다.<br>두 개의 JPA 엔티티를 하나의 데이터베이스 테이블에 맵핑 할 수 있습니다. (다른 열을 매핑하여 수행 할 수 있습니다.)<br>그러나 이것이 필요합니까? 엔터티를 수정할 수 있습니다.<br>두 엔티티가 동일한 테이블에 맵핑되면 낙관적 잠금 예외가 자주 발생할 수 있습니다.<br>또한 쿼리를 제공하는 엔터티는 변경할 필요가 없습니다.<br>불변 투사는 자연스러운 솔루션입니다.</p>
<p>그러나 이제 종단 간 테스트가 실패합니다.<br>인출 명령이 성공 하면 조회 할 때 인출이 0으로 리턴됩니다.<br>왜? 명령과 쿼리를 동기화하는 데 사용 된 일부 코드를 제거했기 때문입니다.<br>목록 인출 의 크레딧 카드는 사라졌다.</p>
<p>게시물을 상기시켜 신용 카드와 출금 상태를 동기화하는 다른 방법을 살펴 보겠습니다. </p>
<h3 id="명시적-동기화"><a href="#명시적-동기화" class="headerlink" title="명시적 동기화"></a>명시적 동기화</h3><p>CreditCard 개체에서 응용 프로그램 계층으로 한 계층 위로 동기화를 이동할 수 있습니다.<br>결국 우리는 신용 카드를 더 단순하게 유지하려고합니다.<br>마찬가지로 쿼리 할 때 더티 검사를 피하고 싶습니다.<br>작동 방법은 다음과 같습니다.</p>
<p>인출 중에 신용 카드 한도를 업데이트합시다.<br>데이터베이스에 새로운 인출도 삽입 해 봅시다.<br>작업을 수행하는 간단한 응용 프로그램 서비스를 만들 수 있습니다.<br>이름은 WithdrawalProcess 입니다.<br>테스트를 다시 녹색으로 만듭니다.</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line"><span class="keyword">package</span> io.dddbyexamples.cqrs.application;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> io.dddbyexamples.cqrs.model.CreditCard;</span><br><span class="line"><span class="keyword">import</span> io.dddbyexamples.cqrs.model.Withdrawal;</span><br><span class="line"><span class="keyword">import</span> io.dddbyexamples.cqrs.persistence.CreditCardRepository;</span><br><span class="line"><span class="keyword">import</span> io.dddbyexamples.cqrs.persistence.WithdrawalRepository;</span><br><span class="line"><span class="keyword">import</span> org.springframework.stereotype.Service;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> javax.transaction.Transactional;</span><br><span class="line"><span class="keyword">import</span> java.math.BigDecimal;</span><br><span class="line"><span class="keyword">import</span> java.util.UUID;</span><br><span class="line"></span><br><span class="line"><span class="meta">@Service</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">WithdrawalProcess</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> CreditCardRepository creditCardRepository;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> WithdrawalRepository withdrawalRepository;</span><br><span class="line"></span><br><span class="line">    WithdrawalProcess(CreditCardRepository creditCardRepository, WithdrawalRepository withdrawalRepository) &#123;</span><br><span class="line">        <span class="built_in">this</span>.creditCardRepository = creditCardRepository;</span><br><span class="line">        <span class="built_in">this</span>.withdrawalRepository = withdrawalRepository;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Transactional</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">withdraw</span><span class="params">(UUID cardId, BigDecimal amount)</span> &#123;</span><br><span class="line">        <span class="type">CreditCard</span> <span class="variable">creditCard</span> <span class="operator">=</span> creditCardRepository.findById(cardId)</span><br><span class="line">                .orElseThrow(() -&gt; <span class="keyword">new</span> <span class="title class_">IllegalStateException</span>(<span class="string">&quot;Cannot find card with id &quot;</span> + cardId));</span><br><span class="line">        creditCard.withdraw(amount);</span><br><span class="line">        withdrawalRepository.save(<span class="keyword">new</span> <span class="title class_">Withdrawal</span>(amount, cardId));</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>명령과 쿼리는 연결되지 않습니다.<br>상태가 일관되도록 애플리케이션 서비스가 있습니다.<br>이전 예 에서와 같이 동기화가 즉시 이루어집니다.<br>변화는 원자 적입니다.<br>그리고 Google 시스템은 단일 거래에서 신용 카드 한도 수정 및 새로운 인출 삽입을 수행했습니다.</p>
<p>ORM에 의해 암시 적 동기화가 수행 되기 전에.<br>이제 응용 프로그램 계층에서 명시적인 동기화를 수행했습니다.<br>인출을 위해서만 별도의 데이터베이스를 사용하면 즉각적인 동기화가 불가능합니다.<br>우리는 CAP 정리를 이길 수 없으며 두 개의 다른 데이터베이스를 원자 적으로 변경할 수 없습니다.<br>그러나 이 방법은 원하는 비즈니스 성과를 제공합니다.</p>
<h3 id="스프링-애플리케이션-이벤트와의-암시-적-동기화"><a href="#스프링-애플리케이션-이벤트와의-암시-적-동기화" class="headerlink" title="스프링 애플리케이션 이벤트와의 암시 적 동기화"></a>스프링 애플리케이션 이벤트와의 암시 적 동기화</h3><p>일부 사람들은 위의 응용 프로그램 서비스에서 수행 한 수동 작업과 명시 적 작업을 좋아하지 않을 수 있습니다.<br>새로운 인출을 삽입하는 다른 방법이있을 수 있습니까?<br>예, 있습니다! 통제권을 뒤집기 위해 신용 카드 클래스는 이벤트 게시로 끝날 수 있습니다.<br>이 이벤트는 응용 프로그램의 다른 부분에서 처리 될 수 있습니다.<br>이벤트를 공개하고 청취하기 위해 스프링 애플리케이션 이벤트를 사용할 수 있습니다.</p>
<p>WithdrawalProcess에 이벤트를 게시하는 방법은 다음과 같습니다 .</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line"><span class="keyword">package</span> io.dddbyexamples.cqrs.application;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> io.dddbyexamples.cqrs.model.CardWithdrawn;</span><br><span class="line"><span class="keyword">import</span> io.dddbyexamples.cqrs.model.CreditCard;</span><br><span class="line"><span class="keyword">import</span> io.dddbyexamples.cqrs.persistence.CreditCardRepository;</span><br><span class="line"><span class="keyword">import</span> org.springframework.context.ApplicationEventPublisher;</span><br><span class="line"><span class="keyword">import</span> org.springframework.stereotype.Service;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> javax.transaction.Transactional;</span><br><span class="line"><span class="keyword">import</span> java.math.BigDecimal;</span><br><span class="line"><span class="keyword">import</span> java.util.UUID;</span><br><span class="line"></span><br><span class="line"><span class="meta">@Service</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">WithdrawalProcess</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> CreditCardRepository creditCardRepository;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> ApplicationEventPublisher applicationEventPublisher;</span><br><span class="line"></span><br><span class="line">    WithdrawalProcess(CreditCardRepository creditCardRepository, ApplicationEventPublisher applicationEventPublisher) &#123;</span><br><span class="line">        <span class="built_in">this</span>.creditCardRepository = creditCardRepository;</span><br><span class="line">        <span class="built_in">this</span>.applicationEventPublisher = applicationEventPublisher;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Transactional</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">withdraw</span><span class="params">(UUID cardId, BigDecimal amount)</span> &#123;</span><br><span class="line">        <span class="type">CreditCard</span> <span class="variable">creditCard</span> <span class="operator">=</span> creditCardRepository.findById(cardId)</span><br><span class="line">                .orElseThrow(() -&gt; <span class="keyword">new</span> <span class="title class_">IllegalStateException</span>(<span class="string">&quot;Cannot find card with id &quot;</span> + cardId));</span><br><span class="line">        <span class="type">CardWithdrawn</span> <span class="variable">event</span> <span class="operator">=</span> creditCard.withdraw(amount);</span><br><span class="line">        applicationEventPublisher.publishEvent(event);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>아래에서 이벤트를 캐치 할수 있습니다.</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line"><span class="keyword">package</span> io.dddbyexamples.cqrs.sink;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> io.dddbyexamples.cqrs.model.CardWithdrawn;</span><br><span class="line"><span class="keyword">import</span> org.springframework.context.event.EventListener;</span><br><span class="line"><span class="keyword">import</span> org.springframework.jdbc.core.JdbcTemplate;</span><br><span class="line"><span class="keyword">import</span> org.springframework.stereotype.Service;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> java.util.UUID;</span><br><span class="line"></span><br><span class="line"><span class="meta">@Service</span></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">ReadModelUpdater</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> JdbcTemplate jdbcTemplate;</span><br><span class="line"></span><br><span class="line">    ReadModelUpdater(JdbcTemplate jdbcTemplate) &#123;</span><br><span class="line">        <span class="built_in">this</span>.jdbcTemplate = jdbcTemplate;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@EventListener</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">addWithdrawalOnCardWithdrawn</span><span class="params">(CardWithdrawn event)</span> &#123;</span><br><span class="line">        jdbcTemplate.update(<span class="string">&quot;INSERT INTO WITHDRAWAL(ID, CARD_ID, AMOUNT) VALUES (?,?,?)&quot;</span>, UUID.randomUUID(), event.getCardNo(), event.getAmount());</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>보시다시피, 이전 예제와의 유일한 차이점은 동일한 작업을 구성 요소간에 나누는 방법입니다.<br>인출을 삽입하는 데 사용 된 애플리케이션 서비스는 이제 이를 이벤트로 공개하고 ReadModelUpdater는 인출을 삽입합니다.<br>개념적 흐름은 여전히 동일합니다.<br>우리는 신용 카드 및 인출 테이블을 업데이트합니다.<br>어플리케이션 이벤트는 컨트롤을 반전시키기 위해 존재합니다.<br>모든 것이 단일 트랜잭션으로 실행된다는 것을 기억하십시오.<br>새 인출을 삽입 할 때 실패하면 CreditCard의 변경 사항이 롤백됩니다.</p>
<p>수동 게시와 ApplicationEventPublisher에 대한 종속성을 피하려면 Spring이 모든 작업을 수행 할 수 있습니다. </p>
<p>응용 프로그램 수준에서 두 개의 이전 동기화가 작동했습니다.<br>그것은 그것을 명시 적으로 제어했습니다.<br>그러나 이를 수행하는 암시 적 방법도 있으며 데이터베이스 수준에서 작동합니다.<br>데이터베이스 트리거를 사용할 수 있습니다.</p>
<h3 id="데이터베이스-트리거"><a href="#데이터베이스-트리거" class="headerlink" title="데이터베이스 트리거"></a>데이터베이스 트리거</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> io.dddbyexamples.cqrs.persistence;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> org.h2.api.Trigger;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> java.math.BigDecimal;</span><br><span class="line"><span class="keyword">import</span> java.sql.Connection;</span><br><span class="line"><span class="keyword">import</span> java.sql.PreparedStatement;</span><br><span class="line"><span class="keyword">import</span> java.sql.SQLException;</span><br><span class="line"><span class="keyword">import</span> java.util.UUID;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">CreditCardUsedTrigger</span> <span class="keyword">implements</span> <span class="title class_">Trigger</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">init</span><span class="params">(Connection connection, String s, String s1, String s2, <span class="type">boolean</span> b, <span class="type">int</span> i)</span> <span class="keyword">throws</span> SQLException &#123;</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">fire</span><span class="params">(Connection connection, Object[] before, Object[] after)</span> <span class="keyword">throws</span> SQLException &#123;</span><br><span class="line">        <span class="keyword">try</span> (<span class="type">PreparedStatement</span> <span class="variable">stmt</span> <span class="operator">=</span> connection.prepareStatement(</span><br><span class="line">                <span class="string">&quot;INSERT INTO WITHDRAWAL (ID, CARD_ID, AMOUNT) &quot;</span> + <span class="string">&quot;VALUES (?, ?, ?)&quot;</span>)) &#123;</span><br><span class="line">            stmt.setObject(<span class="number">1</span>, UUID.randomUUID()); <span class="comment">//generate withdrawal id</span></span><br><span class="line">            stmt.setObject(<span class="number">2</span>, cardId(after));</span><br><span class="line">            stmt.setObject(<span class="number">3</span>, getUsedLimitChange(before, after));</span><br><span class="line"></span><br><span class="line">            stmt.executeUpdate();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> Object <span class="title function_">cardId</span><span class="params">(Object[] cardRow)</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> cardRow[<span class="number">0</span>];</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> BigDecimal <span class="title function_">getUsedLimitChange</span><span class="params">(Object[] oldCardRow, Object[] newCardRow)</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> ((BigDecimal) newCardRow[<span class="number">2</span>]).subtract((BigDecimal) oldCardRow[<span class="number">2</span>]);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">close</span><span class="params">()</span> <span class="keyword">throws</span> SQLException &#123;</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">remove</span><span class="params">()</span> <span class="keyword">throws</span> SQLException &#123;</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>
<p>동기화가 즉시 이루어집니다. 신용 카드 한도 변경 및 새로운 인출 추가는 여전히 트리거가 거래의 일부이기 때문에 원자 적 입니다.</p>
<p>이 솔루션에는 몇 가지 단점이 있습니다. 언급했듯이 데이터베이스 별 솔루션입니다.<br>이는 애플리케이션 논리가 애플리케이션에 유지되지 않음을 의미합니다.<br>또한 솔루션을 다른 데이터베이스로 이식 할 수 없습니다.</p>
<p>우리는 응용 프로그램 서비스와 트리거, 명령 및 쿼리를 분리한다고 언급했습니다.<br>글쎄, 이것은 완전히 사실이 아닙니다. 트리거가 실패하면 어떻게됩니까?<br>모든 것이 하나의 거래입니다. 철수 작업은 명령을 실행과 관련이없는 이유로 실패합니다.</p>
<p>신용 카드 클래스에서 상위 계층으로 도메인 계층을<br>애플리케이션 계층 (애플리케이션 이벤트와 함께 명시 적 또는 암시 적으로)으로 이동 한 다음<br>데이터베이스 계층으로 동기화를 이동해도 모든 문제가 해결되지는 않았습니다.<br>우리는 여전히 어느 정도 연결되어 있습니다.<br>어떤 사람들은 사건이 우리에게 분리를 제공한다고 말할 수 있습니다.<br>내가 동의하지 않는 이유는 다음과 같습니다.</p>
<p>이전 솔루션의 응용 프로그램 이벤트는 메모리에만 존재합니다.<br>모든 코드는 호출 하기 전에 및 애프터 이벤트의 게시는 하나의 데이터베이스 트랜잭션 내에서 처리됩니다.<br>따라서 동기화가 즉시 이루어집니다.<br>이것은 숨겨진 중요한 결점이 있습니다.<br>명령과 쿼리가 분리 된 것처럼 보일 수 있습니다.<br>실제로 하나의 트랜잭션은 강력한 암시 적 커플 링을 만듭니다.<br>코드를 검토하면 분명하지 않습니다.</p>
<h3 id="트랜잭션-로그-테일링"><a href="#트랜잭션-로그-테일링" class="headerlink" title="트랜잭션 로그 테일링"></a>트랜잭션 로그 테일링</h3><p>이제 다음 단계로 넘어갑니다. 그것은 약간 반 직관적 일 것입니다.<br>때로는 실제로 이런 방식으로 동기화하는 것이 유용 할 수 있습니다.<br>특히 초기 상태를 생성하는 응용 프로그램을 제어 할 수없는 경우.<br>예제로 돌아 갑시다. Withdraw 명령을 담당하는 스레드 가 완료 되면 동기화해야합니다 .<br>옵션 중 하나는 데이터베이스 트랜잭션 저널을 사용하고 신용 카드 한도를 업데이트하는 것입니다.<br>트랜잭션 저널 또는 트랜잭션 로그 실행 된 작업의 역사입니다.<br>이전에는 동일한 거래 및 스레드에서 신용 카드 한도 변경에 따라 트리거가 발생했습니다.<br>이제 응용 프로그램은 트랜잭션 로그를 스캔하고 이전 업데이트에 반응하고 신용 카드 한도를 업데이트 할 수 있습니다.<br>이 설정에서는 다음을 사용합니다.</p>
<ul>
<li>인출 및 신용 카드를 보관하는 MySQL;</li>
<li>Apache Kafka (데이터베이스 트랜잭션 로그 (이 경우 MySQL))에서 읽은 메시지에 대한 pub &#x2F; sub 용)</li>
<li>Kafka Debezium 과 연결 하여 MySQL의 트랜잭션 로그를 읽고 Kafka의 주제로 메시지를 스트리밍합니다.</li>
<li>Kafka의 주제에서 메시지를 읽는 Spring Cloud Stream .</li>
</ul>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line"><span class="keyword">package</span> io.dddbyexamples.cqrs.sink;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> io.dddbyexamples.cqrs.model.Withdrawal;</span><br><span class="line"><span class="keyword">import</span> io.dddbyexamples.cqrs.persistence.WithdrawalRepository;</span><br><span class="line"><span class="keyword">import</span> lombok.extern.slf4j.Slf4j;</span><br><span class="line"><span class="keyword">import</span> org.springframework.cloud.stream.annotation.StreamListener;</span><br><span class="line"><span class="keyword">import</span> org.springframework.cloud.stream.messaging.Sink;</span><br><span class="line"><span class="keyword">import</span> org.springframework.stereotype.Service;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> java.math.BigDecimal;</span><br><span class="line"></span><br><span class="line"><span class="meta">@Service</span></span><br><span class="line"><span class="meta">@Slf4j</span></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">ReadModelUpdater</span> &#123;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">private</span> <span class="keyword">final</span> WithdrawalRepository withdrawalRepository;</span><br><span class="line"></span><br><span class="line">	ReadModelUpdater(WithdrawalRepository withdrawalRepository) &#123;</span><br><span class="line">		<span class="built_in">this</span>.withdrawalRepository = withdrawalRepository;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="meta">@StreamListener(Sink.INPUT)</span></span><br><span class="line">	<span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">handle</span><span class="params">(Envelope message)</span> &#123;</span><br><span class="line">		<span class="keyword">if</span>(message.isUpdate()) &#123;</span><br><span class="line">			saveWithdrawalFrom(message);</span><br><span class="line">		&#125;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">private</span> <span class="keyword">void</span> <span class="title function_">saveWithdrawalFrom</span><span class="params">(Envelope message)</span> &#123;</span><br><span class="line">		<span class="type">String</span> <span class="variable">cardId</span> <span class="operator">=</span> message.getPayload().getBefore().getId();</span><br><span class="line">		<span class="type">BigDecimal</span> <span class="variable">withdrawalAmount</span></span><br><span class="line">				<span class="operator">=</span> balanceAfter(message).subtract(balanceBefore(message));</span><br><span class="line">		withdrawalRepository.save(<span class="keyword">new</span> <span class="title class_">Withdrawal</span>(withdrawalAmount, cardId));</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">private</span> BigDecimal <span class="title function_">balanceAfter</span><span class="params">(Envelope message)</span> &#123;</span><br><span class="line">		<span class="keyword">return</span> message.getPayload().getAfter().getUsed_limit();</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">private</span> BigDecimal <span class="title function_">balanceBefore</span><span class="params">(Envelope message)</span> &#123;</span><br><span class="line">		<span class="keyword">return</span> message.getPayload().getBefore().getUsed_limit();</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>이 시점에서 ReadModelUpdater 는 별도의 스토리지에 새로운 인출을 저장할 수 있습니다.<br>새로운 인출을 삽입하지 않아도 명령 측에는 영향을 미치지 않습니다.<br>그러나 이제는 더 이상 원자가 변경되지 않습니다.<br>Withdraw 명령 이 성공한 후 새로운 출금을 삽입하는 데 시간이 걸립니다.<br>솔루션은 결국 일관성이 있습니다.</p>
<p>Pub &#x2F; Sub를 사용하면 명령 모델에 영향을주지 않고 새로운 읽기 모델을 추가 할 수 있습니다.<br>그러나 메시징을 도입하는 데에는 벌칙이 따릅니다.<br>이제 메시지 순서와 중복에 대해 생각해야합니다.<br>트리거와 마찬가지로 트랜잭션 로그는 지정된 데이터베이스에 특정한 솔루션입니다.<br>또한 새로운 종속성 (Kafka, Kafka Connect, 트랜잭션 로그)으로 인해 테스트가 더 어려워졌습니다.<br>적어도 우리는 메시지 전달이 데이터베이스에서 새로운 Withdrawal를 초래하는지 테스트 할 수 있습니다.</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line"><span class="keyword">package</span> io.dddbyexamples.cqrs.sink;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> io.dddbyexamples.cqrs.model.CreditCard;</span><br><span class="line"><span class="keyword">import</span> io.dddbyexamples.cqrs.model.Withdrawal;</span><br><span class="line"><span class="keyword">import</span> io.dddbyexamples.cqrs.persistence.CreditCardRepository;</span><br><span class="line"><span class="keyword">import</span> org.junit.Test;</span><br><span class="line"><span class="keyword">import</span> org.junit.runner.RunWith;</span><br><span class="line"><span class="keyword">import</span> org.springframework.beans.factory.annotation.Autowired;</span><br><span class="line"><span class="keyword">import</span> org.springframework.boot.test.context.SpringBootTest;</span><br><span class="line"><span class="keyword">import</span> org.springframework.boot.test.web.client.TestRestTemplate;</span><br><span class="line"><span class="keyword">import</span> org.springframework.cloud.stream.messaging.Sink;</span><br><span class="line"><span class="keyword">import</span> org.springframework.core.ParameterizedTypeReference;</span><br><span class="line"><span class="keyword">import</span> org.springframework.messaging.support.GenericMessage;</span><br><span class="line"><span class="keyword">import</span> org.springframework.test.context.junit4.SpringRunner;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> java.math.BigDecimal;</span><br><span class="line"><span class="keyword">import</span> java.util.*;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> <span class="keyword">static</span> java.math.BigDecimal.TEN;</span><br><span class="line"><span class="keyword">import</span> <span class="keyword">static</span> java.math.BigDecimal.ZERO;</span><br><span class="line"><span class="keyword">import</span> <span class="keyword">static</span> org.assertj.core.api.Assertions.assertThat;</span><br><span class="line"><span class="keyword">import</span> <span class="keyword">static</span> org.springframework.boot.test.context.SpringBootTest.WebEnvironment.RANDOM_PORT;</span><br><span class="line"><span class="keyword">import</span> <span class="keyword">static</span> org.springframework.http.HttpMethod.GET;</span><br><span class="line"></span><br><span class="line"><span class="meta">@RunWith(SpringRunner.class)</span></span><br><span class="line"><span class="meta">@SpringBootTest(webEnvironment = RANDOM_PORT)</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">ReadModelUpdaterTest</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Autowired</span> TestRestTemplate restTemplate;</span><br><span class="line">    <span class="meta">@Autowired</span> CreditCardRepository creditCardRepository;</span><br><span class="line">    <span class="meta">@Autowired</span> Sink sink;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Test</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">shouldSynchronizeQuerySideAfterLogTailing</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="comment">// given</span></span><br><span class="line">        <span class="type">String</span> <span class="variable">cardUUid</span> <span class="operator">=</span> thereIsCreditCardWithLimit(<span class="keyword">new</span> <span class="title class_">BigDecimal</span>(<span class="number">100</span>));</span><br><span class="line">        <span class="comment">// when</span></span><br><span class="line">        creditCardUpdateReadFromDbTransactionLog(TEN, cardUUid);</span><br><span class="line">        <span class="comment">// then</span></span><br><span class="line">        thereIsOneWithdrawalOf(TEN, cardUUid);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    String <span class="title function_">thereIsCreditCardWithLimit</span><span class="params">(BigDecimal limit)</span> &#123;</span><br><span class="line">        <span class="type">CreditCard</span> <span class="variable">creditCard</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">CreditCard</span>(limit);</span><br><span class="line">        <span class="keyword">return</span> creditCardRepository.save(creditCard).getId();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">void</span> <span class="title function_">creditCardUpdateReadFromDbTransactionLog</span><span class="params">(BigDecimal usedLimitAfter, String cardUUid)</span> &#123;</span><br><span class="line">        <span class="type">Card</span> <span class="variable">before</span> <span class="operator">=</span> createCardDbRepresentation(cardUUid, ZERO);</span><br><span class="line">        <span class="type">Card</span> <span class="variable">after</span> <span class="operator">=</span> createCardDbRepresentation(cardUUid, usedLimitAfter);</span><br><span class="line">        <span class="type">CreditCardStateChanged</span> <span class="variable">message</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">CreditCardStateChanged</span>();</span><br><span class="line">        message.setOp(<span class="string">&quot;u&quot;</span>);</span><br><span class="line">        message.setBefore(before);</span><br><span class="line">        message.setAfter(after);</span><br><span class="line">        sink.input().send(<span class="keyword">new</span> <span class="title class_">GenericMessage</span>&lt;&gt;(<span class="keyword">new</span> <span class="title class_">Envelope</span>(message)));</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    Card <span class="title function_">createCardDbRepresentation</span><span class="params">(String cardUUid, BigDecimal val)</span> &#123;</span><br><span class="line">        <span class="type">Card</span> <span class="variable">before</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">Card</span>();</span><br><span class="line">        before.setId(cardUUid);</span><br><span class="line">        before.setUsed_limit(<span class="keyword">new</span> <span class="title class_">String</span>(Base64.getEncoder().encode(val.multiply(<span class="keyword">new</span> <span class="title class_">BigDecimal</span>(<span class="number">100</span>)).unscaledValue().toByteArray())));</span><br><span class="line">        <span class="keyword">return</span> before;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">void</span> <span class="title function_">thereIsOneWithdrawalOf</span><span class="params">(BigDecimal amount, String cardId)</span> &#123;</span><br><span class="line">        Map&lt;String, Object&gt; params = <span class="keyword">new</span> <span class="title class_">HashMap</span>&lt;&gt;();</span><br><span class="line">        params.put(<span class="string">&quot;uuid&quot;</span>, cardId);</span><br><span class="line">        List&lt;Withdrawal&gt; withdrawals =</span><br><span class="line">                restTemplate.exchange(</span><br><span class="line">                        <span class="string">&quot;/withdrawals?cardId=&#123;uuid&#125;&quot;</span>,</span><br><span class="line">                        GET, <span class="literal">null</span>,</span><br><span class="line">                        <span class="keyword">new</span> <span class="title class_">ParameterizedTypeReference</span>&lt;List&lt;Withdrawal&gt;&gt;() &#123;&#125;,</span><br><span class="line">                        params)</span><br><span class="line">                        .getBody();</span><br><span class="line">        assertThat(withdrawals).hasSize(<span class="number">1</span>);</span><br><span class="line">        assertThat(withdrawals.get(<span class="number">0</span>).getAmount()).isEqualByComparingTo(amount);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>실제로 트랜잭션 로그 테일링 및 트리거에 더 큰 문제가 있습니다.<br>신용 카드 시스템에 지불 거절이라는 새로운 기능을 추가해 봅시다.<br>구현은 간단합니다. 지불 거절이있을 때마다 사용한도를 낮춥니 다.</p>
<p>지불 거절이있을 때 우리의 읽기 모델은 어떻게 될지 추측하십니까?<br>당신은 그것을 추측 : 트리거가 실행됩니다.<br>그리고 네, 메시지가 트랜잭션 로그에 나타납니다.<br>결과는 마이너스 금액으로 인출됩니다.<br>인출에 대해 양의 금액 만 허용하는 if 문으로 이를 해결할 수 있습니다. 그러나 이것은 단기적인 해결책입니다.<br>실제 문제는 다른 곳입니다. 소프트웨어 개발에서 가장 일반적인 오해 중 하나와 관련이 있습니다.<br>우리의 솔루션은 “비즈니스 의도 기억 상실”로 고통 받고 있습니다.</p>
<p>이 솔루션은 동작 대신 데이터에 중점을 둡니다.<br>상태 변경 (즉, 사용 한도 변경)으로 이어지는 많은 비즈니스 사례 (철회, 지불 거절)가있을 수 있습니다.<br>우리가 국가에 의존 할 때,이 변화의 배후에 진정한 사업상의 이유를 찾는 것이 불가능할 수도 있습니다.<br>데이터베이스 트리거 또는 트랜잭션 로그 테일링을 사용하면 해당 지식을 훔칩니다.</p>
<h3 id="도메인-이벤트-소개"><a href="#도메인-이벤트-소개" class="headerlink" title="도메인 이벤트 소개"></a>도메인 이벤트 소개</h3><p>이제 트랜잭션 로그처럼 보이지만 비즈니스 의도가있는 것이 필요합니다.<br>이상적으로는 비즈니스 컨텍스트를 포함하는 변경 불가능한 변경 사항의 추가 전용 로그와 같은 것이 있습니다.<br>다시 말해, 도메인 이벤트 스트림이 필요합니다. 데이터베이스 관리 시스템이 트랜잭션 로그를 자동으로 채웠습니다.<br>그러나 이벤트는 응용 프로그램 코드에서 게시됩니다.<br>우리는이 상황을 약간의 주의를 기울여 해결합니다.<br>명령이 성공한 경우에만 이벤트를 공개 해야합니다. (자세한 내용은 이 기사를 읽으십시오.)</p>
<p>참고 : 도메인 이벤트는 신용 카드에 발생한 모든 변경 사항을 나타냅니다.<br>이런 식으로 어떤 종류의 스토리지에서 도메인 이벤트를 호스팅하여 신용 카드의 상태를 재현 할 수 있습니다.<br>따라서 일련의 이벤트 만 게시하면 명령이 완료됩니다.<br>신용 카드 상태를 유지할 필요가 없으며 안정적인 이벤트 게시에 문제가 없습니다.<br>이 기술을 이벤트 소싱이라고합니다. Spring Boot에서 이벤트 소싱 및 CQRS를 보다 쉽게 사용할 수 있는 Axon 프레임 워크</p>
<p>이 설정에서는 다음을 사용합니다.</p>
<ul>
<li>신용 카드 데이터를 저장하는 MySQL;</li>
<li>도메인 이벤트를위한 pub &#x2F; sub를위한 Apache Kafka;</li>
<li>Kafka의 주제를 게시하고 청취하기위한 Spring Cloud Stream;</li>
<li>출금을위한 별도의 저장소 인 MongoDB. MongoDB에 연결하기 위해 Spring Data Reactive MongoDB의 반응 드라이버를 사용합니다 .<br>MongoDB (특히 반응성 드라이버와 함께)를 사용하는 것은 선택 사항입니다.<br>요점은 이 예제에서 쿼리 측에 가장 적합한 것을 자유롭게 사용할 수 있다는 것입니다.<br>우리는 현명하게 선택할 수 있습니다!</li>
</ul>
<p>솔루션이 배포됩니다. 우리는 명령 과 쿼리를 위한 별도의 Spring Boot 애플리케이션과 스토리지를 가지고 있습니다 .<br>명령보다 더 많은 쿼리가있는 경우 어떻게합니까? 쿼리 측면은 MySQL과 독립적으로 수평 적으로 확장 될 수 있습니다.<br>또한 읽기 측에서 다른 데이터베이스를 선택하면 이점이 있습니다. 우리는 쿼리를 위해 더 성능이 좋은 모델을 선택할 수 있습니다.</p>
<p>이 솔루션은 3 가지 측면에서 트랜잭션 로그 테일링과 다릅니다.</p>
<ol>
<li><p>출금을위한 별도의 보관소가 있습니다.<br>트랜잭션 로그에는 상태 변경이 포함되며 도메인 이벤트는 비즈니스 동작에 중점을 둡니다.</p>
</li>
<li><p>트랜잭션 로그는 데이터베이스 관리 시스템에 의해 채워집니다. 도메인 이벤트는 응용 프로그램 코드로 게시해야합니다.</p>
</li>
<li><p>내부 상태를 변경 한 후 이벤트를 원자 적으로 푸시하는 방법을 기억해야합니다.<br>아이디어 중 하나는 내부적으로 동일한 데이터베이스에 이벤트를 저장하고 예약 된 게시자가 이벤트를 보내는 것입니다.</p>
</li>
</ol>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> io.dddbyexamples.cqrs.persistence;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> com.fasterxml.jackson.core.JsonProcessingException;</span><br><span class="line"><span class="keyword">import</span> com.fasterxml.jackson.databind.ObjectMapper;</span><br><span class="line"><span class="keyword">import</span> io.dddbyexamples.cqrs.model.DomainEvent;</span><br><span class="line"><span class="keyword">import</span> io.dddbyexamples.cqrs.model.DomainEventPublisher;</span><br><span class="line"><span class="keyword">import</span> org.springframework.cloud.stream.messaging.Source;</span><br><span class="line"><span class="keyword">import</span> org.springframework.messaging.support.GenericMessage;</span><br><span class="line"><span class="keyword">import</span> org.springframework.scheduling.annotation.Scheduled;</span><br><span class="line"><span class="keyword">import</span> org.springframework.stereotype.Component;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> javax.transaction.Transactional;</span><br><span class="line"><span class="keyword">import</span> java.util.HashMap;</span><br><span class="line"><span class="keyword">import</span> java.util.Map;</span><br><span class="line"></span><br><span class="line"><span class="meta">@Component</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">KafkaDomainEventPublisher</span> <span class="keyword">implements</span> <span class="title class_">DomainEventPublisher</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> Source source;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> DomainEventsStorage domainEventStorage;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> ObjectMapper objectMapper;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="title function_">KafkaDomainEventPublisher</span><span class="params">(Source source, DomainEventsStorage domainEventStorage, ObjectMapper objectMapper)</span> &#123;</span><br><span class="line">        <span class="built_in">this</span>.source = source;</span><br><span class="line">        <span class="built_in">this</span>.domainEventStorage = domainEventStorage;</span><br><span class="line">        <span class="built_in">this</span>.objectMapper = objectMapper;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">publish</span><span class="params">(DomainEvent domainEvent)</span> &#123;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            domainEventStorage.save(<span class="keyword">new</span> <span class="title class_">StoredDomainEvent</span>(objectMapper.writeValueAsString(domainEvent), domainEvent.getType()));</span><br><span class="line">        &#125; <span class="keyword">catch</span> (JsonProcessingException e) &#123;</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">RuntimeException</span>(e);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="meta">@Scheduled(fixedRate = 2000)</span></span><br><span class="line">    <span class="meta">@Transactional</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">publishExternally</span><span class="params">()</span> &#123;</span><br><span class="line">        domainEventStorage</span><br><span class="line">                .findAllBySentOrderByEventTimestampDesc(<span class="literal">false</span>)</span><br><span class="line">                .forEach(event -&gt; &#123;</span><br><span class="line">                            Map&lt;String, Object&gt; headers = <span class="keyword">new</span> <span class="title class_">HashMap</span>&lt;&gt;();</span><br><span class="line">                            headers.put(<span class="string">&quot;type&quot;</span>, event.getEventType());</span><br><span class="line">                            source.output().send(<span class="keyword">new</span> <span class="title class_">GenericMessage</span>&lt;&gt;(event.getContent(), headers));</span><br><span class="line">                            event.sent();</span><br><span class="line">                        &#125;</span><br><span class="line"></span><br><span class="line">                );</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>ReadModelUpdater 는 이제 새 Withdrawals을 작성합니다. Kafka의 주제를 구독하고 도메인 이벤트를 찾습니다.</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line"><span class="keyword">package</span> io.dddbyexamples.cqrs.sink;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> io.dddbyexamples.cqrs.persistence.WithdrawalsRepository;</span><br><span class="line"><span class="keyword">import</span> io.dddbyexamples.cqrs.ui.WithdrawalDto;</span><br><span class="line"><span class="keyword">import</span> org.springframework.cloud.stream.annotation.StreamListener;</span><br><span class="line"><span class="keyword">import</span> org.springframework.cloud.stream.messaging.Sink;</span><br><span class="line"><span class="keyword">import</span> org.springframework.stereotype.Service;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> java.util.UUID;</span><br><span class="line"></span><br><span class="line"><span class="meta">@Service</span></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">ReadModelUpdater</span> &#123;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">private</span> <span class="keyword">final</span> WithdrawalsRepository withdrawalsRepository;</span><br><span class="line"></span><br><span class="line">	ReadModelUpdater(WithdrawalsRepository withdrawalsRepository) &#123;</span><br><span class="line">		<span class="built_in">this</span>.withdrawalsRepository = withdrawalsRepository;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="meta">@StreamListener(target = Sink.INPUT, condition = &quot;headers[&#x27;type&#x27;] == &#x27;card-withdrawn&#x27;&quot;)</span></span><br><span class="line">	<span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">handle</span><span class="params">(CardWithdrawn cardWithdrawn)</span> &#123;</span><br><span class="line">        withdrawalsRepository</span><br><span class="line">				.save(<span class="keyword">new</span> <span class="title class_">WithdrawalDto</span>(UUID.randomUUID().toString(), cardWithdrawn.getCardNo().toString(), cardWithdrawn.getAmount())).subscribe();</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>논의 된 모든 접근 방식에는 장단점이 있습니다.<br>중요한 것은 사용 사례에 적합한 옵션을 선택하는 것입니다.<br>당신에게 내 조언은 하나의 옵션을 선택한 다음 다음 요소를 고려하는 것입니다.</p>
<p>구현 : 제안 된 솔루션을 얼마나 쉽게 구현할 수 있습니까?</p>
<p>테스트 가능성 : 솔루션을 테스트하는 것이 얼마나 쉬운가요?</p>
<p>복잡성 : 솔루션을 구축하는 데 몇 개의 기술이 필요합니까?</p>
<p>일관성 : 명령이 성공한 후 쿼리 측이 즉시 일관성이 있습니까? 아니면 일관성이 있습니까?</p>
<p>이식성 : 솔루션을 다른 공급 업체로 쉽게 포팅 할 수 있습니까? 예를 들어, 일부 솔루션은 특정 데이터베이스에 의존 할 수 있습니다. 벤더 잠금이 생성됩니다.</p>
<p>확장성 : 한쪽과 다른 쪽을 독립적으로 가로로 쉽게 확장 할 수 있습니까?</p>
<p>배포 : 솔루션이 배포 되었습니까? 유스 케이스는 다른 프로세스에서 처리됩니까?</p>
<p>확장성 : 새 모델을 쉽게 추가 할 수 있습니까?</p>
<h1 id="참조"><a href="#참조" class="headerlink" title="참조"></a>참조</h1><hr>
<ul>
<li><a target="_blank" rel="external nofollow noopener noreferrer" href="https://thenewstack.io/how-cqrs-works-with-spring-tools/">how-cqrs-works-with-spring-tools</a></li>
<li><a target="_blank" rel="external nofollow noopener noreferrer" href="https://github.com/ddd-by-examples/all-things-cqrs/">all-things-cqrs</a></li>
<li><a target="_blank" rel="external nofollow noopener noreferrer" href="https://docs.spring.io/spring-data/jpa/docs/current/reference/html/#core.domain-events">spring domain-events</a></li>
<li><a target="_blank" rel="external nofollow noopener noreferrer" href="https://axoniq.io/">axoniq</a></li>
</ul>
</div></article><div class="post-meta__tag-list"><a class="post-meta__tags" href="../../../tags/spring/">spring</a><a class="post-meta__tags" href="../../../tags/cqrs/">cqrs</a></div><nav id="pagination"><div class="prev-post pull-left"><a href="../2020-04-29-rabbitMQ_ACCESS_REFUSED/"><i class="fa fa-chevron-left">  </i><span>rabbitmq 커넥션 에러</span></a></div><div class="next-post pull-right"><a href="../2020-04-27-accountancy/"><span>회계야학 4기</span><i class="fa fa-chevron-right"></i></a></div></nav><div id="disqus_thread"></div><script>var unused = null;
var disqus_config = function () {
  this.page.url = 'https://sejoung.github.io/2020/04/2020-04-28-Spring_and_Data_Synchronization_Between_Queries_and_Commands/';
  this.page.identifier = '2020/04/2020-04-28-Spring_and_Data_Synchronization_Between_Queries_and_Commands/';
  this.page.title = '스프링을 활용한 쿼리와 명령간에 데이터 동기화';
}
var d = document, s = d.createElement('script');
s.src = "https://" + 'kimsejoung' +".disqus.com/embed.js";
s.setAttribute('data-timestamp', '' + +new Date());
(d.head || d.body).appendChild(s);</script><script id="dsq-count-scr" src="https://kimsejoung.disqus.com/count.js" async></script></div></div><footer class="footer-bg" style="background-image: url(https://upload.wikimedia.org/wikipedia/commons/thumb/0/09/Van_Gogh_-_Terrasse_des_Caf%C3%A9s_an_der_Place_du_Forum_in_Arles_am_Abend1.jpeg/1024px-Van_Gogh_-_Terrasse_des_Caf%C3%A9s_an_der_Place_du_Forum_in_Arles_am_Abend1.jpeg)"><div class="layout" id="footer"><div class="copyright">&copy;2017 - 2024 By sejoung</div><div class="framework-info"><span>Driven - </span><a target="_blank" rel="external nofollow noopener noreferrer" href="http://hexo.io"><span>Hexo</span></a><span class="footer-separator">|</span><span>Theme - </span><a target="_blank" rel="external nofollow noopener noreferrer" href="https://github.com/Molunerfinn/hexo-theme-melody"><span>Melody</span></a></div><div class="busuanzi"><script async src="//busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js"></script><span id="busuanzi_container_page_pv"><i class="fa fa-file-o"></i><span id="busuanzi_value_page_pv"></span><span></span></span></div></div></footer><i class="fa fa-arrow-up" id="go-up" aria-hidden="true"></i><script src="../../../js/third-party/anime.min.js"></script><script src="../../../js/third-party/jquery.min.js"></script><script src="../../../js/third-party/jquery.fancybox.min.js"></script><script src="../../../js/third-party/velocity.min.js"></script><script src="../../../js/third-party/velocity.ui.min.js"></script><script src="../../../js/utils.js?version=1.7.0"></script><script src="../../../js/fancybox.js?version=1.7.0"></script><script src="../../../js/sidebar.js?version=1.7.0"></script><script src="../../../js/copy.js?version=1.7.0"></script><script src="../../../js/fireworks.js?version=1.7.0"></script><script src="../../../js/transition.js?version=1.7.0"></script><script src="../../../js/scroll.js?version=1.7.0"></script><script src="../../../js/head.js?version=1.7.0"></script><script src="../../../js/search/local-search.js"></script><script>if(/Android|webOS|iPhone|iPod|iPad|BlackBerry/i.test(navigator.userAgent)) {
  $('#nav').addClass('is-mobile')
  $('footer').addClass('is-mobile')
  $('#top-container').addClass('is-mobile')
}</script><div class="search-dialog" id="local-search"><div class="search-dialog__title" id="local-search-title">Local search</div><div id="local-input-panel"><div id="local-search-input"><div class="local-search-box"><input class="local-search-box--input" placeholder="Search for Posts"></div></div></div><hr><div id="local-search-results"><div id="local-hits"></div><div id="local-stats"><div class="local-search-stats__hr" id="hr"><span>Powered by</span> <a target="_blank" rel="external nofollow noopener noreferrer" href="https://github.com/wzpan/hexo-generator-search" style="color:#49B1F5;">hexo-generator-search</a></div></div></div><span class="search-close-button"><i class="fa fa-times"></i></span></div><div class="search-mask"></div></body></html>